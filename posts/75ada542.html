<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>HEngine游戏引擎-61-90 | DongHuiWang</title><meta name="keywords" content="游戏引擎"><meta name="author" content="DongHuiWang"><meta name="copyright" content="DongHuiWang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="记录HEngine每一次提交的重点内容以及遇到的问题和解决的步骤">
<meta property="og:type" content="article">
<meta property="og:title" content="HEngine游戏引擎-61-90">
<meta property="og:url" content="https://donghuiw.github.io/posts/75ada542">
<meta property="og:site_name" content="DongHuiWang">
<meta property="og:description" content="记录HEngine每一次提交的重点内容以及遇到的问题和解决的步骤">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/winterdev/images/raw/master/blog_cover3.webp">
<meta property="article:published_time" content="2025-03-17T12:43:17.000Z">
<meta property="article:modified_time" content="2025-07-23T03:23:54.258Z">
<meta property="article:author" content="DongHuiWang">
<meta property="article:tag" content="游戏引擎">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/winterdev/images/raw/master/blog_cover3.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://donghuiw.github.io/posts/75ada542"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HEngine游戏引擎-61-90',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-23 11:23:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 8 || hour >= 22
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="DongHuiWang" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/toxiang.webp" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche"></use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan"></use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie"></use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">DongHuiWang</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1"></use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei"></use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche"></use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan"></use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie"></use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane"></use></svg><span class="menu_word" style="font-size:17px"> 关于</span></a></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">HEngine游戏引擎-61-90</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2025-03-17T12:43:17.000Z" title="发表于 2025-03-17 20:43:17">2025-03-17</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-23T03:23:54.258Z" title="更新于 2025-07-23 11:23:54">2025-07-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/">游戏引擎</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">1.9w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>91分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="HEngine游戏引擎-61-90"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="六十一、打开-保存文件对话框">六十一、打开/保存文件对话框</h2>
<h4 id="前言">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>可以有询问<strong>对话框</strong>保存、解析场景</p>
<ul>
<li>新场景：不绘制的实体，创建一个空白的场景</li>
<li>保存场景：有对话框，问保存到本地哪个位置</li>
<li>加载场景：有对话框，从本地哪个位置加载场景，重新创建新场景</li>
</ul>
</li>
</ul>
<h4 id="关键代码">关键代码</h4>
<ul>
<li>
<p>EditorLayer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::NewScene</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建新场景 ，这段代码可解决 多次加载场景，会将新场景的实体和当前场景的实体一起呈现的bug</span></span><br><span class="line">    m_ActiveScene = <span class="built_in">CreateRef</span>&lt;Scene&gt;();</span><br><span class="line">    m_ActiveScene-&gt;<span class="built_in">OnViewportResize</span>((<span class="type">uint32_t</span>)m_ViewportSize.x, (<span class="type">uint32_t</span>)m_ViewportSize.y);</span><br><span class="line">    m_SceneHierarchyPanel.<span class="built_in">SetContext</span>(m_ActiveScene);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OpenScene</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string filepath = FileDialogs::<span class="built_in">OpenFile</span>(<span class="string">&quot;HEngine Scene (*.hengine)\0*.hengine\0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!filepath.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_ActiveScene = <span class="built_in">CreateRef</span>&lt;Scene&gt;();</span><br><span class="line">        m_ActiveScene-&gt;<span class="built_in">OnViewportResize</span>((<span class="type">uint32_t</span>)m_ViewportSize.x, (<span class="type">uint32_t</span>)m_ViewportSize.y);</span><br><span class="line">        m_SceneHierarchyPanel.<span class="built_in">SetContext</span>(m_ActiveScene);</span><br><span class="line"></span><br><span class="line">        <span class="function">SceneSerializer <span class="title">serializer</span><span class="params">(m_ActiveScene)</span></span>;</span><br><span class="line">        serializer.<span class="built_in">Deserialize</span>(filepath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::SaveSceneAs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string filepath = FileDialogs::<span class="built_in">SaveFile</span>(<span class="string">&quot;HEngine Scene (*.hengine)\0*.hengine\0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!filepath.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">SceneSerializer <span class="title">serializer</span><span class="params">(m_ActiveScene)</span></span>;</span><br><span class="line">        serializer.<span class="built_in">Serialize</span>(filepath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>新建PlatformUtils.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> HEngine</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">FileDialogs</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="comment">//These return empty strings if cancelled</span></span><br><span class="line">		<span class="function"><span class="type">static</span> std::string <span class="title">OpenFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filter)</span></span>;</span><br><span class="line">		<span class="function"><span class="type">static</span> std::string <span class="title">SaveFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filter)</span></span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowsPlatformUtils.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">FileDialogs::OpenFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OPENFILENAMEA ofn;       <span class="comment">// Windows API 结构体，用于存储对话框的信息</span></span><br><span class="line">    CHAR szFile[<span class="number">260</span>] = &#123; <span class="number">0</span> &#125;; <span class="comment">// 存储选中文件的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;ofn, <span class="built_in">sizeof</span>(OPENFILENAME)); <span class="comment">// 清空结构体数据</span></span><br><span class="line">    ofn.lStructSize = <span class="built_in">sizeof</span>(OPENFILENAME); <span class="comment">// 结构体大小</span></span><br><span class="line">    ofn.hwndOwner = <span class="built_in">glfwGetWin32Window</span>((GLFWwindow*)Application::<span class="built_in">Get</span>().<span class="built_in">GetWindow</span>().<span class="built_in">GetNativeWindow</span>()); <span class="comment">// 获取窗口句柄</span></span><br><span class="line">    ofn.lpstrFile = szFile;   <span class="comment">// 指定缓冲区存储文件路径</span></span><br><span class="line">    ofn.nMaxFile = <span class="built_in">sizeof</span>(szFile); <span class="comment">// 设置最大文件路径长度</span></span><br><span class="line">    ofn.lpstrFilter = filter; <span class="comment">// 设置文件筛选器（如 `&quot;Text Files\0*.txt\0All Files\0*.*\0&quot;`）</span></span><br><span class="line">    ofn.nFilterIndex = <span class="number">1</span>;     <span class="comment">// 默认选择第一个筛选项</span></span><br><span class="line">    ofn.Flags = OFN_PATHMUSTEXIST | OFN_FILEMUSTEXIST | OFN_NOCHANGEDIR; <span class="comment">// 设置对话框标志</span></span><br><span class="line">    <span class="comment">// 打开文件选择对话框</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetOpenFileNameA</span>(&amp;ofn) == TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ofn.lpstrFile; <span class="comment">// 返回选中的文件路径</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;; <span class="comment">// 用户取消时返回空字符串</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">FileDialogs::SaveFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OPENFILENAMEA ofn;</span><br><span class="line">    CHAR szFile[<span class="number">260</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;ofn, <span class="built_in">sizeof</span>(OPENFILENAME));</span><br><span class="line">    ofn.lStructSize = <span class="built_in">sizeof</span>(OPENFILENAME);</span><br><span class="line">    ofn.hwndOwner = <span class="built_in">glfwGetWin32Window</span>((GLFWwindow*)Application::<span class="built_in">Get</span>().<span class="built_in">GetWindow</span>().<span class="built_in">GetNativeWindow</span>());</span><br><span class="line">    ofn.lpstrFile = szFile;</span><br><span class="line">    ofn.nMaxFile = <span class="built_in">sizeof</span>(szFile);</span><br><span class="line">    ofn.lpstrFilter = filter;</span><br><span class="line">    ofn.nFilterIndex = <span class="number">1</span>;</span><br><span class="line">    ofn.Flags = OFN_PATHMUSTEXIST | OFN_FILEMUSTEXIST | OFN_NOCHANGEDIR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开文件保存对话框</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetSaveFileNameA</span>(&amp;ofn) == TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ofn.lpstrFile; <span class="comment">// 返回保存的文件路径</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;; <span class="comment">// 用户取消时返回空字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>EditorLayer.cpp 快捷键功能实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnEvent</span><span class="params">(Event&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">EventDispatcher <span class="title">dispatcher</span><span class="params">(e)</span></span>;</span><br><span class="line">    dispatcher.<span class="built_in">Dispatch</span>&lt;KeyPressedEvent&gt;(<span class="built_in">HE_BIND_EVENT_FN</span>(EditorLayer::OnKeyPressed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EditorLayer::OnKeyPressed</span><span class="params">(KeyPressedEvent&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e.<span class="built_in">GetRepeatCount</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">bool</span> control = Input::<span class="built_in">IsKeyPressed</span>(Key::LeftControl) || Input::<span class="built_in">IsKeyPressed</span>(Key::RightControl);</span><br><span class="line">    <span class="type">bool</span> shift = Input::<span class="built_in">IsKeyPressed</span>(Key::LeftShift) || Input::<span class="built_in">IsKeyPressed</span>(Key::RightShift);</span><br><span class="line">    <span class="keyword">switch</span> (e.<span class="built_in">GetKeyCode</span>()) &#123;</span><br><span class="line">        <span class="keyword">case</span> Key::N: &#123;</span><br><span class="line">            <span class="keyword">if</span> (control) &#123;</span><br><span class="line">                <span class="built_in">NewScene</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Key::O: &#123;</span><br><span class="line">            <span class="keyword">if</span> (control) &#123;</span><br><span class="line">                <span class="built_in">OpenScene</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Key::S: &#123;</span><br><span class="line">            <span class="keyword">if</span> (control &amp;&amp; shift) &#123;</span><br><span class="line">                <span class="built_in">SaveSceneAs</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存当前场景:要有一个记录当前场景的路径。</span></span><br><span class="line">            <span class="keyword">if</span> (control) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="六十二、添加gizmos">六十二、添加gizmos</h2>
<h4 id="前言-2">前言</h4>
<ul>
<li>
<p>目的</p>
<p>为实现像大多3D软件那种，点击物体，会有那种拖动、缩放、旋转的辅助小程序。利用开源的imguizmo库，<a target="_blank" rel="noopener" href="https://github.com/CedricGuillemet/ImGuizmo">网址</a></p>
</li>
<li>
<p>介绍imguizmo</p>
<p>ImGizmo是一个建立在<strong>Dear ImGu</strong>i之上的小型（.h和.cpp）库，允许你操作（目前是旋转和平移）4x4浮点矩阵，没有其他依赖性。编写时考虑到了即时模式（IM）的理念。</p>
</li>
</ul>
<h4 id="关键代码-2">关键代码</h4>
<p>EditorLayer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnImGuiRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Gizmo 操作部分</span></span><br><span class="line">Entity selectedEntity = m_SceneHierarchyPanel.<span class="built_in">GetSelectedEntity</span>(); <span class="comment">// 获取当前选中的实体</span></span><br><span class="line"><span class="keyword">if</span> (selectedEntity &amp;&amp; m_GizmoType != <span class="number">-1</span>) <span class="comment">// 如果实体存在且 Gizmo 类型不为 -1（即 Gizmo 被启用）</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置 ImGuizmo 的投影模式和绘制选项</span></span><br><span class="line">    ImGuizmo::<span class="built_in">SetOrthographic</span>(<span class="literal">false</span>); <span class="comment">// 设置投影为透视投影（false 表示不是正交投影）</span></span><br><span class="line">    ImGuizmo::<span class="built_in">SetDrawlist</span>(); <span class="comment">// 设置 Gizmo 的绘制列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前窗口的宽度和高度，用来设置 Gizmo 操作区域的大小</span></span><br><span class="line">    <span class="type">float</span> windowWidth = ImGui::<span class="built_in">GetWindowWidth</span>();</span><br><span class="line">    <span class="type">float</span> windowHeight = ImGui::<span class="built_in">GetWindowHeight</span>();</span><br><span class="line">    <span class="comment">// 设置 Gizmo 的矩形区域</span></span><br><span class="line">    ImGuizmo::<span class="built_in">SetRect</span>(ImGui::<span class="built_in">GetWindowPos</span>().x, ImGui::<span class="built_in">GetWindowPos</span>().y, windowWidth, windowHeight);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取主摄像机实体</span></span><br><span class="line">    <span class="keyword">auto</span> cameraEntity = m_ActiveScene-&gt;<span class="built_in">GetPrimaryCameraEntity</span>(); </span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; camera = cameraEntity.<span class="built_in">GetComponent</span>&lt;CameraComponent&gt;().Camera; <span class="comment">// 获取摄像机组件</span></span><br><span class="line">    <span class="type">const</span> glm::mat4&amp; cameraProjection = camera.<span class="built_in">GetProjection</span>(); <span class="comment">// 获取摄像机的投影矩阵</span></span><br><span class="line">    glm::mat4 cameraView = glm::<span class="built_in">inverse</span>(cameraEntity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;().<span class="built_in">GetTransform</span>()); <span class="comment">// 获取摄像机的视图矩阵，通常为相机的变换矩阵的逆矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取选中实体的变换信息</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = selectedEntity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;(); <span class="comment">// 获取选中实体的 Transform 组件</span></span><br><span class="line">    glm::mat4 transform = tc.<span class="built_in">GetTransform</span>(); <span class="comment">// 获取选中实体的当前变换矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Snapping 设置</span></span><br><span class="line">    <span class="type">bool</span> snap = Input::<span class="built_in">IsKeyPressed</span>(Key::LeftControl); <span class="comment">// 如果按下了控制键，则启用 snap（对齐）</span></span><br><span class="line">    <span class="type">float</span> snapValue = <span class="number">0.5f</span>; <span class="comment">// 默认情况下，平移和缩放对齐的步长是 0.5m</span></span><br><span class="line">    <span class="comment">// 如果当前操作是旋转，则将对齐步长设置为 45 度</span></span><br><span class="line">    <span class="keyword">if</span> (m_GizmoType == ImGuizmo::OPERATION::ROTATE)</span><br><span class="line">        snapValue = <span class="number">45.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义每个轴的对齐值（此处所有轴的对齐步长相同）</span></span><br><span class="line">    <span class="type">float</span> snapValues[<span class="number">3</span>] = &#123; snapValue, snapValue, snapValue &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 ImGuizmo 进行变换操作，传入视图矩阵、投影矩阵、操作类型（平移、旋转或缩放）、变换类型（局部/全局）和变换矩阵</span></span><br><span class="line">    <span class="comment">// 如果启用了 snap 对齐，则传入对齐步长</span></span><br><span class="line">    ImGuizmo::<span class="built_in">Manipulate</span>(glm::<span class="built_in">value_ptr</span>(cameraView), glm::<span class="built_in">value_ptr</span>(cameraProjection),</span><br><span class="line">        (ImGuizmo::OPERATION)m_GizmoType, ImGuizmo::LOCAL, glm::<span class="built_in">value_ptr</span>(transform),</span><br><span class="line">        <span class="literal">nullptr</span>, snap ? snapValues : <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果正在使用 Gizmo（即操作发生了变化）</span></span><br><span class="line">    <span class="keyword">if</span> (ImGuizmo::<span class="built_in">IsUsing</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将变换矩阵分解为平移、旋转和缩放分量</span></span><br><span class="line">        glm::vec3 translation, rotation, scale;</span><br><span class="line">        Math::<span class="built_in">DecomposeTransform</span>(transform, translation, rotation, scale);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算旋转的增量（用于处理局部变换）</span></span><br><span class="line">        glm::vec3 deltaRotation = rotation - tc.Rotation;</span><br><span class="line">        <span class="comment">// 更新实体的变换信息（平移、旋转、缩放）</span></span><br><span class="line">        tc.Translation = translation;</span><br><span class="line">        tc.Rotation += deltaRotation; <span class="comment">// 增加旋转增量</span></span><br><span class="line">        tc.Scale = scale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EditorLayer::OnKeyPressed</span><span class="params">(KeyPressedEvent&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Gizmos</span></span><br><span class="line">    <span class="keyword">case</span> Key::Q:</span><br><span class="line">        m_GizmoType = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Key::W:</span><br><span class="line">        m_GizmoType = ImGuizmo::OPERATION::TRANSLATE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Key::E:</span><br><span class="line">        m_GizmoType = ImGuizmo::OPERATION::ROTATE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Key::R:</span><br><span class="line">        m_GizmoType = ImGuizmo::OPERATION::SCALE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="六十三、编辑时的摄像机">六十三、编辑时的摄像机</h2>
<h4 id="前言-3">前言</h4>
<ul>
<li>
<p>目的</p>
<p>实现像Unity<strong>编辑时</strong>有一个编辑摄像机呈现画面给开发人员，<strong>运行时</strong>有一个主摄像机呈现游戏画面给玩家。</p>
</li>
<li>
<p>实现细节</p>
<ol>
<li>编辑时摄像机是<strong>透视投影</strong>摄像机</li>
<li>编辑时摄像机缩小<strong>不会透过</strong>实体，这样更简单实现</li>
<li>编辑时摄像机越<strong>接近</strong>实体，它的放大范围越<strong>小</strong></li>
<li>不同FPS第一人称摄像机，这个编辑式摄像机是围绕一个点旋转平移的摄像机</li>
</ol>
</li>
</ul>
<h4 id="编辑时摄像机大致运行流程">编辑时摄像机大致运行流程</h4>
<ul>
<li>
<p>设置好编辑时摄像机参数：宽高比、视角角度、近、远</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_EditorCamera = <span class="built_in">EditorCamera</span>(<span class="number">30.0f</span>, <span class="number">1.778f</span>, <span class="number">0.1f</span>, <span class="number">1000.0f</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在EditorLayer中的OnUpdate与OnEvent</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">m_EditorCamera.<span class="built_in">OnUpdate</span>(ts);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnEvent</span><span class="params">(Event&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_EditorCamera.<span class="built_in">OnEvent</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在Scene中的OnUpdate</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">m_ActiveScene-&gt;<span class="built_in">OnUpdateEditor</span>(ts, m_EditorCamera);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::OnUpdateEditor</span><span class="params">(Timestep ts, EditorCamera&amp; camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Renderer2D::<span class="built_in">BeginScene</span>(camera);</span><br><span class="line">    <span class="keyword">auto</span> group = m_Registry.<span class="built_in">group</span>&lt;TransformComponent&gt;(entt::get&lt;SpriteRendererComponent&gt;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> entity : group) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> [transform, sprite] = group.<span class="built_in">get</span>&lt;TransformComponent, SpriteRendererComponent&gt;(entity);</span><br><span class="line">        Renderer2D::<span class="built_in">DrawQuad</span>(transform.<span class="built_in">GetTransform</span>(), sprite.Color);</span><br><span class="line">    &#125;</span><br><span class="line">    Renderer2D::<span class="built_in">EndScene</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::BeginScene</span><span class="params">(<span class="type">const</span> EditorCamera&amp; camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HE_PROFILE_FUNCTION</span>();</span><br><span class="line"></span><br><span class="line">    glm::mat4 viewProj = camera.<span class="built_in">GetViewProjection</span>();</span><br><span class="line"></span><br><span class="line">    s_Data.TextureShader-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">    s_Data.TextureShader-&gt;<span class="built_in">SetMat4</span>(<span class="string">&quot;u_ViewProjection&quot;</span>, viewProj);</span><br><span class="line">    <span class="built_in">StartBatch</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>EditorLayer.cpp 将gizmos关联<strong>编辑时</strong>的摄像机投影与视图矩阵，而不是<strong>运行时</strong>的摄像机</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Camera - editor 编辑时的摄像机矩阵</span></span><br><span class="line"><span class="type">const</span> glm::mat4&amp; cameraProjection = m_EditorCamera.<span class="built_in">GetProjection</span>();</span><br><span class="line">glm::mat4 cameraView = m_EditorCamera.<span class="built_in">GetViewMatrix</span>();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="编辑时摄像机-移动与缩放-实现">编辑时摄像机 移动与缩放 实现</h4>
<p>为什么不讲旋转，不太会，而且此节大都是我自己推的，大概率有误，仅提供参考，忽全信</p>
<ul>
<li>
<p>编辑时摄像机参数略讲</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">glm::vec3 m_Position = &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">10.0f</span> &#125;;	<span class="comment">// 摄像机的位置</span></span><br><span class="line">glm::vec3 m_FocalPoint = &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;; <span class="comment">// 焦点的位置为原点</span></span><br><span class="line"></span><br><span class="line">glm::vec2 m_InitialMousePosition = &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;;<span class="comment">// 记录当前鼠标位置，为了计算移动鼠标后焦点的位置</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> m_Distance = <span class="number">10.0f</span>;<span class="comment">// 控制摄像机的z位置，为实现缩放效果</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>当鼠标按着<strong>中键</strong>移动。目的是为了移动焦点m_FocalPoint</p>
<ol>
<li>用移动后的鼠标坐标<strong>减去</strong>当前的鼠标坐标，得到偏移量是向量且有正负（可以实现斜着移动）</li>
<li>获取<strong>方向向量</strong>与<strong>偏移量</strong>相乘得到焦点的最终要平移的<strong>数值</strong>delta</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorCamera::OnUpdate</span><span class="params">(Timestep ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input::<span class="built_in">IsKeyPressed</span>(Key::LeftAlt))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> glm::vec2&amp; mouse&#123; Input::<span class="built_in">GetMouseX</span>(), Input::<span class="built_in">GetMouseY</span>() &#125;;</span><br><span class="line">        glm::vec2 delta = (mouse - m_InitialMousePosition) * <span class="number">0.003f</span>;</span><br><span class="line">        m_InitialMousePosition = mouse;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Input::<span class="built_in">IsMouseButtonPressed</span>(Mouse::ButtonMiddle))</span><br><span class="line">            <span class="built_in">MousePan</span>(delta);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Input::<span class="built_in">IsMouseButtonPressed</span>(Mouse::ButtonLeft))</span><br><span class="line">            <span class="built_in">MouseRotate</span>(delta);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Input::<span class="built_in">IsMouseButtonPressed</span>(Mouse::ButtonRight))</span><br><span class="line">            <span class="built_in">MouseZoom</span>(delta.y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UpdateView</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 移动焦点，从原点000移动到xy0点</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorCamera::MousePan</span><span class="params">(<span class="type">const</span> glm::vec2&amp; delta)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> [xSpeed, ySpeed] = <span class="built_in">PanSpeed</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加上负号是因为，焦点往右方向物体要左移</span></span><br><span class="line">	m_FocalPoint += -<span class="built_in">GetRightDirection</span>() * delta.x * xSpeed * m_Distance;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 不加负号是因为，焦点往上方向(0,1,0)移动到(0,1,0)，使得物体下移效果</span></span><br><span class="line">	m_FocalPoint += <span class="built_in">GetUpDirection</span>() * delta.y * ySpeed * m_Distance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得旋转矩阵沿着y轴的向量。</span></span><br><span class="line"><span class="comment">// 返回vec3(0, 1, 0);或者 vec3(0, -1, 0)得到是往上还是往下的向量</span></span><br><span class="line"><span class="function">glm::vec3 <span class="title">EditorCamera::GetUpDirection</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> glm::<span class="built_in">rotate</span>(<span class="built_in">GetOrientation</span>(), glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获得旋转矩阵沿着x轴的向量。</span></span><br><span class="line"><span class="comment">// 返回vec3(1, 0, 0)(右);或者 vec3(-1, 0, 0)(左)得到是往右还是往左的向量</span></span><br><span class="line"><span class="function">glm::vec3 <span class="title">EditorCamera::GetRightDirection</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> glm::<span class="built_in">rotate</span>(<span class="built_in">GetOrientation</span>(), glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="六十四、重构帧缓冲类">六十四、重构帧缓冲类</h2>
<h4 id="前言-4">前言</h4>
<ul>
<li>
<p>要实现什么</p>
<p>完善Gizmos，点击场景的物体，即会显示gizmos，而<strong>不用点击</strong>hierarchy的实体才会显示。</p>
</li>
<li>
<p>实现思路</p>
<p>光栅化输出到界面有<strong>每一个像素对应的实体ID</strong>（这节要实现的）</p>
</li>
<li>
<p>此节要完成</p>
<p>由下面的思路三得出：</p>
<ol>
<li>修改和优化<strong>帧缓冲</strong>类，<strong>能附加多个不同类别缓冲区</strong>。</li>
<li>使得帧缓冲区可以附加<strong>两个</strong>颜色纹理，实现一个渲染通道有两个渲染目标，并且imgui可以显示出<strong>第二个</strong>渲染目标</li>
</ol>
</li>
</ul>
<h4 id="如何将实体ID值附加到像素上">如何将实体ID值附加到像素上</h4>
<p><strong>思路一</strong></p>
<ul>
<li>
<p>方法</p>
<p>使用<strong>Uniform</strong></p>
</li>
<li>
<p>问题</p>
<p>当前场景使用批处理，虽然场景显示了3个实体，但实际上调用<strong>一次drawcall</strong>属于一个对象，无法用Uniform确定当前一个整体的分块。</p>
<p>除非每一个实体调用一个drawcall，这样不使用批处理效率会降低，不行。</p>
</li>
</ul>
<p><strong>思路二</strong></p>
<ul>
<li>
<p>方法</p>
<p>将实体ID附加到<strong>顶点</strong>缓冲区中。</p>
</li>
<li>
<p>实现Demo</p>
<p>在顶点缓冲布局中添加实体ID，这样<strong>每个顶点都有一个自己的EntityID值，再将这个ID值作为像素的颜色值，这样就可以成功在当前实体里的每个像素都有这个ID值</strong>，即在代码位置为:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">QuadVertex</span> &#123;</span><br><span class="line">    glm::vec3 Position;</span><br><span class="line">	.....</span><br><span class="line">    <span class="comment">// Editor-only;</span></span><br><span class="line">    <span class="type">int</span> EntityID;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 2.1设置顶点缓冲区布局</span></span><br><span class="line">s_Data.QuadVertexBuffer-&gt;<span class="built_in">SetLayout</span>(&#123;</span><br><span class="line">    &#123;HEngine::ShaderDataType::Float3, <span class="string">&quot;a_Position&quot;</span>&#125;,</span><br><span class="line">	.....</span><br><span class="line">    &#123;HEngine::ShaderDataType::<span class="type">int</span>, <span class="string">&quot;a_EntityID&quot;</span>&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawQuad</span><span class="params">(<span class="type">const</span> glm::mat4&amp; transform, <span class="type">const</span> glm::vec4&amp; color, <span class="type">const</span> <span class="type">int</span> entityId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s_Data.QuadIndexCount &gt;= Renderer2DData::MaxIndices) &#123;</span><br><span class="line">        <span class="built_in">NextBatch</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">size_t</span> quadVertexCount = <span class="number">4</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// quad的左下角为起点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; quadVertexCount; i++) &#123;</span><br><span class="line">        s_Data.QuadVertexBufferPtr-&gt;Position = transform * s_Data.QuadVertexPosition[i];</span><br><span class="line">		......</span><br><span class="line">        </span><br><span class="line">        s_Data.QuadVertexBufferPtr-&gt;EntityId = entityId;<span class="comment">// 在这写</span></span><br><span class="line">        s_Data.QuadVertexBufferPtr++;</span><br><span class="line">    &#125;</span><br><span class="line">    s_Data.QuadIndexCount += <span class="number">6</span>;<span class="comment">// 每一个quad用6个索引</span></span><br><span class="line">    s_Data.Stats.QuadCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>问题</p>
<p>由于使用了动态顶点缓冲区，即又要重写RendererAPI，可是本身RendererAPI就有很多代码，若再重写，将会<strong>混乱</strong></p>
<p>例如：</p>
<p>当前项目的结构是，一个渲染通道（drawcall）对应一个渲染目标（帧缓冲的缓冲附件），这个渲染目标（帧缓冲的缓冲附件）已经<strong>输出</strong>了颜色（这个缓冲区只有颜色值），那实体ID值应该渲染到哪个渲染目标上（帧缓冲的缓冲附件）上呢？</p>
</li>
</ul>
<h4 id="解决思路二的问题">解决思路二的问题</h4>
<ul>
<li>
<p>方法</p>
<p>当前项目的渲染目标是<strong>帧缓冲，帧缓冲可以附加多个缓冲区，所以只需要将实体ID缓冲区随已经存在的颜色缓冲区之后附加到帧缓冲即可</strong></p>
</li>
</ul>
<h4 id="帧缓冲类修改">帧缓冲类修改</h4>
<ul>
<li>
<p>创建纹理</p>
<p>原先是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glCreateTextures</span>(GL_TEXTURE_2D, <span class="number">1</span>, &amp;m_ColorAttachment);;</span><br></pre></td></tr></table></figure>
<p>修改后是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.1创建纹理。m_ColorAttachments.data()是地址，可以创建多个缓冲区</span></span><br><span class="line">Utils::<span class="built_in">CreateTextures</span>(multisample, m_ColorAttachments.<span class="built_in">data</span>(), m_ColorAttachments.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CreateTextures</span><span class="params">(<span class="type">bool</span> multisampled, <span class="type">uint32_t</span>* outID, <span class="type">uint32_t</span> count)</span> </span>&#123;<span class="comment">// outID 是vector的起始位置</span></span><br><span class="line">    <span class="built_in">glCreateTextures</span>(<span class="built_in">TextureTarget</span>(multisampled), count, outID);;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若m_ColorAttachments.size()是2，且m_ColorAttachments[0] = 3, 那么m_ColorAttachments[1] = 4，3和4是<strong>缓冲区ID</strong></p>
</li>
<li>
<p>颜色纹理附加到帧缓冲</p>
<p>原先是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.1颜色纹理缓冲区附加到帧缓冲</span></span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, m_ColorAttachment, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>修改后是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 颜色纹理缓冲区附加到帧缓冲：第二个参数重要，可以附加多个颜色纹理缓冲区！**</span></span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0 + index, <span class="built_in">TextureTarget</span>(multisampled), id, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>由于附加多个颜色纹理缓冲区到帧缓冲中，所以要用glDrawBuffers 定义<strong>多个渲染目标</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新加的！！！指定要Draw的颜色缓冲区列表</span></span><br><span class="line"><span class="keyword">if</span> (m_ColorAttachments.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(m_ColorAttachments.<span class="built_in">size</span>() &lt;= <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// 这里id对应上面，颜色纹理附加到帧缓冲的ID</span></span><br><span class="line">    GLenum buffers[<span class="number">4</span>] = &#123;GL_COLOR_ATTACHMENT0, GL_COLOR_ATTACHMENT1 ,GL_COLOR_ATTACHMENT2 ,GL_COLOR_ATTACHMENT3 &#125;;</span><br><span class="line">    <span class="comment">// 定义**多个渲染目标**</span></span><br><span class="line">    <span class="built_in">glDrawBuffers</span>(m_ColorAttachments.<span class="built_in">size</span>(), buffers);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(m_ColorAttachments.<span class="built_in">empty</span>())&#123;</span><br><span class="line">    <span class="comment">// 只有深度缓冲</span></span><br><span class="line">    <span class="built_in">glDrawBuffer</span>(GL_NONE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若只使用第一个颜色纹理缓冲区，不用上面代码，但使用第二个颜色纹理缓冲区必须要有</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只使用两个颜色纹理缓冲区可以不用后面两个</span></span><br><span class="line">GLenum buffers[] = &#123;GL_COLOR_ATTACHMENT0, GL_COLOR_ATTACHMENT1&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>可以创建多重采样的纹理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> multisampled = samples &gt; <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (multisampled) &#123;</span><br><span class="line">    <span class="built_in">glTexImage2DMultisample</span>(GL_TEXTURE_2D_MULTISAMPLE, samples, format, width, height, GL_FALSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="显示第二个渲染目标代码">显示第二个渲染目标代码</h4>
<ul>
<li>
<p>指定要附加<strong>两个</strong>颜色纹理缓冲区给帧缓冲</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FramebufferSpecification fbSpec;</span><br><span class="line">fbSpec.Attachments = &#123; FramebufferTextureFormat::RGBA8, FramebufferTextureFormat::RGBA8, FramebufferTextureFormat::Depth&#125;;</span><br><span class="line">fbSpec.Width = <span class="number">1280</span>;</span><br><span class="line">fbSpec.Height = <span class="number">720</span>;</span><br><span class="line">m_Framebuffer = Framebuffer::<span class="built_in">Create</span>(fbSpec);</span><br><span class="line"><span class="comment">// 附加的代码都在OpenGlFramebuffer中</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>glsl编写第二个输出的颜色纹理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">0</span>) out vec4 color;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">1</span>) out vec4 color2;<span class="comment">// 第二个渲染目标(颜色纹理)的颜色</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 color = <span class="built_in">texture</span>(u_Textures[<span class="built_in">int</span>(v_TexIndex)], v_TexCoord * v_TilingFactor) * v_Color;</span><br><span class="line">	 color2 = <span class="built_in">vec4</span>(<span class="number">0.9</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, <span class="number">1.0</span>);;<span class="comment">// 输出到第二个渲染目标(颜色纹理)中，红色</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>EditorLayer根据<strong>下标</strong>获取第<strong>二</strong>个渲染目标的<strong>缓冲区ID</strong>，Imgui根据缓冲区ID呈现缓冲区的颜色纹理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// imgui渲染帧缓冲中的东西。</span></span><br><span class="line"><span class="comment">// textureID是缓冲区ID</span></span><br><span class="line"><span class="type">uint32_t</span> textureID = m_Framebuffer-&gt;<span class="built_in">GetColorAttachmentRendererID</span>(<span class="number">1</span>);</span><br><span class="line">ImGui::<span class="built_in">Image</span>((<span class="type">void</span>*)textureID, <span class="built_in">ImVec2</span>(m_ViewportSize.x, m_ViewportSize.y), <span class="built_in">ImVec2</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="built_in">ImVec2</span>(<span class="number">1</span>, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="六十五、鼠标拾取帧缓存数据">六十五、鼠标拾取帧缓存数据</h2>
<h4 id="前言-5">前言</h4>
<ul>
<li>
<p>此节目的</p>
<ol>
<li>上一节已经显示了帧缓冲第二个<strong>颜色纹理</strong>缓冲的颜色</li>
<li>这节需要把帧缓冲第二个缓冲区改变<strong>类型</strong>，为<strong>有符号整形</strong>对应实体ID。</li>
<li>并且需要增加获取当前鼠标在viewport视口的<strong>相对位置</strong>，然后读取鼠标位置像素的**帧缓冲中第二个缓冲区（渲染目标）**的数据。</li>
</ol>
</li>
<li>
<p>如何实现</p>
<ul>
<li>
<p>获取鼠标在viewport视口的相对位置</p>
<p>鼠标的<strong>绝对</strong>位置是：当前位置距离整个屏幕**左上角(0,0)**的位置</p>
<p>鼠标的<strong>相对</strong>位置是：ImGui的API，<strong>得到viewport视口左上角的绝对位置</strong>，再鼠标绝对位置<strong>减去</strong>viewport窗口的左上角绝对位置即可</p>
</li>
</ul>
</li>
<li>
<p>注意细节</p>
<p>由于ImGui的viewport视口左上角为00，而OpenGL的左下角才是00，所以读取缓冲区数据时候需要<strong>翻转y</strong>（用视口高度**-** 鼠标y<strong>相对位置</strong>即可）。</p>
</li>
</ul>
<h4 id="代码">代码</h4>
<p>OpenGLFramebuffer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.1纹理附加到帧缓冲</span></span><br><span class="line"><span class="keyword">switch</span> (m_ColorAttachmentSpecifications[i].TextureFormat)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> FramebufferTextureFormat::RGBA8:</span><br><span class="line">        Utils::<span class="built_in">AttachColorTextures</span>(m_ColorAttachments[i], m_Specification.Samples, GL_RGBA8, GL_RGBA, m_Specification.Width, m_Specification.Height, i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加整形缓冲区附件</span></span><br><span class="line">    <span class="keyword">case</span> FramebufferTextureFormat::RED_INTEGER:</span><br><span class="line">        Utils::<span class="built_in">AttachColorTextures</span>(m_ColorAttachments[i], m_Specification.Samples, GL_R32I, GL_RED_INTEGER, m_Specification.Width, m_Specification.Height, i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EditorLayer.cpp  获取鼠标在viewport视口的相对位置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.先获取Viewport视口左上角与viewport视口标题栏距离的偏移位置（0,24)- 必须放这，因为标题栏后就是视口的左上角</span></span><br><span class="line"><span class="keyword">auto</span> viewportOffset = ImGui::<span class="built_in">GetCursorPos</span>();</span><br><span class="line"><span class="comment">// 2.获取vieport视口大小 - 包含标题栏的高</span></span><br><span class="line"><span class="keyword">auto</span> windowSize = ImGui::<span class="built_in">GetWindowSize</span>();</span><br><span class="line"><span class="comment">// 3.获取当前vieport视口标题栏左上角距离当前整个屏幕左上角（0,0）的位置</span></span><br><span class="line">ImVec2 minBound = ImGui::<span class="built_in">GetWindowPos</span>();</span><br><span class="line"><span class="comment">// 4.计算viewport视口的左上角距离当前整个屏幕左上角（0,0）的位置</span></span><br><span class="line">minBound.x += viewportOffset.x;</span><br><span class="line">minBound.y += viewportOffset.y;</span><br><span class="line"><span class="comment">// 5. 计算viewport视口的右下角距离当前整个屏幕左上角（0,0）的位置</span></span><br><span class="line">ImVec2 maxBound = &#123; minBound.x + windowSize.x, minBound.y + windowSize.y - viewportOffset.y &#125;;</span><br><span class="line"><span class="comment">// 6. 保存左上角和右下角距离整个屏幕左上角的位置</span></span><br><span class="line">m_ViewportBounds[<span class="number">0</span>] = &#123; minBound.x, minBound.y &#125;;</span><br><span class="line">m_ViewportBounds[<span class="number">1</span>] = &#123; maxBound.x, maxBound.y &#125;;</span><br></pre></td></tr></table></figure>
<p>鼠标<strong>绝对</strong>位置减去viewport窗口的左上角<strong>绝对</strong>位置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取当前鼠标距离整个屏幕左上角(0,0)的位置</span></span><br><span class="line"><span class="keyword">auto</span> [mx, my] = ImGui::<span class="built_in">GetMousePos</span>();</span><br><span class="line"><span class="comment">// 2.鼠标绝对位置减去viewport窗口的左上角绝对位置=鼠标相对于viewport窗口左上角的位置</span></span><br><span class="line">mx -= m_ViewportBounds[<span class="number">0</span>].x;</span><br><span class="line">my -= m_ViewportBounds[<span class="number">0</span>].y;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.viewport窗口的右下角绝对位置-左上角的绝对位置=viewport窗口的大小</span></span><br><span class="line">glm::vec2 viewportSize = m_ViewportBounds[<span class="number">1</span>] - m_ViewportBounds[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// 翻转y,使其左下角开始才是(0,0)</span></span><br><span class="line">my = viewportSize.y - my;</span><br><span class="line"><span class="type">int</span> mouseX = (<span class="type">int</span>)mx;</span><br><span class="line"><span class="type">int</span> mouseY = (<span class="type">int</span>)my;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mouseX &gt;= <span class="number">0</span> &amp;&amp; mouseY &gt;= <span class="number">0</span> &amp;&amp; mouseX &lt; (<span class="type">int</span>)viewportSize.x &amp;&amp; mouseY &lt; (<span class="type">int</span>)viewportSize.y) &#123;</span><br><span class="line">    <span class="comment">// 4.读取帧缓冲第二个缓冲区的数据</span></span><br><span class="line">    <span class="type">int</span> pixelData = m_Framebuffer-&gt;<span class="built_in">ReadPixel</span>(<span class="number">1</span>, mouseX, mouseY);</span><br><span class="line">    <span class="built_in">HE_CORE_WARN</span>(<span class="string">&quot;Pixel data = &#123;0&#125;&quot;</span>, pixelData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取鼠标位置像素的**帧缓冲中第二个缓冲区（渲染目标）**的数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">OpenGLFramebuffer::ReadPixel</span><span class="params">(<span class="type">uint32_t</span> attachmentIndex, <span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(attachmentIndex &lt; m_ColorAttachments.<span class="built_in">size</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关键函数glReadBuffer+glReadPixels</span></span><br><span class="line">    <span class="built_in">glReadBuffer</span>(GL_COLOR_ATTACHMENT0 + attachmentIndex);<span class="comment">// 读取第二个缓冲区</span></span><br><span class="line">    <span class="type">int</span> pixelData = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">glReadPixels</span>(x, y, <span class="number">1</span>, <span class="number">1</span>, GL_RED_INTEGER, GL_INT, &amp;pixelData);<span class="comment">// 读取第二个缓冲区中的xy位置的缓冲区值</span></span><br><span class="line">    <span class="keyword">return</span> pixelData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个缓冲区（渲染目标）的数据在Glsl的片段着色器中设置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">0</span>) out vec4 color;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">1</span>) out <span class="type">int</span> color2;<span class="comment">// 第二个渲染目标(有符号整形)</span></span><br><span class="line"></span><br><span class="line">in vec4 v_Color;</span><br><span class="line">in vec2 v_TexCoord;</span><br><span class="line">in <span class="type">float</span> v_TexIndex;</span><br><span class="line">in <span class="type">float</span> v_TilingFactor;</span><br><span class="line"></span><br><span class="line">uniform sampler2D u_Textures[<span class="number">32</span>]; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	 color = <span class="built_in">texture</span>(u_Textures[<span class="built_in">int</span>(v_TexIndex)], v_TexCoord * v_TilingFactor) * v_Color;</span><br><span class="line">	 color2 = <span class="number">50</span>;<span class="comment">// 第二个渲染目标(有符号整形的值)设为50</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="六十六、用固定值填充帧缓冲区">六十六、用固定值填充帧缓冲区</h2>
<h4 id="前言-6">前言</h4>
<ul>
<li>
<p>前情提要</p>
<p>由上节已经可以<strong>读取</strong>鼠标位置的颜色缓冲区的值，但是当读取不是quad的范围的值是一个**奇怪的数字*</p>
<p>是因为cpp代码中使用了glClearColor(color.r, color.g, color.b, color.a);将缓冲区<strong>默认</strong>填上了颜色,这个颜色本来是float值，<strong>转换</strong>为int读取出来则是奇怪的数字</p>
</li>
<li>
<p>如何实现</p>
<p>使用新的OpenGL函数<a target="_blank" rel="noopener" href="https://docs.gl/gl4/glClearTexImage">glClearTexImage</a>，用<strong>特定值</strong>填充缓冲区</p>
</li>
<li>
<p>实现细节</p>
<ol>
<li>由于这个glClearTexImage函数根据是设置为int值，还是float值需要<strong>指定不同参数</strong></li>
<li>需要适当考虑<strong>扩展性</strong>，但当前只需要填充int值，所以可以先简单写死，后面有增加则再改。</li>
</ol>
</li>
</ul>
<h4 id="代码-2">代码</h4>
<ul>
<li>
<p>EditorLayer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用-1填充帧缓冲的第二个颜色缓冲区</span></span><br><span class="line">m_Framebuffer-&gt;<span class="built_in">ClearAttachment</span>(<span class="number">1</span>, <span class="number">-1</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>具体填充函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpenGLFramebuffer::ClearAttachment</span><span class="params">(<span class="type">uint32_t</span> attachmentIndex, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(attachmentIndex &lt; m_ColorAttachments.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; spec = m_ColorAttachmentSpecifications[attachmentIndex];</span><br><span class="line">    <span class="built_in">glClearTexImage</span>(m_ColorAttachments[attachmentIndex], <span class="number">0</span>,</span><br><span class="line">        Utils::<span class="built_in">HEngineFBTextureFormatToGL</span>(spec.TextureFormat), GL_INT, &amp;value);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> GLenum <span class="title">HEngineFBTextureFormatToGL</span><span class="params">(FramebufferTextureFormat format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (format)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> FramebufferTextureFormat::RGBA8:					<span class="keyword">return</span> GL_RGBA8;</span><br><span class="line">        <span class="keyword">case</span> FramebufferTextureFormat::RED_INTEGER:		<span class="keyword">return</span> GL_RED_INTEGER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="六十七、获取鼠标所在的实体的ID">六十七、获取鼠标所在的实体的ID</h2>
<h4 id="前言-7">前言</h4>
<ul>
<li>
<p>前情提要</p>
<p>目前已经可以读取鼠标位置的颜色缓冲区的值，但是quad的范围读取的值是一个<strong>固定</strong>的50数字</p>
<p>需要实现读取quad实体内的像素在第二个缓冲区的值，会返回<strong>当前实体的ID</strong></p>
</li>
<li>
<p>如何实现</p>
<p>在顶点缓冲布局中添加实体ID，这样<strong>每个顶点都有一个自己的EntityID值，再将这个ID值作为第二个缓冲区像素的颜色值，这样就可以成功在当前实体里的每个像素都有这个ID值</strong></p>
</li>
</ul>
<h4 id="修改代码">修改代码</h4>
<ul>
<li>
<p>Renderer2D.cpp  给顶点缓冲区布局添加实体ID</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">QuadVertex</span> &#123;</span><br><span class="line">    glm::vec3 Position;</span><br><span class="line">    glm::vec4 Color;</span><br><span class="line">    glm::vec2 TexCoord;</span><br><span class="line">    <span class="type">float</span> TexIndex;</span><br><span class="line">    <span class="type">float</span> TilingFactor;</span><br><span class="line">    <span class="comment">// Editor-only;</span></span><br><span class="line">    <span class="type">int</span> EntityID;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 2.1设置顶点缓冲区布局</span></span><br><span class="line">s_Data.QuadVertexBuffer-&gt;<span class="built_in">SetLayout</span>(&#123;</span><br><span class="line">    &#123; ShaderDataType::Float3,		 <span class="string">&quot;a_Position&quot;</span> &#125;,</span><br><span class="line">    &#123; ShaderDataType::Float4,		 <span class="string">&quot;a_Color&quot;</span> &#125;,</span><br><span class="line">    &#123; ShaderDataType::Float2,		 <span class="string">&quot;a_TexCoord&quot;</span> &#125;,</span><br><span class="line">    &#123; ShaderDataType::Float,		 <span class="string">&quot;a_TexIndex&quot;</span> &#125;,</span><br><span class="line">    &#123; ShaderDataType::Float,		 <span class="string">&quot;a_TilingFactor&quot;</span> &#125;,</span><br><span class="line">    &#123; ShaderDataType::Int,			 <span class="string">&quot;a_EntityID&quot;</span> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Renderer2D.cpp 设置顶点属性的<strong>EntityID</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawQuad</span><span class="params">(<span class="type">const</span> glm::mat4&amp; transform, <span class="type">const</span> glm::vec4&amp; color, <span class="type">int</span> entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; quadVertexCount; i++) </span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">        s_Data.QuadVertexBufferPtr-&gt;EntityID = entityID; <span class="comment">//新增</span></span><br><span class="line">        s_Data.QuadVertexBufferPtr++;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Texture.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type vertex</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> a_Position;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec4</span> a_Color;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">in</span> <span class="type">vec2</span> a_TexCoord;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">3</span>) <span class="keyword">in</span> <span class="type">float</span> a_TexIndex;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">4</span>) <span class="keyword">in</span> <span class="type">float</span> a_TilingFactor;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">5</span>) <span class="keyword">in</span> <span class="type">int</span> a_EntityId; <span class="comment">// 新增</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> u_ViewProjection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">out</span> <span class="type">vec4</span> v_Color;</span><br><span class="line"><span class="keyword">out</span> <span class="type">vec2</span> v_TexCoord;</span><br><span class="line"><span class="keyword">out</span> <span class="type">float</span> v_TexIndex;</span><br><span class="line"><span class="keyword">out</span> <span class="type">float</span> v_TilingFactor;</span><br><span class="line"><span class="keyword">out</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityId;	<span class="comment">// 新增</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">in</span> <span class="type">float</span> v_TilingFactor;</span><br><span class="line"><span class="keyword">in</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityId; 	<span class="comment">// 新增</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">	 color2 = v_EntityId;	<span class="comment">// 新增</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>EditorLayer.cpp  获取当前选中实体信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnUpdate</span><span class="params">(Timestep ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mouseX &gt;= <span class="number">0</span> &amp;&amp; mouseY &gt;= <span class="number">0</span> &amp;&amp; mouseX &lt; (<span class="type">int</span>)viewportSize.x &amp;&amp; mouseY &lt; (<span class="type">int</span>)viewportSize.y)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pixelData = m_Framebuffer-&gt;<span class="built_in">ReadPixel</span>(<span class="number">1</span>, mouseX, mouseY);</span><br><span class="line">        m_HoveredEntity = pixelData == <span class="number">-1</span> ? <span class="built_in">Entity</span>() : <span class="built_in">Entity</span>((entt::entity)pixelData, m_ActiveScene.<span class="built_in">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnImGuiRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string name = <span class="string">&quot;None&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (m_HoveredEntity)</span><br><span class="line">        name = m_HoveredEntity.<span class="built_in">GetComponent</span>&lt;TagComponent&gt;().Tag;</span><br><span class="line">    ImGui::<span class="built_in">Text</span>(<span class="string">&quot;Hovered Entity: %s &quot;</span>, name.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="六十八、点击选择实体">六十八、点击选择实体</h2>
<h4 id="前言-8">前言</h4>
<ul>
<li>
<p>前情提要</p>
<p>由上节已经可以读取当前鼠标位置所在实体围成的像素在缓冲区的<strong>实体ID值</strong></p>
<p>此节实现鼠标点击实体，会出现gizmos，并且可以拖动什么的</p>
</li>
<li>
<p>实现过程中出现的Bug</p>
<ol>
<li>拖动gizmo移动一个实体与另一个实体重叠时停下，且另一个实体在当前实体上面，再点击gizmo想移动<strong>原先</strong>实体，那么会获取在<strong>上面</strong>另一个实体的实体ID，即<strong>另一个实体会被选中</strong>，会切换gizmo。</li>
<li>显示了gizmo，但是若按下leftalt拖动旋转摄像机，则gizmo会消失</li>
</ol>
</li>
</ul>
<h4 id="代码-3">代码</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnEvent</span><span class="params">(Event&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 事件</span></span><br><span class="line">    m_CameraController.<span class="built_in">OnEvent</span>(e);</span><br><span class="line">    m_EditorCamera.<span class="built_in">OnEvent</span>(e);</span><br><span class="line"></span><br><span class="line">    <span class="function">EventDispatcher <span class="title">dispatcher</span><span class="params">(e)</span></span>;</span><br><span class="line">    dispatcher.<span class="built_in">Dispatch</span>&lt;MouseButtonPressedEvent&gt;(<span class="built_in">HE_BIND_EVENT_FN</span>(EditorLayer::OnMouseButtonPressed));</span><br><span class="line">&#125;</span><br><span class="line">.......</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EditorLayer::OnMouseButtonPressed</span><span class="params">(MouseButtonPressedEvent&amp; e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e.<span class="built_in">GetMouseButton</span>() == Mouse::ButtonLeft) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">				m_ViewportHovered 是为了在别的视口点击不会关闭当前显示的gizmo</span></span><br><span class="line"><span class="comment">				两个&amp;&amp;后面是解决下面两个问题</span></span><br><span class="line"><span class="comment">				1. 拖动gizmo移动一个实体与另一个实体重叠时停下，且另一个实体在当前实体上面，再点击gizmo想移动原先实体，那么会获取在上面另一个实体的实体ID，即另一个实体会被选中，会切换gizmo。</span></span><br><span class="line"><span class="comment">				2. 显示了gizmo，但是若按下leftalt拖动旋转摄像机，则gizmo会消失</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_ViewportHovered &amp;&amp; !ImGuizmo::<span class="built_in">IsOver</span>() &amp;&amp; !Input::<span class="built_in">IsKeyPressed</span>(Key::LeftAlt)) &#123;</span><br><span class="line">            m_SceneHierarchyPanel.<span class="built_in">SetSelectedEntity</span>(m_HoveredEntity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">.......</span><br><span class="line"><span class="comment">// 选中实体//</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SceneHierarchyPanel::SetSelectedEntity</span><span class="params">(Entity entity)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_SelectionContext = entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="六十九、Vulkan和新Shader系统">六十九、Vulkan和新Shader系统</h2>
<h4 id="前言-9">前言</h4>
<ul>
<li>
<p>当前项目以后打算支持vulkan，由于vulkan着色器代码也支持glsl语言，但是和Opengl的glsl<strong>标准不一样</strong>。</p>
<p>因为Vulkan中存在OpenGL的不存在的东西（反之亦然），所以着色器代码肯定不同。</p>
<ul>
<li>
<p>vulkan和opengl的glsl对比-以Uniform为例</p>
<ul>
<li>
<p>主要不同</p>
<p>在于，opengl支持uniform，vulkan不支持uniform，而是支持uniform<strong>缓冲区</strong>（push_constant、存储缓冲区）这比OpenGL的glsl更好。</p>
<p>opengl的uniform</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uniform</span> <span class="type">mat4</span> m_transform;</span><br></pre></td></tr></table></figure>
<p>vulkan的uniform缓冲区</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>, <span class="keyword">binding</span>=<span class="number">2</span>) <span class="keyword">uniform</span> Transform&#123;</span><br><span class="line">    <span class="type">mat4</span> Transform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Opengl支持的uniform哪里不好</p>
<p>场景有很多个物体，这样一个物体调用一次drawcall（不是批处理模式），每个物体需要显示都需要<strong>上传</strong>摄像机的投影视图矩阵，那么10000个物体就有10000个uniform更新，但其实摄像机的投影视图矩阵在当前帧不变的，这样就会造成性能的下降。</p>
</li>
<li>
<p>vulkan哪里好</p>
<p>vulkan的uniform是在<strong>GPU开辟的一块缓冲区</strong>，每个物体需要摄像机的投影视图矩阵，只需将这块缓冲区放入投影矩阵的值，然后每个drawcall都去<strong>访问</strong>这块缓冲区，得到投影视图矩阵就行，性能更好。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>此节目的</p>
<p>重新写shader系统，使其能支持vulkan和opengl两种glsl</p>
</li>
<li>
<p>如何实现</p>
<p>使用SPIR-V，作为<strong>中间表示语言</strong>，即可支持vulkan也支持opengl的glsl</p>
</li>
</ul>
<h4 id="介绍SPIR-V">介绍SPIR-V</h4>
<ul>
<li>
<p>介绍SPIR-V</p>
<p>vulkanApi要求以SPIR-V组件的形式提供着色器，而这个SPIR-V相当于“<strong>中间表示语言</strong>”</p>
<ol>
<li>可以将写好的glsl、hlsl转换为SPIR-V</li>
<li>也可以将SPIR-V转换为glsl、hlsl。</li>
</ol>
<p>使得可以完成只写<strong>一</strong>次shader，自动生成<strong>各种不同版本的shader语言</strong>。</p>
</li>
<li>
<p>SPIR-V什么工作方式：（可能我理解错了了）</p>
<p>将vulkan的glsl用SPIR-V<strong>编译</strong>成SPIR-V<strong>二进制</strong>文件，然后用SPIR-V的<strong>交叉编译</strong>这个二进制文件成hlsl、metal，以及兼容OpenGL的glsl。</p>
</li>
<li>
<p>实现过程中的重要功能</p>
<p>使用SPIR-V加入着色器<strong>缓存</strong>功能，不用每次都编译着色器，<strong>节省时间</strong>。</p>
</li>
</ul>
<p>以上很有可能说的不正确，我有点迷糊，东拼西凑的写完以上内容，但大概意思是这样。</p>
<h4 id="代码-4">代码</h4>
<ul>
<li>
<p>写vulkan的glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type vertex</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> a_Position;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec4</span> a_Color;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">in</span> <span class="type">vec2</span> a_TexCoord;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">3</span>) <span class="keyword">in</span> <span class="type">float</span> a_TexIndex;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">4</span>) <span class="keyword">in</span> <span class="type">float</span> a_TilingFactor;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">5</span>) <span class="keyword">in</span> <span class="type">int</span> a_EntityID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>, <span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> Camera&#123; <span class="comment">// std140是布局</span></span><br><span class="line">	<span class="type">mat4</span> u_ViewProjection;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct VertexOutput &#123;</span><br><span class="line">	<span class="type">vec4</span> Color;</span><br><span class="line">	<span class="type">vec2</span> TexCoord;</span><br><span class="line">	<span class="type">float</span> TexIndex;</span><br><span class="line">	<span class="type">float</span> TilingFactor;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> VertexOutput Output;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">4</span>) <span class="keyword">out</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityID; <span class="comment">// 4 是因为TilingFactor 是3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line"></span><br><span class="line">	Output.Color = a_Color;</span><br><span class="line">	Output.TexCoord = a_TexCoord;</span><br><span class="line">	Output.TexIndex = a_TexIndex;</span><br><span class="line">	Output.TilingFactor = a_TilingFactor;</span><br><span class="line">	v_EntityID = a_EntityID;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">gl_Position</span> = u_ViewProjection * <span class="type">vec4</span>(a_Position, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec4</span> color;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">out</span> <span class="type">int</span> color2;</span><br><span class="line"></span><br><span class="line">struct VertexOutput &#123;</span><br><span class="line">	<span class="type">vec4</span> Color;</span><br><span class="line">	<span class="type">vec2</span> TexCoord;</span><br><span class="line">	<span class="type">float</span> TexIndex;</span><br><span class="line">	<span class="type">float</span> TilingFactor;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> VertexOutput Input;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">4</span>) <span class="keyword">in</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityID; <span class="comment">// 4 是因为TilingFactor 是3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> <span class="type">sampler2D</span> u_Textures[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">	 color = <span class="built_in">texture</span>(u_Textures[<span class="type">int</span>(Input.TexIndex)], Input.TexCoord * Input.TilingFactor) * Input.Color;</span><br><span class="line">	 color2 = v_EntityID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>新建UniformBuffer类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> HEngine &#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">UniformBuffer</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="keyword">virtual</span> ~<span class="built_in">UniformBuffer</span>() &#123;&#125;</span><br><span class="line">		<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetData</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">uint32_t</span> size, <span class="type">uint32_t</span> offset = <span class="number">0</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line">		<span class="function"><span class="type">static</span> Ref&lt;UniformBuffer&gt; <span class="title">Create</span><span class="params">(<span class="type">uint32_t</span> size, <span class="type">uint32_t</span> binding)</span></span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OpenGLUniformBuffer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">OpenGLUniformBuffer::<span class="built_in">OpenGLUniformBuffer</span>(<span class="type">uint32_t</span> size, <span class="type">uint32_t</span> binding)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建一个 OpenGL 缓冲对象，并存储在 m_RendererID</span></span><br><span class="line">    <span class="built_in">glCreateBuffers</span>(<span class="number">1</span>, &amp;m_RendererID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配缓冲区内存，但不初始化数据，使用 GL_DYNAMIC_DRAW 作为提示（数据会频繁更新）</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 研究 GL_DYNAMIC_DRAW 是否最优，可能可以换成其他模式</span></span><br><span class="line">    <span class="built_in">glNamedBufferData</span>(m_RendererID, size, <span class="literal">nullptr</span>, GL_DYNAMIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定缓冲区到指定的 Uniform Buffer 绑定点</span></span><br><span class="line">    <span class="built_in">glBindBufferBase</span>(GL_UNIFORM_BUFFER, binding, m_RendererID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OpenGLUniformBuffer::~<span class="built_in">OpenGLUniformBuffer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 删除 OpenGL 缓冲对象，释放 GPU 资源</span></span><br><span class="line">    <span class="built_in">glDeleteBuffers</span>(<span class="number">1</span>, &amp;m_RendererID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpenGLUniformBuffer::SetData</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">uint32_t</span> size, <span class="type">uint32_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 更新缓冲区的部分数据，避免重新分配整个缓冲区，提高性能</span></span><br><span class="line">    <span class="built_in">glNamedBufferSubData</span>(m_RendererID, offset, size, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Renderer2D.cpp上传摄像机的投影视图矩阵给Uniform缓冲区</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Renderer2DData</span></span><br><span class="line">&#123;</span><br><span class="line">	.....</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">CameraData</span></span><br><span class="line">    &#123;</span><br><span class="line">        glm::mat4 ViewProjection;</span><br><span class="line">    &#125;;</span><br><span class="line">    CameraData CameraBuffer;</span><br><span class="line">    Ref&lt;UniformBuffer&gt; CameraUniformBuffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    .....</span><br><span class="line">	<span class="comment">// 初始化CameraUniformBuffer实例，在构造函数中就将调用上面的glBindBufferBase函数</span></span><br><span class="line">    s_Data.CameraUniformBuffer = UniformBuffer::<span class="built_in">Create</span>(<span class="built_in">sizeof</span>(Renderer2DData::CameraData), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::BeginScene</span><span class="params">(<span class="type">const</span> EditorCamera&amp; camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HE_PROFILE_FUNCTION</span>();</span><br><span class="line"></span><br><span class="line">    s_Data.CameraBuffer.ViewProjection = camera.<span class="built_in">GetViewProjection</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 上传数据给缓冲区///</span></span><br><span class="line">    s_Data.CameraUniformBuffer-&gt;<span class="built_in">SetData</span>(&amp;s_Data.CameraBuffer, <span class="built_in">sizeof</span>(Renderer2DData::CameraData));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">StartBatch</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十、-显示资源文件夹UI">七十、 显示资源文件夹UI</h2>
<h4 id="前言-10">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>为了实现quad有纹理，要实现像Unity那样<strong>拖动</strong>纹理的文件 到 实体的组件下就能生成纹理组件。</p>
<p>此节为完成此目的，需先完成显示本地assets文件夹下的文件夹和文件。</p>
</li>
<li>
<p>如何实现</p>
<ol>
<li>用ImGUI渲染</li>
<li>由C++的fstream检索处理的文件和文件夹。</li>
</ol>
</li>
</ul>
<h4 id="代码-5">代码</h4>
<p>新建ContentBrowserPanel.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> std::filesystem::path s_AssetPath = <span class="string">&quot;assets&quot;</span>;</span><br><span class="line"></span><br><span class="line">ContentBrowserPanel::<span class="built_in">ContentBrowserPanel</span>()</span><br><span class="line">    :<span class="built_in">m_CurrentDirectory</span>(s_AssetPath)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ContentBrowserPanel::OnImGuiRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 开始创建 ImGui 窗口，窗口名称为 &quot;Content Browser&quot;</span></span><br><span class="line">    ImGui::<span class="built_in">Begin</span>(<span class="string">&quot;Content Browser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果当前目录不是资源目录（s_AssetPath），显示返回上级目录的按钮</span></span><br><span class="line">    <span class="keyword">if</span> (m_CurrentDirectory != std::filesystem::<span class="built_in">path</span>(s_AssetPath))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ImGui::<span class="built_in">Button</span>(<span class="string">&quot;&lt;-&quot;</span>)) <span class="comment">// 返回按钮</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_CurrentDirectory = m_CurrentDirectory.<span class="built_in">parent_path</span>(); <span class="comment">// 进入上一级目录</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历当前目录下的所有文件和子目录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; directoryEntry : std::filesystem::<span class="built_in">directory_iterator</span>(m_CurrentDirectory))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span>&amp; path = directoryEntry.<span class="built_in">path</span>(); <span class="comment">// 获取当前文件/目录的路径</span></span><br><span class="line">        <span class="keyword">auto</span> relativePath = std::filesystem::<span class="built_in">relative</span>(path, s_AssetPath); <span class="comment">// 计算相对路径</span></span><br><span class="line">        std::string filenameString = relativePath.<span class="built_in">filename</span>().<span class="built_in">string</span>(); <span class="comment">// 获取文件/目录名并转换为字符串</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (directoryEntry.<span class="built_in">is_directory</span>()) <span class="comment">// 判断是否为目录</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是目录，创建一个按钮，点击后进入该目录</span></span><br><span class="line">            <span class="keyword">if</span> (ImGui::<span class="built_in">Button</span>(filenameString.<span class="built_in">c_str</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">                m_CurrentDirectory /= path.<span class="built_in">filename</span>(); <span class="comment">// 进入该子目录</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是文件，创建一个按钮，点击后可以触发相关操作（这里暂未实现）</span></span><br><span class="line">            <span class="keyword">if</span>(ImGui::<span class="built_in">Button</span>(filenameString.<span class="built_in">c_str</span>()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 可在此添加打开文件或其他操作</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束 ImGui 窗口</span></span><br><span class="line">    ImGui::<span class="built_in">End</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="七十一、内容面板和ImGui拖放">七十一、内容面板和ImGui拖放</h2>
<h4 id="前言-11">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>为完成拖动材质赋予实体，需先完成<strong>拖动</strong>这个功能，因为项目已经有打开场景函数，所以此节完成<strong>拖动场景是否能打开场景</strong>。</p>
</li>
</ul>
<h4 id="代码-6">代码</h4>
<ul>
<li>
<p>ContentBrowserPanel.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ContentBrowserPanel::OnImGuiRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//实现拖拽功能，允许从内容浏览器拖动文件</span></span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">BeginDragDropSource</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">wchar_t</span>* itemPath = relativePath.<span class="built_in">c_str</span>();</span><br><span class="line">        ImGui::<span class="built_in">SetDragDropPayload</span>(<span class="string">&quot;CONTENT_BROWSER_ITEM&quot;</span>, itemPath, (<span class="built_in">wcslen</span>(itemPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(<span class="type">wchar_t</span>));</span><br><span class="line">        ImGui::<span class="built_in">EndDragDropSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>EditorLayer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnImGuiRender</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 接收在此视口拖放过来的值</span></span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">BeginDragDropTarget</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 因为接收内容可能为空，需要if判断 。 CONTENT_BROWSER_ITEM：拖动携带的内容</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">const</span> ImGuiPayload* payload = ImGui::<span class="built_in">AcceptDragDropPayload</span>(<span class="string">&quot;CONTENT_BROWSER_ITEM&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">wchar_t</span>* path = (<span class="type">const</span> <span class="type">wchar_t</span>*)payload-&gt;Data;</span><br><span class="line">            <span class="built_in">OpenScene</span>(std::filesystem::<span class="built_in">path</span>(g_AssetPath) / path);</span><br><span class="line">        &#125;</span><br><span class="line">        ImGui::<span class="built_in">EndDragDropTarget</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OpenScene</span><span class="params">(<span class="type">const</span> std::filesystem::path&amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_ActiveScene = <span class="built_in">CreateRef</span>&lt;Scene&gt;();</span><br><span class="line">    m_ActiveScene-&gt;<span class="built_in">OnViewportResize</span>((<span class="type">uint32_t</span>)m_ViewportSize.x, (<span class="type">uint32_t</span>)m_ViewportSize.y);</span><br><span class="line">    m_SceneHierarchyPanel.<span class="built_in">SetContext</span>(m_ActiveScene);</span><br><span class="line"></span><br><span class="line">    <span class="function">SceneSerializer <span class="title">serializer</span><span class="params">(m_ActiveScene)</span></span>;</span><br><span class="line">    serializer.<span class="built_in">Deserialize</span>(path.<span class="built_in">string</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十二、拖拽添加纹理">七十二、拖拽添加纹理</h2>
<h4 id="前言-12">前言</h4>
<ul>
<li>
<p>目的</p>
<p>完成拖动内容面板上的材质给实体，实体表面会显示这个材质</p>
</li>
</ul>
<h4 id="代码-7">代码</h4>
<ul>
<li>
<p>SceneHierarchyPanel.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DrawComponent</span>&lt;SpriteRendererComponent&gt;(<span class="string">&quot;Sprite Renderer&quot;</span>, entity, [](<span class="keyword">auto</span>&amp; component)</span><br><span class="line">&#123;</span><br><span class="line">        ImGui::<span class="built_in">Button</span>(<span class="string">&quot;Texture&quot;</span>, <span class="built_in">ImVec2</span>(<span class="number">100.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">        <span class="keyword">if</span> (ImGui::<span class="built_in">BeginDragDropTarget</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">const</span> ImGuiPayload* payload = ImGui::<span class="built_in">AcceptDragDropPayload</span>(<span class="string">&quot;CONTENT_BROWSER_ITEM&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">wchar_t</span>* path = (<span class="type">const</span> <span class="type">wchar_t</span>*)payload-&gt;Data;</span><br><span class="line">                std::filesystem::path texturePath = std::filesystem::<span class="built_in">path</span>(g_AssetPath) / path; </span><br><span class="line">                component.Texture = Texture2D::<span class="built_in">Create</span>(texturePath.<span class="built_in">string</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            ImGui::<span class="built_in">EndDragDropTarget</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        ImGui::<span class="built_in">DragFloat</span>(<span class="string">&quot;Tiling Factor&quot;</span>, &amp;component.TilingFactor, <span class="number">0.1f</span>, <span class="number">0.0f</span>, <span class="number">100.0f</span>);</span><br><span class="line">&#125;);	</span><br></pre></td></tr></table></figure>
<p>Components.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SpriteRendererComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//新增</span></span><br><span class="line">    Ref&lt;Texture2D&gt; Texture;</span><br><span class="line">    <span class="type">float</span> TilingFactor = <span class="number">1.0f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Renderer2D.cpp 调用drawcall绘制</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawSprite</span><span class="params">(<span class="type">const</span> glm::mat4&amp; transform, SpriteRendererComponent&amp; src, <span class="type">int</span> entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (src.Texture) &#123;</span><br><span class="line">        <span class="built_in">DrawQuad</span>(transform, src.Texture, src.TilingFactor, src.Color, entityID);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">DrawQuad</span>(transform, src.Color, entityID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十三、新增Play-Stop按钮">七十三、新增Play/Stop按钮</h2>
<h4 id="前言-13">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>为了物理效果能可以运行，这节需要完成工具栏的UI，点击播放运行和停止物理效果（后几节做）。</p>
</li>
</ul>
<h4 id="代码-8">代码</h4>
<ul>
<li>
<p>EditorLayer.cpp  设计工具栏UI</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::UI_Toolbar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 设置 ImGui 样式：调整窗口的内边距和元素间距</span></span><br><span class="line">    ImGui::<span class="built_in">PushStyleVar</span>(ImGuiStyleVar_WindowPadding, <span class="built_in">ImVec2</span>(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">    ImGui::<span class="built_in">PushStyleVar</span>(ImGuiStyleVar_ItemInnerSpacing, <span class="built_in">ImVec2</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置按钮颜色为透明（使按钮背景不可见）</span></span><br><span class="line">    ImGui::<span class="built_in">PushStyleColor</span>(ImGuiCol_Button, <span class="built_in">ImVec4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 ImGui 当前主题颜色</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; colors = ImGui::<span class="built_in">GetStyle</span>().Colors;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置鼠标悬浮时的按钮颜色，透明度降低（更明显的悬浮效果）</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; buttonHovered = colors[ImGuiCol_ButtonHovered];</span><br><span class="line">    ImGui::<span class="built_in">PushStyleColor</span>(ImGuiCol_ButtonHovered, <span class="built_in">ImVec4</span>(buttonHovered.x, buttonHovered.y, buttonHovered.z, <span class="number">0.5f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置按钮按下时的颜色，透明度降低（更明显的按下效果）</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; buttonActive = colors[ImGuiCol_ButtonActive];</span><br><span class="line">    ImGui::<span class="built_in">PushStyleColor</span>(ImGuiCol_ButtonActive, <span class="built_in">ImVec4</span>(buttonActive.x, buttonActive.y, buttonActive.z, <span class="number">0.5f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建无装饰、无滚动条的 ImGui 窗口（用于工具栏）</span></span><br><span class="line">    ImGui::<span class="built_in">Begin</span>(<span class="string">&quot;##toolbar&quot;</span>, <span class="literal">nullptr</span>, ImGuiWindowFlags_NoDecoration | ImGuiWindowFlags_NoScrollbar | ImGuiWindowFlags_NoScrollWithMouse);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算按钮大小（按钮的高度 = 窗口高度 - 4）</span></span><br><span class="line">    <span class="type">float</span> size = ImGui::<span class="built_in">GetWindowHeight</span>() - <span class="number">4.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据当前场景状态选择合适的图标：</span></span><br><span class="line">    <span class="comment">//  - 如果当前是编辑模式（Edit），显示“播放”按钮</span></span><br><span class="line">    <span class="comment">//  - 如果当前是播放模式（Play），显示“停止”按钮</span></span><br><span class="line">    Ref&lt;Texture2D&gt; icon = m_SceneState == SceneState::Edit ? m_IconPlay : m_IconStop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置按钮水平居中</span></span><br><span class="line">    ImGui::<span class="built_in">SetCursorPosX</span>((ImGui::<span class="built_in">GetWindowContentRegionMax</span>().x * <span class="number">0.5f</span>) - (size * <span class="number">0.5f</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建播放/停止按钮</span></span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">ImageButton</span>((ImTextureID)icon-&gt;<span class="built_in">GetRendererID</span>(), <span class="built_in">ImVec2</span>(size, size), <span class="built_in">ImVec2</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="built_in">ImVec2</span>(<span class="number">1</span>, <span class="number">1</span>), <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果当前是编辑模式，点击按钮后进入播放模式</span></span><br><span class="line">        <span class="keyword">if</span> (m_SceneState == SceneState::Edit)</span><br><span class="line">            <span class="built_in">OnScenePlay</span>();</span><br><span class="line">        <span class="comment">// 如果当前是播放模式，点击按钮后进入编辑模式</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m_SceneState == SceneState::Play)</span><br><span class="line">            <span class="built_in">OnSceneStop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复 ImGui 样式设置（避免影响其他 UI 元素）</span></span><br><span class="line">    ImGui::<span class="built_in">PopStyleVar</span>(<span class="number">2</span>);    <span class="comment">// 恢复窗口和元素间距</span></span><br><span class="line">    ImGui::<span class="built_in">PopStyleColor</span>(<span class="number">3</span>);  <span class="comment">// 恢复按钮颜色</span></span><br><span class="line">    ImGui::<span class="built_in">End</span>();             <span class="comment">// 结束 ImGui 窗口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>根据当前不同状态，Scene调用不同函数渲染静态场景、动态场景（物理效果）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnUpdate</span><span class="params">(Timestep ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_SceneState)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SceneState::Edit:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_ViewportFocused)</span><br><span class="line">                m_CameraController.<span class="built_in">OnUpdate</span>(ts);</span><br><span class="line"></span><br><span class="line">            m_EditorCamera.<span class="built_in">OnUpdate</span>(ts);</span><br><span class="line"></span><br><span class="line">            m_ActiveScene-&gt;<span class="built_in">OnUpdateEditor</span>(ts, m_EditorCamera);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SceneState::Play:</span><br><span class="line">        &#123;</span><br><span class="line">            m_ActiveScene-&gt;<span class="built_in">OnUpdateRuntime</span>(ts);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十四、2D物理引擎！">七十四、2D物理引擎！</h2>
<h4 id="前言-14">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>实现2D物理效果,选择使用Box2D库实现，具体使用可看<a target="_blank" rel="noopener" href="https://box2d.org/documentation/">官方文档</a></p>
</li>
<li>
<p>实现细节</p>
<ul>
<li>实现物体效果需要rigidbody和box2dcollider两个组件</li>
<li>添加了rigidbody和box2dcollider两个组件，需要修改面板以及序列化代码</li>
<li>以后要实现：每次运行结束后可以重置物体的位置</li>
</ul>
</li>
<li>
<p>有脚本的box2D物理运行顺序——有待搞清楚</p>
<ul>
<li>
<p>Script-Physic-Render顺序</p>
<p>脚本影响pyhsic然后渲染，<strong>当前帧</strong>得到结果</p>
</li>
<li>
<p>Physic-Script-Render顺序</p>
<p>先Physic-脚本-渲染，则当前渲染的是<strong>上一帧</strong>的物理模拟计算的结果</p>
</li>
</ul>
</li>
</ul>
<h4 id="代码-9">代码</h4>
<ul>
<li>
<p>设置box2D为当前项目的submodule，并重新运行premake程序生成项目</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule add https://github.com/donghuiw/box2d.git</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>新增PhysicsManager类</p>
</li>
<li>
<p>PhysicsManage.h</p>
</li>
<li>
<pre><code class="language-c++">namespace HEngine
&#123;
	class Scene;
	class Timestep;
	struct Rigidbody2DComponent;
	struct BoxCollider2DComponent;

	class PhysicsManager
	&#123;
	public:
		void CreateWorld();
		void DestoryWorld();
		void AddRigibody(Scene* scene, entt::entity e);
		void AttachBoxshape(Scene* scene, entt::entity e);
		void DestoryBoxshape(Scene* scene, entt::entity e);
		void FixedUpdate(Timestep ts);
		void UpdateRigidbody(Scene* scnen, entt::entity e);

	public:
		static PhysicsManager&amp; Get() &#123; return m_instance; &#125;

	private:
		b2WorldId m_WorldId = b2_nullWorldId;

		static PhysicsManager m_instance;
	&#125;;
&#125;

<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- PhysicsManage.cpp</span><br><span class="line"></span><br><span class="line">  ```cpp</span><br><span class="line">  <span class="comment">//创建物理世界，相互作用的物体、形状、关节和接触点的集合</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PhysicsManager::CreateWorld</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      b2WorldDef worldDef = <span class="built_in">b2DefaultWorldDef</span>();</span><br><span class="line">      worldDef.gravity = &#123; <span class="number">0.0f</span>, <span class="number">-9.8f</span> &#125;;</span><br><span class="line">      worldDef.restitutionThreshold = <span class="number">0.5f</span>;</span><br><span class="line">      m_WorldId = <span class="built_in">b2CreateWorld</span>(&amp;worldDef);</span><br><span class="line">      <span class="built_in">HE_CORE_ASSERT</span>(<span class="built_in">b2World_IsValid</span>(m_WorldId),<span class="string">&quot;World id validation failed. &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PhysicsManager::AddRigibody</span><span class="params">(Scene* scene, entt::entity e)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      Entity entity = &#123; e, scene &#125;;</span><br><span class="line">      <span class="keyword">auto</span>&amp; transform = entity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;();</span><br><span class="line">      <span class="keyword">auto</span>&amp; rb2d = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">  </span><br><span class="line">      b2BodyDef bodyDef = <span class="built_in">b2DefaultBodyDef</span>();</span><br><span class="line">      bodyDef.type = <span class="built_in">GetBox2DBodyType</span>(rb2d.Type);</span><br><span class="line">      bodyDef.position = &#123; transform.Translation.x, transform.Translation.y &#125;;</span><br><span class="line">      bodyDef.rotation = <span class="built_in">b2MakeRot</span>(transform.Rotation.z);</span><br><span class="line">  </span><br><span class="line">      b2BodyId bodyId = <span class="built_in">b2CreateBody</span>(m_WorldId, &amp;bodyDef);</span><br><span class="line">      <span class="built_in">b2Body_SetFixedRotation</span>(bodyId, rb2d.FixedRotation);</span><br><span class="line">      rb2d.RuntimeBodyId = bodyId;</span><br><span class="line">  </span><br><span class="line">      <span class="built_in">HE_CORE_ASSERT</span>(<span class="built_in">b2Body_IsValid</span>(rb2d.RuntimeBodyId), <span class="string">&quot;Body id validation failed.&quot;</span>);</span><br><span class="line">  </span><br><span class="line">      <span class="built_in">AttachBoxshape</span>(scene, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//形状将碰撞几何体绑定到物体上,并添加密度、摩擦力和恢复力等材料属性</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PhysicsManager::AttachBoxshape</span><span class="params">(Scene* scene, entt::entity e)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      Entity entity = &#123; e, scene &#125;;</span><br><span class="line">      <span class="keyword">auto</span>&amp; transform = entity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;();</span><br><span class="line">      <span class="keyword">auto</span>&amp; bc2d = entity.<span class="built_in">GetComponent</span>&lt;BoxCollider2DComponent&gt;();</span><br><span class="line">      <span class="keyword">auto</span>&amp; rb2d = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">b2Body_IsValid</span>(rb2d.RuntimeBodyId)) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">      b2Polygon boxShape = <span class="built_in">b2MakeBox</span>(bc2d.Size.x * transform.Scale.x, bc2d.Size.y * transform.Scale.y);</span><br><span class="line">  </span><br><span class="line">      b2ShapeDef shapeDef = <span class="built_in">b2DefaultShapeDef</span>();</span><br><span class="line">      shapeDef.friction = bc2d.Friction;</span><br><span class="line">      shapeDef.density = bc2d.Density;</span><br><span class="line">      shapeDef.restitution = bc2d.Restitution;</span><br><span class="line">  </span><br><span class="line">      b2ShapeId shapeID = <span class="built_in">b2CreatePolygonShape</span>(rb2d.RuntimeBodyId, &amp;shapeDef, &amp;boxShape);</span><br><span class="line">      bc2d.RuntimeShapeId = shapeID;</span><br><span class="line">  </span><br><span class="line">      <span class="built_in">HE_CORE_ASSERT</span>(<span class="built_in">b2Shape_IsValid</span>(bc2d.RuntimeShapeId), <span class="string">&quot;Shape id validation failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>Components.h</p>
</li>
<li>
<pre><code class="language-c++">struct Rigidbody2DComponent
&#123;
    enum class BodyType &#123; Static = 0, Dynamic, Kinematic &#125;;
    BodyType Type = BodyType::Static;
    bool FixedRotation = false;

    //Storage for runtime
    b2BodyId RuntimeBodyId = b2_nullBodyId;

    Rigidbody2DComponent() = default;

    Rigidbody2DComponent(const Rigidbody2DComponent&amp; other) = default;
    Rigidbody2DComponent&amp; operator=(const Rigidbody2DComponent&amp;) = default;
&#125;;

struct BoxCollider2DComponent
&#123;
    glm::vec2 Offset = &#123; 0.0f, 0.0f &#125;;
    glm::vec2 Size = &#123; 0.5f, 0.5f &#125;;

    //TODO(Yan): move into physics material in the future mybe
    float Density = 1.0f;		
    float Friction = 0.5f;		
    float Restitution = 0.0f;		

    b2ShapeId RuntimeShapeId = b2_nullShapeId;

    //Storage for runtime
    void* RuntimeFixture = nullptr;

    BoxCollider2DComponent() = default;
    BoxCollider2DComponent(const BoxCollider2DComponent&amp;) = default;
&#125;;
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- Scene.cpp</span><br><span class="line"></span><br><span class="line">  ```<span class="function">cpp</span></span><br><span class="line"><span class="function">  <span class="type">void</span> <span class="title">Scene::OnRuntimeStart</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      PhysicsManager::<span class="built_in">Get</span>().<span class="built_in">CreateWorld</span>();</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">auto</span> view = m_Registry.<span class="built_in">view</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> e : view)</span><br><span class="line">      &#123;</span><br><span class="line">          PhysicsManager::<span class="built_in">Get</span>().<span class="built_in">AddRigibody</span>(<span class="keyword">this</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Scene::OnRuntimeStop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      PhysicsManager::<span class="built_in">Get</span>().<span class="built_in">DestoryWorld</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<p>在属性面板显示物理组件（省略包围盒组件代码）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DrawComponent</span>&lt;Rigidbody2DComponent&gt;(<span class="string">&quot;Rigidbody 2D&quot;</span>, entity, [](<span class="keyword">auto</span>&amp; component) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* bodyTypeStrings[] = &#123; <span class="string">&quot;Static&quot;</span>, <span class="string">&quot;Dynamic&quot;</span>, <span class="string">&quot;Kinematic&quot;</span> &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* currentBodyTypeString = bodyTypeStrings[(<span class="type">int</span>)component.Type];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">BeginCombo</span>(<span class="string">&quot;Body Type&quot;</span>, currentBodyTypeString)) &#123; </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123; </span><br><span class="line">            <span class="type">bool</span> isSelected = currentBodyTypeString == bodyTypeStrings[i];</span><br><span class="line">            <span class="keyword">if</span> (ImGui::<span class="built_in">Selectable</span>(bodyTypeStrings[i], isSelected)) &#123; </span><br><span class="line">                currentBodyTypeString = bodyTypeStrings[i];</span><br><span class="line">                component.Type = (Rigidbody2DComponent::BodyType)i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isSelected)</span><br><span class="line">                ImGui::<span class="built_in">SetItemDefaultFocus</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        ImGui::<span class="built_in">EndCombo</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ImGui::<span class="built_in">Checkbox</span>(<span class="string">&quot;Fixed Rotation&quot;</span>, &amp;component.FixedRotation);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>场景yaml文件需保存和解析物理组件（省略包围盒组件）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (entity.<span class="built_in">HasComponent</span>&lt;Rigidbody2DComponent&gt;())</span><br><span class="line">&#123;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Rigidbody2DComponent&quot;</span>;</span><br><span class="line">    out &lt;&lt; YAML::BeginMap; <span class="comment">// Rigidbody2DComponent</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; rb2dComponent = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;BodyType&quot;</span> &lt;&lt; YAML::Value &lt;&lt; <span class="built_in">RigidBody2DBodyTypeToString</span>(rb2dComponent.Type);</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;FixedRotation&quot;</span> &lt;&lt; YAML::Value &lt;&lt; rb2dComponent.FixedRotation;</span><br><span class="line"></span><br><span class="line">    out &lt;&lt; YAML::EndMap; <span class="comment">// Rigidbody2DComponent</span></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------</span><br><span class="line"><span class="keyword">auto</span> rigidbody2DComponent = entity[<span class="string">&quot;Rigidbody2DComponent&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (rigidbody2DComponent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; rb2d = deserializedEntity.<span class="built_in">AddComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">    rb2d.Type = <span class="built_in">RigidBody2DBodyTypeFromString</span>(rigidbody2DComponent[<span class="string">&quot;BodyType&quot;</span>].<span class="built_in">as</span>&lt;std::string&gt;());</span><br><span class="line">    rb2d.FixedRotation = rigidbody2DComponent[<span class="string">&quot;FixedRotation&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">bool</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>EditorLayer.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnScenePlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_SceneState = SceneState::Play;</span><br><span class="line">    m_ActiveScene-&gt;<span class="built_in">OnRuntimeStart</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnSceneStop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_SceneState = SceneState::Edit;</span><br><span class="line"></span><br><span class="line">    m_ActiveScene-&gt;<span class="built_in">OnRuntimeStop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="七十五、UUID唯一标识">七十五、UUID唯一标识</h2>
<h4 id="前言-15">前言</h4>
<ul>
<li>为了点击运行场景，实体发生位置等变化<strong>复原</strong>而要实现的标识功能,定义UUID类，使用cpp的随机函数，随机ID</li>
</ul>
<h4 id="代码-10">代码</h4>
<ul>
<li>
<p>定义好UUID类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> HEngine</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">UUID</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">UUID</span>();</span><br><span class="line">		<span class="built_in">UUID</span>(<span class="type">uint64_t</span> uuid);</span><br><span class="line">		<span class="built_in">UUID</span>(<span class="type">const</span> UUID&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">operator</span> <span class="title">uint64_t</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_UUID; &#125;</span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		<span class="type">uint64_t</span> m_UUID;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> std &#123;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">hash</span>&lt;HEngine::UUID&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">std::<span class="type">size_t</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> HEngine::UUID&amp; uuid)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">hash</span>&lt;<span class="type">uint64_t</span>&gt;()((<span class="type">uint64_t</span>)uuid);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UUID.cpp-------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> std::random_device s_RandomDevice;						</span><br><span class="line"><span class="function"><span class="type">static</span> std::mt19937_64 <span class="title">s_Engine</span><span class="params">(s_RandomDevice())</span></span>;			</span><br><span class="line"><span class="type">static</span> std::uniform_int_distribution&lt;<span class="type">uint64_t</span>&gt; s_UniformDistribution;</span><br><span class="line">UUID::<span class="built_in">UUID</span>()</span><br><span class="line">    : <span class="built_in">m_UUID</span>(<span class="built_in">s_UniformDistribution</span>(s_Engine))</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UUID::<span class="built_in">UUID</span>(<span class="type">uint64_t</span> uuid)</span><br><span class="line">    : <span class="built_in">m_UUID</span>(uuid)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>开始创建实体时候（CreateEntity）创建新的UUID，真正创建实体时（CreateEntityWithUUID）使用实参UUID</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Entity <span class="title">Scene::CreateEntity</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateEntityWithUUID</span>(<span class="built_in">UUID</span>(), name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HEngine::Entity <span class="title">Scene::CreateEntityWithUUID</span><span class="params">(UUID uuid, <span class="type">const</span> std::string&amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Entity entity = &#123; m_Registry.<span class="built_in">create</span>(), <span class="keyword">this</span> &#125;;</span><br><span class="line">    entity.<span class="built_in">AddComponent</span>&lt;IDComponent&gt;(uuid);</span><br><span class="line">    entity.<span class="built_in">AddComponent</span>&lt;TransformComponent&gt;();</span><br><span class="line">    <span class="keyword">auto</span>&amp; tag = entity.<span class="built_in">AddComponent</span>&lt;TagComponent&gt;();</span><br><span class="line">    tag.Tag = name.<span class="built_in">empty</span>() ? <span class="string">&quot;Entity&quot;</span> : name;</span><br><span class="line">    <span class="keyword">return</span> entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>序列化</strong>yaml-cpp文件时，读取实体的ID</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">SerializeEntity</span><span class="params">(YAML::Emitter&amp; out, Entity entity)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;IDComponent&gt;());</span><br><span class="line">    out &lt;&lt; YAML::BeginMap; <span class="comment">// Entity</span></span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Entity&quot;</span> &lt;&lt; YAML::Value &lt;&lt; entity.<span class="built_in">GetUUID</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十六、开始、结束、复制场景">七十六、开始、结束、复制场景</h2>
<h4 id="前言-16">前言</h4>
<ul>
<li>
<p>此节目的</p>
<ol>
<li>为实现点击运行，<strong>复制</strong>当前场景成为<strong>运行</strong>场景，点击结束<strong>销毁</strong>当前场景。</li>
<li>在当前场景<strong>复制</strong>实体</li>
</ol>
<p>最重要的如何复制场景，复制场景需要复制当前场景的所有实体及其包含的组件，但是当前的entt库不包含复制组件的API，所以我们需要<strong>手动写复制实体</strong>。</p>
</li>
</ul>
<h4 id="代码-11">代码</h4>
<ul>
<li>
<p>复制场景</p>
<ul>
<li>
<p>Editorlayer.cpp  点击运行，执行Scene的Copy函数复制当前的场景，并设置面板的上下文为新场景</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnScenePlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_SceneState = SceneState::Play;</span><br><span class="line"></span><br><span class="line">    m_ActiveScene = Scene::<span class="built_in">Copy</span>(m_EditorScene);</span><br><span class="line">    m_ActiveScene-&gt;<span class="built_in">OnRuntimeStart</span>(); </span><br><span class="line"></span><br><span class="line">    m_SceneHierarchyPanel.<span class="built_in">SetContext</span>(m_ActiveScene);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>执行Scene的Copy函数<strong>复制</strong>当前的场景</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Ref&lt;Scene&gt; <span class="title">Scene::Copy</span><span class="params">(Ref&lt;Scene&gt; other)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个新的 Scene 实例</span></span><br><span class="line">    Ref&lt;Scene&gt; newScene = <span class="built_in">CreateRef</span>&lt;Scene&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制视口宽度和高度</span></span><br><span class="line">    newScene-&gt;m_ViewportWidth = other-&gt;m_ViewportWidth;</span><br><span class="line">    newScene-&gt;m_ViewportHeight = other-&gt;m_ViewportHeight;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取源场景的实体注册表和新场景的实体注册表</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; srcSceneRegistry = other-&gt;m_Registry;</span><br><span class="line">    <span class="keyword">auto</span>&amp; dstSceneRegistry = newScene-&gt;m_Registry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用于存储 UUID 和新创建的 entt::entity 之间的映射关系</span></span><br><span class="line">    std::unordered_map&lt;UUID, entt::entity&gt; enttMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取源场景中所有具有 IDComponent 组件的实体视图</span></span><br><span class="line">    <span class="keyword">auto</span> idView = srcSceneRegistry.<span class="built_in">view</span>&lt;IDComponent&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 逆序遍历所有实体（保证实体创建的顺序与原场景一致）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = idView.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        entt::entity e = *(idView.<span class="built_in">begin</span>() + i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取实体的 UUID</span></span><br><span class="line">        UUID uuid = srcSceneRegistry.<span class="built_in">get</span>&lt;IDComponent&gt;(e).ID;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取实体的名称</span></span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span>&amp; name = srcSceneRegistry.<span class="built_in">get</span>&lt;TagComponent&gt;(e).Tag;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在新场景中创建一个具有相同 UUID 和名称的新实体</span></span><br><span class="line">        Entity newEntity = newScene-&gt;<span class="built_in">CreateEntityWithUUID</span>(uuid, name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将新创建的实体存入映射表，供后续组件复制使用</span></span><br><span class="line">        enttMap[uuid] = (entt::entity)newEntity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制组件（排除 IDComponent 和 TagComponent，因为它们已在实体创建时设置）</span></span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;TransformComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;SpriteRendererComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;CameraComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;NativeScriptComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;Rigidbody2DComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line">    <span class="built_in">CopyComponent</span>&lt;BoxCollider2DComponent&gt;(dstSceneRegistry, srcSceneRegistry, enttMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回复制后的新场景</span></span><br><span class="line">    <span class="keyword">return</span> newScene;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>复制实体</p>
<ul>
<li>
<p>Editorlayer. cpp 按下快捷键ctrl+d，执行OnDuplicateEntity函数，复制当前选择的实体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnDuplicateEntity</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_SceneState != SceneState::Edit)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    Entity selectedEntity = m_SceneHierarchyPanel.<span class="built_in">GetSelectedEntity</span>();</span><br><span class="line">    <span class="keyword">if</span> (selectedEntity)</span><br><span class="line">        m_EditorScene-&gt;<span class="built_in">DuplicateEntity</span>(selectedEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Scene的DuplicateEntity函数执行具体操作</p>
<ol>
<li>创建旧实体同名的新实体</li>
<li>复制组件</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::DuplicateEntity</span><span class="params">(Entity entity)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string name = entity.<span class="built_in">GetName</span>();  <span class="comment">// 获取原实体的名称</span></span><br><span class="line">    Entity newEntity = <span class="built_in">CreateEntity</span>(name); <span class="comment">// 创建一个新的实体，名称与原实体相同</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制所有可能存在的组件</span></span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;TransformComponent&gt;(newEntity, entity);</span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;SpriteRendererComponent&gt;(newEntity, entity);</span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;CameraComponent&gt;(newEntity, entity);</span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;NativeScriptComponent&gt;(newEntity, entity);</span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;Rigidbody2DComponent&gt;(newEntity, entity);</span><br><span class="line">    <span class="built_in">CopyComponentIfExists</span>&lt;BoxCollider2DComponent&gt;(newEntity, entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Component&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CopyComponentIfExists</span><span class="params">(Entity dst, Entity src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (src.<span class="built_in">HasComponent</span>&lt;Component&gt;()) <span class="comment">// 检查原实体是否拥有该组件</span></span><br><span class="line">        dst.<span class="built_in">AddOrReplaceComponent</span>&lt;Component&gt;(src.<span class="built_in">GetComponent</span>&lt;Component&gt;()); <span class="comment">// 复制组件到新实体</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function">T&amp; <span class="title">AddOrReplaceComponent</span><span class="params">(Args&amp;&amp;... args)</span><span class="comment">//接受按值传递的旧实体组件数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">/* emplace_or_replace&lt;T&gt;：</span></span><br><span class="line"><span class="comment">	如果 m_EntityHandle 之前没有该组件，则添加组件。</span></span><br><span class="line"><span class="comment">	如果 m_EntityHandle 已有该组件，则替换组件。 */</span></span><br><span class="line">      </span><br><span class="line">    T&amp; component = m_Scene-&gt;m_Registry.<span class="built_in">emplace_or_replace</span>&lt;T&gt;(m_EntityHandle, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    m_Scene-&gt;<span class="built_in">OnComponentAdded</span>&lt;T&gt;(*<span class="keyword">this</span>, component);</span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="七十七、成功绘制2D圆">七十七、成功绘制2D圆</h2>
<h4 id="前言-17">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>给引擎添加渲染Circle图形</p>
</li>
</ul>
<h4 id="代码-12">代码</h4>
<ul>
<li>
<p>circle的glsl</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type vertex</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">0</span>) in vec3 a_WorldPosition;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">1</span>) in vec3 a_LocalPosition;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">2</span>) in vec4 a_Color;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">3</span>) in <span class="type">float</span> a_Thickness;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">4</span>) in <span class="type">float</span> a_Fade;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">5</span>) in <span class="type">int</span> a_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span>(std140, binding = <span class="number">0</span>) uniform Camera</span><br><span class="line">&#123;</span><br><span class="line">	mat4 u_ViewProjection;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexOutput</span></span><br><span class="line">&#123;</span><br><span class="line">	vec3 LocalPosition;</span><br><span class="line">	vec4 Color;</span><br><span class="line">	<span class="type">float</span> Thickness;</span><br><span class="line">	<span class="type">float</span> Fade;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) out VertexOutput Output;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">4</span>) out flat <span class="type">int</span> v_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Output.LocalPosition = a_LocalPosition;</span><br><span class="line">	Output.Color = a_Color;</span><br><span class="line">	Output.Thickness = a_Thickness;</span><br><span class="line">	Output.Fade = a_Fade;</span><br><span class="line">	</span><br><span class="line">	v_EntityID = a_EntityID;</span><br><span class="line"></span><br><span class="line">	gl_Position = u_ViewProjection * <span class="built_in">vec4</span>(a_WorldPosition, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">0</span>) out vec4 o_Color;</span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">1</span>) out <span class="type">int</span> o_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexOutput</span></span><br><span class="line">&#123;</span><br><span class="line">	vec3 LocalPosition;</span><br><span class="line">	vec4 Color;</span><br><span class="line">	<span class="type">float</span> Thickness;</span><br><span class="line">	<span class="type">float</span> Fade;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in VertexOutput Input;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">4</span>) in flat <span class="type">int</span> v_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Calculate distance and fill circle with white</span></span><br><span class="line">	<span class="type">float</span> distance = <span class="number">1.0</span> - <span class="built_in">length</span>(Input.LocalPosition);</span><br><span class="line">	<span class="type">float</span> circle = <span class="built_in">smoothstep</span>(<span class="number">0.0</span>, Input.Fade, distance);</span><br><span class="line">	circle *= <span class="built_in">smoothstep</span>(Input.Thickness + Input.Fade, Input.Thickness, distance);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(circle == <span class="number">0.0f</span>)</span><br><span class="line">		discard;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Set ouput color</span></span><br><span class="line">	o_Color = Input.Color;</span><br><span class="line">	o_Color.a *= circle;</span><br><span class="line"></span><br><span class="line">	o_EntityID = v_EntityID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Renderer2D.cpp 批处理代码加上circle的顶点数组等信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">CircleVertex</span> &#123;</span><br><span class="line">    glm::vec3 WorldPosition;</span><br><span class="line">    glm::vec3 LocalPosition;</span><br><span class="line">    glm::vec4 Color;</span><br><span class="line">    <span class="type">float</span> Thickness;</span><br><span class="line">    <span class="type">float</span> Fade;</span><br><span class="line">    <span class="comment">// Editor-only;</span></span><br><span class="line">    <span class="type">int</span> EntityID;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Renderer2DData</span></span><br><span class="line">&#123;</span><br><span class="line">    Ref&lt;VertexArray&gt; CircleVertexArray;</span><br><span class="line">    Ref&lt;VertexBuffer&gt; CircleVertexBuffer;</span><br><span class="line">    Ref&lt;Shader&gt; CircleShader;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> CircleIndexCount = <span class="number">0</span>;</span><br><span class="line">    CircleVertex* CircleVertexBufferBase = <span class="literal">nullptr</span>;</span><br><span class="line">    CircleVertex* CircleVertexBufferPtr = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Circles</span></span><br><span class="line">    s_Data.CircleVertexArray = VertexArray::<span class="built_in">Create</span>();</span><br><span class="line"></span><br><span class="line">    s_Data.CircleVertexBuffer = VertexBuffer::<span class="built_in">Create</span>(s_Data.MaxVertices * <span class="built_in">sizeof</span>(CircleVertex));</span><br><span class="line">    s_Data.CircleVertexBuffer-&gt;<span class="built_in">SetLayout</span>(&#123;</span><br><span class="line">        &#123; ShaderDataType::Float3,		<span class="string">&quot;a_WorldPosition&quot;</span> &#125;,</span><br><span class="line">        &#123; ShaderDataType::Float3,		<span class="string">&quot;a_LocalPosition&quot;</span>	&#125;,</span><br><span class="line">        &#123; ShaderDataType::Float4,		<span class="string">&quot;a_Color&quot;</span>				&#125;,</span><br><span class="line">        &#123; ShaderDataType::Float,		<span class="string">&quot;a_Thickness&quot;</span>		&#125;,</span><br><span class="line">        &#123; ShaderDataType::Float,		<span class="string">&quot;a_Fade&quot;</span>				&#125;,</span><br><span class="line">        &#123; ShaderDataType::Int,			<span class="string">&quot;a_EntityID&quot;</span>			&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    s_Data.CircleVertexArray-&gt;<span class="built_in">AddVertexBuffer</span>(s_Data.CircleVertexBuffer);</span><br><span class="line">    s_Data.CircleVertexArray-&gt;<span class="built_in">SetIndexBuffer</span>(quadIB);	<span class="comment">//Use quad IB</span></span><br><span class="line">    s_Data.CircleVertexBufferBase = <span class="keyword">new</span> CircleVertex[s_Data.MaxVertices];</span><br><span class="line">    </span><br><span class="line">    s_Data.CircleShader = Shader::<span class="built_in">Create</span>(<span class="string">&quot;assets/shaders/Renderer2D_Circle.glsl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::StartBatch</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_Data.CircleIndexCount = <span class="number">0</span>;</span><br><span class="line">    s_Data.CircleVertexBufferPtr = s_Data.CircleVertexBufferBase;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Flush</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s_Data.CircleIndexCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint32_t</span> dataSize = (<span class="type">uint32_t</span>)((<span class="type">uint8_t</span>*)s_Data.CircleVertexBufferPtr - (<span class="type">uint8_t</span>*)s_Data.CircleVertexBufferBase);</span><br><span class="line">        s_Data.CircleVertexBuffer-&gt;<span class="built_in">SetData</span>(s_Data.CircleVertexBufferBase, dataSize);</span><br><span class="line"></span><br><span class="line">        s_Data.CircleShader-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">        RenderCommand::<span class="built_in">DrawIndexed</span>(s_Data.CircleVertexArray, s_Data.CircleIndexCount);</span><br><span class="line">        s_Data.Stats.DrawCalls++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawCircle</span><span class="params">(<span class="type">const</span> glm::mat4&amp; transform, <span class="type">const</span> glm::vec4&amp; color, <span class="type">float</span> thickness, <span class="type">float</span> fade, <span class="type">int</span> entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;WorldPosition = transform * s_Data.QuadVertexPositions[i];</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;LocalPosition = s_Data.QuadVertexPositions[i] * <span class="number">2.0f</span>;</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;Color = color;</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;Thickness = thickness;</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;Fade = fade;</span><br><span class="line">        s_Data.CircleVertexBufferPtr-&gt;EntityID = entityID;</span><br><span class="line">        s_Data.CircleVertexBufferPtr++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s_Data.CircleIndexCount += <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    s_Data.Stats.QuadCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Components.h  添加Circle组件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">CircleRendererComponent</span> &#123;</span><br><span class="line">    glm::vec4 Color&#123; <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span> &#125;;</span><br><span class="line">    <span class="type">float</span> Thickness = <span class="number">1.0f</span>;</span><br><span class="line">    <span class="type">float</span> Fade = <span class="number">0.005f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CircleRendererComponent</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">CircleRendererComponent</span>(<span class="type">const</span> CircleRendererComponent&amp;) = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Scene.cpp  扫描当前场景有<strong>Circle</strong>的组件，遍历然后调用draw绘制</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::OnUpdateEditor</span><span class="params">(Timestep ts, EditorCamera&amp; camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Draw circles</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> view = m_Registry.<span class="built_in">view</span>&lt;TransformComponent, CircleRendererComponent&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> entity : view)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> [transform, circle] = view.<span class="built_in">get</span>&lt;TransformComponent, CircleRendererComponent&gt;(entity);</span><br><span class="line"></span><br><span class="line">            Renderer2D::<span class="built_in">DrawCircle</span>(transform.<span class="built_in">GetTransform</span>(), circle.Color, circle.Thickness, circle.Fade, (<span class="type">int</span>)entity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SceneSerializer.cpp 添加circle的序列化</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (entity.<span class="built_in">HasComponent</span>&lt;CircleRendererComponent&gt;())</span><br><span class="line">&#123;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;CircleRendererComponent&quot;</span>;</span><br><span class="line">    out &lt;&lt; YAML::BeginMap; <span class="comment">// CircleRendererComponent</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; circleRendererComponent = entity.<span class="built_in">GetComponent</span>&lt;CircleRendererComponent&gt;();</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Color&quot;</span> &lt;&lt; YAML::Value &lt;&lt; circleRendererComponent.Color;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Thickness&quot;</span> &lt;&lt; YAML::Value &lt;&lt; circleRendererComponent.Thickness;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Fade&quot;</span> &lt;&lt; YAML::Value &lt;&lt; circleRendererComponent.Fade;</span><br><span class="line"></span><br><span class="line">    out &lt;&lt; YAML::EndMap; <span class="comment">// CircleRendererComponent</span></span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"><span class="keyword">auto</span> circleRendererComponent = entity[<span class="string">&quot;CircleRendererComponent&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (circleRendererComponent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; crc = deserializedEntity.<span class="built_in">AddComponent</span>&lt;CircleRendererComponent&gt;();</span><br><span class="line">    crc.Color = circleRendererComponent[<span class="string">&quot;Color&quot;</span>].<span class="built_in">as</span>&lt;glm::vec4&gt;();</span><br><span class="line">    crc.Thickness = circleRendererComponent[<span class="string">&quot;Thickness&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">    crc.Fade = circleRendererComponent[<span class="string">&quot;Fade&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SceneHierarchyPanel.cpp 组件添加Circle</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SceneHierarchyPanel::DrawComponents</span><span class="params">(Entity entity)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_SelectionContext.<span class="built_in">HasComponent</span>&lt;CircleRendererComponent&gt;())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ImGui::<span class="built_in">MenuItem</span>(<span class="string">&quot;Circle Renderer&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            m_SelectionContext.<span class="built_in">AddComponent</span>&lt;CircleRendererComponent&gt;();</span><br><span class="line">            ImGui::<span class="built_in">CloseCurrentPopup</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">DrawComponent</span>&lt;CircleRendererComponent&gt;(<span class="string">&quot;Circle Renderer&quot;</span>, entity, [](<span class="keyword">auto</span>&amp; component)</span><br><span class="line">    &#123;</span><br><span class="line">        ImGui::<span class="built_in">ColorEdit4</span>(<span class="string">&quot;Color&quot;</span>, glm::<span class="built_in">value_ptr</span>(component.Color));</span><br><span class="line">        ImGui::<span class="built_in">DragFloat</span>(<span class="string">&quot;Thickness&quot;</span>, &amp;component.Thickness, <span class="number">0.025f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        ImGui::<span class="built_in">DragFloat</span>(<span class="string">&quot;Fade&quot;</span>, &amp;component.Fade, <span class="number">0.00025f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十八、添加线段和矩形渲染">七十八、添加线段和矩形渲染</h2>
<h4 id="前言-18">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>要给当前引擎添加能渲染<strong>线条</strong>、<strong>方框</strong>功能。渲染方框是在渲染线条的基础上实现的</p>
</li>
</ul>
<h4 id="代码-13">代码</h4>
<ul>
<li>
<p>新增Renderer2D_Line.glsl</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#type vertex</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> <span class="type">vec3</span> a_Position;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="type">vec4</span> a_Color;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">2</span>) <span class="keyword">in</span> <span class="type">int</span> a_EntityID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">std140</span>, <span class="keyword">binding</span> = <span class="number">0</span>) <span class="keyword">uniform</span> Camera</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">mat4</span> u_ViewProjection;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct VertexOutput</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">vec4</span> Color;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> VertexOutput Output;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">out</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">	Output.Color = a_Color;</span><br><span class="line">	</span><br><span class="line">	v_EntityID = a_EntityID;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">gl_Position</span> = u_ViewProjection * <span class="type">vec4</span>(a_Position, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#type fragment</span></span><br><span class="line"><span class="meta">#version 450 core</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">out</span> <span class="type">vec4</span> o_Color;</span><br><span class="line"><span class="keyword">layout</span>(<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">out</span> <span class="type">int</span> o_EntityID;</span><br><span class="line"></span><br><span class="line">struct VertexOutput</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">vec4</span> Color;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">0</span>) <span class="keyword">in</span> VertexOutput Input;</span><br><span class="line"><span class="keyword">layout</span> (<span class="keyword">location</span> = <span class="number">1</span>) <span class="keyword">in</span> <span class="keyword">flat</span> <span class="type">int</span> v_EntityID;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> main()</span><br><span class="line">&#123;</span><br><span class="line">	o_Color = Input.Color;</span><br><span class="line">	o_EntityID = v_EntityID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>OpenGLRendererAPI.cpp 实际绘制Line的opengl代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpenGLRendererAPI::DrawLines</span><span class="params">(<span class="type">const</span> Ref&lt;VertexArray&gt;&amp; vertexArray, <span class="type">uint32_t</span> vertexCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vertexArray-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">    <span class="built_in">glDrawArrays</span>(GL_LINES, <span class="number">0</span>, vertexCount);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpenGLRendererAPI::SetLineWidth</span><span class="params">(<span class="type">float</span> width)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glLineWidth</span>(width);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Renderer2D.cpp 批处理代码加上line的顶点数组等信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">LineVertex</span> &#123;</span><br><span class="line">    glm::vec3 Position;</span><br><span class="line">    glm::vec4 Color;</span><br><span class="line">    <span class="type">int</span> EntityID;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Ref&lt;VertexArray&gt; LineVertexArray;</span><br><span class="line">Ref&lt;VertexBuffer&gt; LineVertexBuffer;</span><br><span class="line">Ref&lt;Shader&gt; LineShader;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> LineVertexCount = <span class="number">0</span>;<span class="comment">// 只需要提供顶点数量</span></span><br><span class="line">LineVertex* LineVertexBufferBase = <span class="literal">nullptr</span>;</span><br><span class="line">LineVertex* LineVertexBufferPtr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0.在CPU开辟存储s_Data.MaxVertices个的LineVertex的内存</span></span><br><span class="line">s_Data.LineVertexBufferBase = <span class="keyword">new</span> LineVertex[s_Data.MaxVertices];</span><br><span class="line"><span class="comment">// 1.创建顶点数组</span></span><br><span class="line">s_Data.LineVertexArray = VertexArray::<span class="built_in">Create</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建顶点缓冲区</span></span><br><span class="line">s_Data.LineVertexBuffer = VertexBuffer::<span class="built_in">Create</span>(s_Data.MaxVertices * <span class="built_in">sizeof</span>(LineVertex));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1设置顶点缓冲区布局</span></span><br><span class="line">s_Data.LineVertexBuffer-&gt;<span class="built_in">SetLayout</span>(&#123;</span><br><span class="line">    &#123;ShaderDataType::Float3, <span class="string">&quot;a_Position&quot;</span>&#125;,</span><br><span class="line">    &#123;ShaderDataType::Float4, <span class="string">&quot;a_Color&quot;</span>&#125;,</span><br><span class="line">    &#123;ShaderDataType::Int, <span class="string">&quot;a_EntityID&quot;</span>&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.1设置顶点数组使用的缓冲区，并且在这个缓冲区中设置布局</span></span><br><span class="line">s_Data.LineVertexArray-&gt;<span class="built_in">AddVertexBuffer</span>(s_Data.LineVertexBuffer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.索引缓冲-Line不需要索引缓冲区</span></span><br><span class="line">s_Data.LineShader = Shader::<span class="built_in">Create</span>(<span class="string">&quot;assets/shaders/Renderer2D_Line.glsl&quot;</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Flush</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s_Data.LineVertexCount) &#123;</span><br><span class="line">        <span class="comment">// 计算当前绘制需要多少个顶点数据</span></span><br><span class="line">        <span class="type">uint32_t</span> dataSize = (<span class="type">uint8_t</span>*)s_Data.LineVertexBufferPtr - (<span class="type">uint8_t</span>*)s_Data.LineVertexBufferBase;</span><br><span class="line">        <span class="comment">// 截取部分CPU的顶点数据上传OpenGL</span></span><br><span class="line">        s_Data.LineVertexBuffer-&gt;<span class="built_in">SetData</span>(s_Data.LineVertexBufferBase, dataSize);</span><br><span class="line"></span><br><span class="line">        s_Data.LineShader-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">        <span class="comment">// 新增的：设置线条宽度</span></span><br><span class="line">        RenderCommand::<span class="built_in">SetLineWidth</span>(s_Data.LineWidth);</span><br><span class="line">        <span class="comment">// 调用绘画命令</span></span><br><span class="line">        RenderCommand::<span class="built_in">DrawLines</span>(s_Data.LineVertexArray, s_Data.LineVertexCount);</span><br><span class="line">        s_Data.Stats.DrawCalls++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawLine</span><span class="params">(<span class="type">const</span> glm::vec3&amp; p0, glm::vec3&amp; p1, <span class="type">const</span> glm::vec4&amp; color, <span class="type">int</span> entityID)</span></span>&#123;</span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;Position = p0;</span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;Color = color;</span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;EntityID = entityID;</span><br><span class="line">    s_Data.LineVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;Position = p1;</span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;Color = color;</span><br><span class="line">    s_Data.LineVertexBufferPtr-&gt;EntityID = entityID;</span><br><span class="line">    s_Data.LineVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">    s_Data.LineVertexCount += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据一点中心位置确定4个点的位置绘制rect</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawRect</span><span class="params">(<span class="type">const</span> glm::vec3&amp; position, <span class="type">const</span> glm::vec2&amp; size, <span class="type">const</span> glm::vec4&amp; color, <span class="type">int</span> entityID)</span></span>&#123;</span><br><span class="line">    <span class="comment">// position是中心位置</span></span><br><span class="line">    glm::vec3 p0 = glm::<span class="built_in">vec3</span>(position.x - size.x * <span class="number">0.5f</span>, position.y - size.y * <span class="number">0.5f</span>, position.z);<span class="comment">// 左下角</span></span><br><span class="line">    glm::vec3 p1 = glm::<span class="built_in">vec3</span>(position.x + size.x * <span class="number">0.5f</span>, position.y - size.y * <span class="number">0.5f</span>, position.z);<span class="comment">// 右下角</span></span><br><span class="line">    glm::vec3 p2 = glm::<span class="built_in">vec3</span>(position.x + size.x * <span class="number">0.5f</span>, position.y + size.y * <span class="number">0.5f</span>, position.z);<span class="comment">// 右上角</span></span><br><span class="line">    glm::vec3 p3 = glm::<span class="built_in">vec3</span>(position.x - size.x * <span class="number">0.5f</span>, position.y + size.y * <span class="number">0.5f</span>, position.z);<span class="comment">// 左上角</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">DrawLine</span>(p0, p1, color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(p1, p2, color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(p2, p3, color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(p3, p0, color);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据实体的transform确定顶点位置再绘制</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawRect</span><span class="params">(<span class="type">const</span> glm::mat4&amp; transform, <span class="type">const</span> glm::vec4&amp; color, <span class="type">int</span> entityID)</span></span>&#123;</span><br><span class="line">    glm::vec3 lineVertices[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lineVertices[i] = transform * s_Data.QuadVertexPosition[i]; <span class="comment">// quad的顶点位置正好是rect的顶点位置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DrawLine</span>(lineVertices[<span class="number">0</span>], lineVertices[<span class="number">1</span>], color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(lineVertices[<span class="number">1</span>], lineVertices[<span class="number">2</span>], color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(lineVertices[<span class="number">2</span>], lineVertices[<span class="number">3</span>], color);</span><br><span class="line">    <span class="built_in">DrawLine</span>(lineVertices[<span class="number">3</span>], lineVertices[<span class="number">0</span>], color);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Scene.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::OnUpdateEditor</span><span class="params">(Timestep ts, EditorCamera&amp; camera)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Renderer2D::<span class="built_in">BeginScene</span>(camera);</span><br><span class="line">    Renderer2D::<span class="built_in">DrawLine</span>(glm::<span class="built_in">vec3</span>(<span class="number">2.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">5.0f</span>), glm::<span class="built_in">vec4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    Renderer2D::<span class="built_in">DrawRect</span>(glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>), glm::<span class="built_in">vec3</span>(<span class="number">1.0f</span>), glm::<span class="built_in">vec4</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    Renderer2D::<span class="built_in">EndScene</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="七十九、添加圆形组件和物理">七十九、添加圆形组件和物理</h2>
<h4 id="前言-19">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>添加圆形组件,设置圆形组件的属性面板,在编辑场景显示实体物理组件的包围盒</p>
</li>
</ul>
<h4 id="代码-14">代码</h4>
<ul>
<li>
<p>Components.h 设置圆形包围盒组件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Circle包围盒</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CircleCollider2DComponent</span> &#123;</span><br><span class="line">    glm::vec2 Offset = &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span> &#125;;</span><br><span class="line">    <span class="type">float</span> Radius = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span>移到物理材质</span></span><br><span class="line">    <span class="type">float</span> Density = <span class="number">1.0f</span>;           <span class="comment">// 密度,0是静态的物理</span></span><br><span class="line">    <span class="type">float</span> Friction = <span class="number">0.5f</span>;          <span class="comment">// 摩擦力</span></span><br><span class="line">    <span class="type">float</span> Restitution = <span class="number">0.0f</span>;       <span class="comment">// 弹力，0不会弹跳，1无限弹跳</span></span><br><span class="line">    <span class="type">float</span> RestitutionThreshold = <span class="number">0.5f</span>;<span class="comment">// 复原速度阈值，超过这个速度的碰撞就会被恢复原状（会反弹）。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 运行时候由于物理，每一帧的上述参数可能会变，所以保存为对象,但未使用</span></span><br><span class="line">    <span class="type">void</span>* RuntimeFixture = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CircleCollider2DComponent</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">CircleCollider2DComponent</span>(<span class="type">const</span> CircleCollider2DComponent&amp;) = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>PhysicsManager.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PhysicsManager::AttachCircleCollider</span><span class="params">(Scene* scene, entt::entity e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Entity entity = &#123; e, scene &#125;;</span><br><span class="line">    <span class="keyword">auto</span>&amp; transform = entity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;();</span><br><span class="line">    <span class="keyword">auto</span>&amp; cc2d = entity.<span class="built_in">GetComponent</span>&lt;CircleCollider2DComponent&gt;();</span><br><span class="line">    <span class="keyword">auto</span>&amp; rb2d = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">b2Body_IsValid</span>(rb2d.RuntimeBodyId)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    b2Circle circleShape;</span><br><span class="line">    circleShape.center = &#123; cc2d.Offset.x, cc2d.Offset.y &#125;;</span><br><span class="line">    circleShape.radius = cc2d.Radius;</span><br><span class="line"></span><br><span class="line">    b2ShapeDef shapeDef = <span class="built_in">b2DefaultShapeDef</span>();</span><br><span class="line">    shapeDef.friction = cc2d.Friction;</span><br><span class="line">    shapeDef.density = cc2d.Density;</span><br><span class="line">    shapeDef.restitution = cc2d.Restitution;</span><br><span class="line"></span><br><span class="line">    b2ShapeId shapeID = <span class="built_in">b2CreateCircleShape</span>(rb2d.RuntimeBodyId, &amp;shapeDef, &amp;circleShape);</span><br><span class="line">    cc2d.RuntimeShapeId = shapeID;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(<span class="built_in">b2Shape_IsValid</span>(cc2d.RuntimeShapeId), <span class="string">&quot;Circle Shape id validation failed.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Scene.cpp 在属性面板显示圆形包围盒组件代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!m_SelectionContext.<span class="built_in">HasComponent</span>&lt;CircleCollider2DComponent&gt;())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">MenuItem</span>(<span class="string">&quot;Circle Collider 2D&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        m_SelectionContext.<span class="built_in">AddComponent</span>&lt;CircleCollider2DComponent&gt;();</span><br><span class="line">        ImGui::<span class="built_in">CloseCurrentPopup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">DrawComponent</span>&lt;CircleRendererComponent&gt;(<span class="string">&quot;Circle Renderer&quot;</span>, entity, [](<span class="keyword">auto</span>&amp; component)</span><br><span class="line">&#123;</span><br><span class="line">    ImGui::<span class="built_in">ColorEdit4</span>(<span class="string">&quot;Color&quot;</span>, glm::<span class="built_in">value_ptr</span>(component.Color));</span><br><span class="line">    ImGui::<span class="built_in">DragFloat</span>(<span class="string">&quot;Thickness&quot;</span>, &amp;component.Thickness, <span class="number">0.025f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    ImGui::<span class="built_in">DragFloat</span>(<span class="string">&quot;Fade&quot;</span>, &amp;component.Fade, <span class="number">0.00025f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>场景yaml文件需序列化保存和解析包围盒组件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (entity.<span class="built_in">HasComponent</span>&lt;CircleCollider2DComponent&gt;())</span><br><span class="line">&#123;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;CircleCollider2DComponent&quot;</span>;</span><br><span class="line">    out &lt;&lt; YAML::BeginMap; <span class="comment">// CircleCollider2DComponent</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; cc2dComponent = entity.<span class="built_in">GetComponent</span>&lt;CircleCollider2DComponent&gt;();</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Offset&quot;</span> &lt;&lt; YAML::Value &lt;&lt; cc2dComponent.Offset;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Radius&quot;</span> &lt;&lt; YAML::Value &lt;&lt; cc2dComponent.Radius;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Density&quot;</span> &lt;&lt; YAML::Value &lt;&lt; cc2dComponent.Density;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Friction&quot;</span> &lt;&lt; YAML::Value &lt;&lt; cc2dComponent.Friction;</span><br><span class="line">    out &lt;&lt; YAML::Key &lt;&lt; <span class="string">&quot;Restitution&quot;</span> &lt;&lt; YAML::Value &lt;&lt; cc2dComponent.Restitution;</span><br><span class="line">    out &lt;&lt; YAML::EndMap; <span class="comment">// CircleCollider2DComponent</span></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"><span class="keyword">auto</span> circleCollider2DComponent = entity[<span class="string">&quot;CircleCollider2DComponent&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (circleCollider2DComponent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; cc2d = deserializedEntity.<span class="built_in">AddComponent</span>&lt;CircleCollider2DComponent&gt;();</span><br><span class="line">    cc2d.Offset = boxCollider2DComponent[<span class="string">&quot;Offset&quot;</span>].<span class="built_in">as</span>&lt;glm::vec2&gt;();</span><br><span class="line">    cc2d.Radius = boxCollider2DComponent[<span class="string">&quot;Radius&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">    cc2d.Density = boxCollider2DComponent[<span class="string">&quot;Density&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">    cc2d.Friction = boxCollider2DComponent[<span class="string">&quot;Friction&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">    cc2d.Restitution = boxCollider2DComponent[<span class="string">&quot;Restitution&quot;</span>].<span class="built_in">as</span>&lt;<span class="type">float</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十、-可视化物理包围盒">八十、 可视化物理包围盒</h2>
<h4 id="前言-20">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>实现一个复选框点击后，场景可以<strong>渲染出图形相应的包围盒</strong>，使用上两节加的渲染<strong>Line</strong>和<strong>Rect</strong>来渲染盒状包围盒。，至于圆的包围盒，一样绘制圆，只不过控制<strong>厚度</strong>，从而实现<strong>圆环</strong>形状=圆包围盒</p>
</li>
</ul>
<h4 id="代码-15">代码</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnOverlayRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_SceneState == SceneState::Play) </span><br><span class="line">    &#123;</span><br><span class="line">        Entity camera = m_ActiveScene-&gt;<span class="built_in">GetPrimaryCameraEntity</span>();</span><br><span class="line">        <span class="comment">// Caemra类没有视图矩阵，所以需传入transform计算视图矩阵</span></span><br><span class="line">        Renderer2D::<span class="built_in">BeginScene</span>(camera.<span class="built_in">GetComponent</span>&lt;CameraComponent&gt;().camera, camera.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;().<span class="built_in">GetTransform</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// EditorCamera，可以直接获取投影视图矩阵，所以不需要transform</span></span><br><span class="line">        Renderer2D::<span class="built_in">BeginScene</span>(m_EditorCamera);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_ShowPhysicsColliders) <span class="comment">// 由复选框控制</span></span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> view = m_ActiveScene-&gt;<span class="built_in">GetAllEntitiesWith</span>&lt;TransformComponent, BoxCollider2DComponent&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> entity : view) &#123;</span><br><span class="line">                <span class="keyword">auto</span> [tc, bc2d] = view.<span class="built_in">get</span>&lt;TransformComponent, BoxCollider2DComponent&gt;(entity);</span><br><span class="line">                <span class="comment">// 0.001fZ轴偏移量</span></span><br><span class="line">                glm::vec3 translation = tc.Translation + glm::<span class="built_in">vec3</span>(bc2d.Offset, <span class="number">0.001f</span>);</span><br><span class="line">                glm::vec3 scale = tc.Scale * glm::<span class="built_in">vec3</span>(bc2d.Size * <span class="number">2.0f</span>, <span class="number">1.0f</span>); </span><br><span class="line"></span><br><span class="line">                glm::mat4 transform = glm::<span class="built_in">translate</span>(glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), translation)</span><br><span class="line">                * glm::<span class="built_in">rotate</span>(glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), tc.Rotation.z, glm::<span class="built_in">vec3</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>))          * glm::<span class="built_in">scale</span>(glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), scale);</span><br><span class="line"></span><br><span class="line">                Renderer2D::<span class="built_in">DrawRect</span>(transform, glm::<span class="built_in">vec4</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>));<span class="comment">// 绿色的包围盒</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    	<span class="comment">//Circle Colliders</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> view = m_ActiveScene-&gt;<span class="built_in">GetAllEntitiesWith</span>&lt;TransformComponent, CircleCollider2DComponent&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> entity : view)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> [tc, cc2d] = view.<span class="built_in">get</span>&lt;TransformComponent, CircleCollider2DComponent&gt;(entity);</span><br><span class="line"></span><br><span class="line">                glm::vec3 translation = tc.Translation + glm::<span class="built_in">vec3</span>(cc2d.Offset, <span class="number">0.001f</span>);</span><br><span class="line">                glm::vec3 scale = tc.Scale * glm::<span class="built_in">vec3</span>(cc2d.Radius * <span class="number">2.0f</span>);</span><br><span class="line"></span><br><span class="line">                glm::mat4 transform = glm::<span class="built_in">translate</span>(glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), translation)</span><br><span class="line">                    * glm::<span class="built_in">scale</span>(glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), scale);</span><br><span class="line"></span><br><span class="line">                Renderer2D::<span class="built_in">DrawCircle</span>(transform, glm::<span class="built_in">vec4</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>), <span class="number">0.01f</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="八十一、添加模拟运行按钮">八十一、添加模拟运行按钮</h2>
<h4 id="前言-21">前言</h4>
<ul>
<li>
<p>此节目的</p>
<ul>
<li>
<p><strong>增加</strong>一个物理模拟运行模式，来运行给物体添加的物理效果，<strong>摄像机却使用编辑模式下的摄像机</strong>。</p>
</li>
<li>
<p><strong>区分</strong>Play运行模式的物理效果</p>
<p>这个模式的摄像机会变成场景里的<strong>主摄像机</strong>，而不是当前的<strong>编辑相机</strong></p>
</li>
</ul>
</li>
</ul>
<h4 id="代码-16">代码</h4>
<ul>
<li>
<p>Scene.cpp</p>
</li>
<li>
<pre><code class="language-c++">void Scene::OnSimulationStart()
&#123;
    OnPhysics2DStart();
&#125;

void Scene::OnSimulationStop()
&#123;
    OnPhysics2DStop();
&#125;
void Scene::OnPhysics2DStart()
&#123;
    PhysicsManager::Get().CreateWorld();

    auto view = m_Registry.view&lt;Rigidbody2DComponent&gt;();
    for (auto e : view)
    &#123;
        PhysicsManager::Get().AddRigibody(this, e);
    &#125;
&#125;

void Scene::OnPhysics2DStop()
&#123;
    PhysicsManager::Get().DestoryWorld();
&#125;
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- EditorLayer.cpp</span><br><span class="line"></span><br><span class="line">  ```cpp</span><br><span class="line">  <span class="keyword">void</span> <span class="title class_">EditorLayer</span>::<span class="title function_ invoke__">OnSceneSimulate</span>()<span class="comment">// 开始物理模拟模式</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> (m_SceneState == <span class="title class_">SceneState</span>::<span class="variable constant_">Play</span>) &#123;</span><br><span class="line">          <span class="title function_ invoke__">OnSceneStop</span>(); <span class="comment">// 停止物理</span></span><br><span class="line">      &#125;</span><br><span class="line">      m_SceneState = <span class="title class_">SceneState</span>::<span class="variable constant_">Simulate</span>;</span><br><span class="line">  </span><br><span class="line">      m_ActiveScene = <span class="title class_">Scene</span>::<span class="title function_ invoke__">Copy</span>(m_EditorScene);</span><br><span class="line">      m_ActiveScene-&gt;<span class="title function_ invoke__">OnSimulationStart</span>(); </span><br><span class="line">      m_SceneHierarchyPanel.<span class="title function_ invoke__">SetContext</span>(m_ActiveScene);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
<hr>
<h2 id="八十二、Mono实现C-脚本">八十二、Mono实现C#脚本</h2>
<h4 id="前言-22">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>HEngine实现能cpp能调用C#的函数（C#语言嵌入cpp中），需要安装mono.Net库，并克隆git上的mono项目自己构建导出mono库。</p>
<p>即：<strong>需要.Net库和构建的mono库</strong>,用visual studio<strong>构建mono项目导出mono静态库</strong>，静态链接</p>
</li>
</ul>
<h4 id="Mono配置步骤：">Mono配置步骤：</h4>
<p>1.安装mono.Net库,<a target="_blank" rel="noopener" href="https://www.mono-project.com/download/stable/">网址</a></p>
<p>2.克隆mono开源项目</p>
<ul>
<li>
<p>克隆mono开源项目</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">--recursive</span> https://github.com/mono/mono</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>3.生成静态库</p>
<ul>
<li>
<p>打开mono开源项目下的sln文件</p>
</li>
<li>
<p>打开后对libmono-static<strong>单个项目</strong>进行生成, 生成libmono-static-sgen.lib文件（函数的定义）</p>
<p>注意选择：debug 64和release 64 各自生成一次</p>
</li>
<li>
<p>Mono安装目录下<strong>include</strong>的文件夹有 libmono-static-sgen.lib文件中函数定义的<strong>头文件</strong>（函数声明）</p>
</li>
</ul>
<p>4.移动生成的库文件与inlcude文件</p>
<ul>
<li>
<p>1.将include/mono文件夹放入引擎下的vendor/mono/include下（函数声明）</p>
</li>
<li>
<p>2.拷贝生成的mono库文件到vender/mono下（函数定义）</p>
</li>
</ul>
<p>5.移动Mono安装目录里的.Net库文件</p>
<p>​	到mono安装目录mono\lib\mono下，找到4.5版本的文件夹移动到HEngine-Editor\mono\lib\mono\4.5下</p>
<h4 id="代码-17">代码</h4>
<ul>
<li>
<p>新建项目HEngine-ScriptCore</p>
</li>
<li>
<p>添加Main.cs文件</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">HEngine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Main</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> FloatVar &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Main constructor!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Hello World from C#!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintInt</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;C# says: <span class="subst">&#123;<span class="keyword">value</span>&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintInts</span>(<span class="params"><span class="built_in">int</span> value1, <span class="built_in">int</span> value2</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;C# says: <span class="subst">&#123;value1&#125;</span> and <span class="subst">&#123;value2&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintCustomMessage</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;C# says: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>新建ScriptEngine类  写好初始化mono环境，加载C#项目生成的 dll</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> HEngine &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">ScriptEngineData</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//Mono 运行时的根域，所有的 AppDomain 都运行在它之上</span></span><br><span class="line">		MonoDomain* RootDomain = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//用于 C# 脚本执行的独立 应用域</span></span><br><span class="line">		MonoDomain* AppDomain = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="comment">//加载的 C# DLL（HEngine-ScriptCore.dll），包含用户的 C# 代码</span></span><br><span class="line">		MonoAssembly* CoreAssembly = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> ScriptEngineData* s_Data = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ScriptEngine::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		s_Data = <span class="keyword">new</span> <span class="built_in">ScriptEngineData</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">InitMono</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ScriptEngine::Shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">ShutdownMono</span>();</span><br><span class="line">		<span class="keyword">delete</span> s_Data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">char</span>* <span class="title">ReadBytes</span><span class="params">(<span class="type">const</span> std::string&amp; filepath, <span class="type">uint32_t</span>* outSize)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="function">std::ifstream <span class="title">stream</span><span class="params">(filepath, std::ios::binary | std::ios::ate)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!stream)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Failed to open the file</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		std::streampos end = stream.<span class="built_in">tellg</span>();</span><br><span class="line">		stream.<span class="built_in">seekg</span>(<span class="number">0</span>, std::ios::beg);</span><br><span class="line">		<span class="type">uint32_t</span> size = end - stream.<span class="built_in">tellg</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// File is empty</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">char</span>* buffer = <span class="keyword">new</span> <span class="type">char</span>[size];</span><br><span class="line">		stream.<span class="built_in">read</span>((<span class="type">char</span>*)buffer, size);</span><br><span class="line">		stream.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">		*outSize = size;</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">MonoAssembly* <span class="title">LoadCSharpAssembly</span><span class="params">(<span class="type">const</span> std::string&amp; assemblyPath)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="type">uint32_t</span> fileSize = <span class="number">0</span>;</span><br><span class="line">		<span class="type">char</span>* fileData = <span class="built_in">ReadBytes</span>(assemblyPath, &amp;fileSize);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建 MonoImage（DLL 映像），用于加载程序集。</span></span><br><span class="line">		MonoImageOpenStatus status;</span><br><span class="line">		MonoImage* image = <span class="built_in">mono_image_open_from_data_full</span>(fileData, fileSize, <span class="number">1</span>, &amp;status, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (status != MONO_IMAGE_OK)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> <span class="type">char</span>* errorMessage = <span class="built_in">mono_image_strerror</span>(status);</span><br><span class="line">			<span class="comment">// Log some error message using the errorMessage data</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//加载程序集（DLL）到 Mono 运行时</span></span><br><span class="line">		MonoAssembly* assembly = <span class="built_in">mono_assembly_load_from_full</span>(image, assemblyPath.<span class="built_in">c_str</span>(), &amp;status, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">mono_image_close</span>(image);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don&#x27;t forget to free the file data</span></span><br><span class="line">		<span class="keyword">delete</span>[] fileData;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> assembly;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">PrintAssemblyTypes</span><span class="params">(MonoAssembly* assembly)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">//获取assembly的image，然后获取类型定义表，读取所有 C# 类</span></span><br><span class="line">		MonoImage* image = <span class="built_in">mono_assembly_get_image</span>(assembly);</span><br><span class="line">		<span class="type">const</span> MonoTableInfo* typeDefinitionsTable = <span class="built_in">mono_image_get_table_info</span>(image, MONO_TABLE_TYPEDEF);</span><br><span class="line">		<span class="type">int32_t</span> numTypes = <span class="built_in">mono_table_info_get_rows</span>(typeDefinitionsTable);</span><br><span class="line">        </span><br><span class="line">		<span class="comment">//遍历 C# 程序集中的所有类，并输出命名空间和类名。</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; numTypes; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">uint32_t</span> cols[MONO_TYPEDEF_SIZE];</span><br><span class="line">			<span class="built_in">mono_metadata_decode_row</span>(typeDefinitionsTable, i, cols, MONO_TYPEDEF_SIZE);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">char</span>* nameSpace = <span class="built_in">mono_metadata_string_heap</span>(image, cols[MONO_TYPEDEF_NAMESPACE]);</span><br><span class="line">			<span class="type">const</span> <span class="type">char</span>* name = <span class="built_in">mono_metadata_string_heap</span>(image, cols[MONO_TYPEDEF_NAME]);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">HE_CORE_TRACE</span>(<span class="string">&quot;&#123;&#125;.&#123;&#125;&quot;</span>, nameSpace, name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ScriptEngine::InitMono</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">mono_set_assemblies_path</span>(<span class="string">&quot;mono/lib&quot;</span>);	<span class="comment">//加载.dll组件</span></span><br><span class="line">		<span class="comment">//创建Mono运行时的顶级作用域。</span></span><br><span class="line">		MonoDomain* rootDomain = <span class="built_in">mono_jit_init</span>(<span class="string">&quot;HEngineITRuntime&quot;</span>);</span><br><span class="line">		<span class="built_in">HE_CORE_ASSERT</span>(rootDomain);</span><br><span class="line">		s_Data-&gt;RootDomain = rootDomain;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//创建AppDomain（应用域），用于运行 C# 代码</span></span><br><span class="line">		s_Data-&gt;AppDomain = <span class="built_in">mono_domain_create_appdomain</span>(<span class="string">&quot;HEngineScriptRuntime&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">		<span class="built_in">mono_domain_set</span>(s_Data-&gt;AppDomain, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//加载 C# DLL，这是写的 C# 代码</span></span><br><span class="line">		s_Data-&gt;CoreAssembly = <span class="built_in">LoadCSharpAssembly</span>(<span class="string">&quot;Resources/Scripts/HEngine-ScriptCore.dll&quot;</span>);</span><br><span class="line">        <span class="comment">//打印 DLL 内所有类的名称。</span></span><br><span class="line">		<span class="built_in">PrintAssemblyTypes</span>(s_Data-&gt;CoreAssembly);</span><br><span class="line"></span><br><span class="line">		MonoImage* assemblyImage = <span class="built_in">mono_assembly_get_image</span>(s_Data-&gt;CoreAssembly);</span><br><span class="line">		MonoClass* monoClass = <span class="built_in">mono_class_from_name</span>(assemblyImage, <span class="string">&quot;HEngine&quot;</span>, <span class="string">&quot;Main&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//找到C#类HEngine.Main并在C#运行时创建实例（调用默认构造函数）。</span></span><br><span class="line">		MonoObject* instance = <span class="built_in">mono_object_new</span>(s_Data-&gt;AppDomain, monoClass);</span><br><span class="line">		<span class="built_in">mono_runtime_object_init</span>(instance);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//找到 PrintMessage()方法并调用它。</span></span><br><span class="line">		MonoMethod* printMessageFunc = <span class="built_in">mono_class_get_method_from_name</span>(monoClass, <span class="string">&quot;PrintMessage&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">mono_runtime_invoke</span>(printMessageFunc, instance, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//找到PrintInt(int value)方法并传递参数5。</span></span><br><span class="line">		MonoMethod* printIntFunc = <span class="built_in">mono_class_get_method_from_name</span>(monoClass, <span class="string">&quot;PrintInt&quot;</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="type">int</span> value = <span class="number">5</span>;</span><br><span class="line">		<span class="type">void</span>* param = &amp;value;</span><br><span class="line">		<span class="built_in">mono_runtime_invoke</span>(printIntFunc, instance, &amp;param, <span class="literal">nullptr</span>);</span><br><span class="line">        </span><br><span class="line">		<span class="comment">//找到PrintInts(int a, int b)方法并传递两个参数5,508。</span></span><br><span class="line">		MonoMethod* printIntsFunc = <span class="built_in">mono_class_get_method_from_name</span>(monoClass, <span class="string">&quot;PrintInts&quot;</span>, <span class="number">2</span>);</span><br><span class="line">		<span class="type">int</span> value2 = <span class="number">508</span>;</span><br><span class="line">		<span class="type">void</span>* params[<span class="number">2</span>] =</span><br><span class="line">		&#123;</span><br><span class="line">			&amp;value,</span><br><span class="line">			&amp;value2</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="built_in">mono_runtime_invoke</span>(printIntsFunc, instance, params, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建C#字符串,调用PrintCustomMessage(string message)。</span></span><br><span class="line">		MonoString* monoString = <span class="built_in">mono_string_new</span>(s_Data-&gt;AppDomain, <span class="string">&quot;Hello World from C++!&quot;</span>);</span><br><span class="line">		MonoMethod* printCustomMessageFunc = <span class="built_in">mono_class_get_method_from_name</span>(monoClass, <span class="string">&quot;PrintCustomMessage&quot;</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="type">void</span>* stringParam = monoString;</span><br><span class="line">		<span class="built_in">mono_runtime_invoke</span>(printCustomMessageFunc, instance, &amp;stringParam, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// HZ_CORE_ASSERT(false);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">ScriptEngine::ShutdownMono</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		s_Data-&gt;AppDomain = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">		s_Data-&gt;RootDomain = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十三、在C-调用C-内部函数">八十三、在C#调用C++内部函数</h2>
<h4 id="前言-23">前言</h4>
<ul>
<li>
<p>此节目的</p>
<ul>
<li>
<p>上一节实现了<strong>cpp调用c#函数</strong></p>
<p>这一节要实现<strong>C#调用cpp内部函数</strong>，这样才可以算得上脚本</p>
</li>
</ul>
</li>
</ul>
<h4 id="C-调用Cpp函数例子">C#调用Cpp函数例子</h4>
<ol>
<li>无返回值、无参数</li>
</ol>
<ul>
<li>
<p>C#</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">HEngine</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Main</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> FloatVar &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Main</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Main constructor!&quot;</span>);</span><br><span class="line">            CppFunction();<span class="comment">// 调用cpp的函数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明为内部调用：声明这个函数的定义在cpp内部被实现</span></span><br><span class="line">        [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CppFunction</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>C++</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CppFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;来自cpp内部函数&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::InitMono</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 把C++的CppFunc绑定到c#的CppFunction</span></span><br><span class="line">    <span class="built_in">mono_add_internal_call</span>(<span class="string">&quot;HEngine.Main::CppFunction&quot;</span>, CppFunc);</span><br><span class="line">    <span class="comment">//&quot;.后面是类  ::后面是函数&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="2">
<li>带有参数</li>
</ol>
<ul>
<li>
<p>C#</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Main</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    NativeLog(<span class="string">&quot;Hello&quot;</span>, <span class="number">2025</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NativeLog</span>(<span class="params"><span class="built_in">string</span> text, <span class="built_in">int</span> parameter</span>)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>C++</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">NativeLog</span><span class="params">(MonoString* string, <span class="type">int</span> parameter)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="type">char</span>* cStr = <span class="built_in">mono_string_to_utf8</span>(string);</span><br><span class="line">    <span class="function">std::string <span class="title">str</span><span class="params">(cStr)</span></span>;</span><br><span class="line">    <span class="built_in">mono_free</span>(cStr);</span><br><span class="line">    std::cout &lt;&lt; str &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; parameter &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">mono_add_internal_call</span>(<span class="string">&quot;HEngine.Main::NativeLog&quot;</span>, NativeLog);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="3">
<li>带有结构体参数</li>
</ol>
<ul>
<li>
<p>C#</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Main</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector3 vec1 = <span class="keyword">new</span> Vector3(<span class="number">5</span>, <span class="number">2.5f</span>, <span class="number">1</span>);</span><br><span class="line">    NativeLogVec3(<span class="keyword">ref</span> vec1, <span class="keyword">out</span> Vector3 vec2);</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;vec2.X&#125;</span>, <span class="subst">&#123;vec2.Y&#125;</span>, <span class="subst">&#123;vec2.Z&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NativeLogVec3</span>(<span class="params"><span class="keyword">ref</span> Vector3 vec, <span class="keyword">out</span> Vector3 vec2</span>)</span>;</span><br><span class="line">[<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">NativeLogVec3</span><span class="params">(glm::vec3* vec, glm::vec3* out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; vec-&gt;x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; vec-&gt;y &lt;&lt;<span class="string">&quot;,&quot;</span>&lt;&lt;vec-&gt;z &lt;&lt; std::endl;</span><br><span class="line">    *out = glm::<span class="built_in">cross</span>(*vec, glm::<span class="built_in">vec3</span>(vec-&gt;x, vec-&gt;y, -vec-&gt;z)); </span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">mono_add_internal_call</span>(<span class="string">&quot;HEngine.Main::NativeLogVec3&quot;</span>, NativeLogVec3);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>注意Bug</p>
<p>由于结构体带有指针，需要<strong>申请内存</strong></p>
<ul>
<li>
<p>若在cpp函数内申请内存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> glm::vec3* <span class="title">NativeLogVec3</span><span class="params">(glm::vec3* vec)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt;<span class="string">&quot;TestNativeLogVec3&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    glm::vec3 result = glm::<span class="built_in">cross</span>(*vec, glm::<span class="built_in">vec3</span>(vec-&gt;x, vec-&gt;y, -vec-&gt;z));</span><br><span class="line">    <span class="comment">// 因为result是局部变量，函数结束后会被销毁result的内存，所以返回的内存是空的</span></span><br><span class="line">    <span class="keyword">return</span> &amp;result;</span><br><span class="line">    <span class="comment">// new出来的内存，是在cpp本地分配的，传给C#访问的地方也还是无效</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> glm::<span class="built_in">vec3</span>(result); <span class="comment">// 尝试new </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="封装抽象类">封装抽象类</h4>
<ul>
<li>
<p>ScriptEngine.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不引入头文件，必须外部声明，但这些都是在c文件定义的结构，所以需要extern&quot;C&quot;</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MonoClass</span> MonoClass;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MonoObject</span> MonoObject;</span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_MonoMethod</span> MonoMethod;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> HEngine &#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">ScriptEngine</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Init</span><span class="params">()</span></span>;		<span class="comment">// 初始化</span></span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;	<span class="comment">// 关闭</span></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">LoadAssembly</span><span class="params">(<span class="type">const</span> std::filesystem::path&amp; filepath)</span></span>;	<span class="comment">// 2.加载dll程序集</span></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitMono</span><span class="params">()</span></span>;		<span class="comment">// 1.初始化mono</span></span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ShutdownMono</span><span class="params">()</span></span>;	<span class="comment">// 关闭mono</span></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="type">static</span> MonoObject* <span class="title">InstantiateClass</span><span class="params">(MonoClass* monoClass)</span></span>;	<span class="comment">// 实例化Mono类为Mono实例对象</span></span><br><span class="line">		<span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">ScriptClass</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">ScriptClass</span> &#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">ScriptClass</span>() = <span class="keyword">default</span>;</span><br><span class="line">		<span class="built_in">ScriptClass</span>(<span class="type">const</span> std::string&amp; classNamespace, <span class="type">const</span> std::string&amp; className);<span class="comment">// 3. 创建一个MonoClass类</span></span><br><span class="line"></span><br><span class="line">		<span class="function">MonoObject* <span class="title">Instantiate</span><span class="params">()</span></span>;<span class="comment">// 4.创建一个由MonoClass类构成的mono对象并且初始化</span></span><br><span class="line">		<span class="function">MonoMethod* <span class="title">GetMethod</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">int</span> parameterCount)</span></span>;<span class="comment">// 5.1 获取类的函数</span></span><br><span class="line">		<span class="function">MonoObject* <span class="title">InvokeMethod</span><span class="params">(MonoObject* instance, MonoMethod* method, <span class="type">void</span>** params = <span class="literal">nullptr</span>)</span></span>;<span class="comment">// 5.2 调用类的函数</span></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		std::string m_ClassNamespace;</span><br><span class="line">		std::string m_ClassName;</span><br><span class="line">		MonoClass* m_MonoClass = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ScriptGlue</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="keyword">namespace</span> HEngine &#123;</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">ScriptGlue</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RegisterFunctions</span><span class="params">()</span></span>;<span class="comment">// 添加内部调用</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> HEngine</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HE_ADD_INTERNAL_CALL(Name) mono_add_internal_call(<span class="string">&quot;HEngine.InternalCalls::&quot;</span> #Name, Name)</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">NativeLog</span><span class="params">(MonoString* string, <span class="type">int</span> parameter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">char</span>* cStr = <span class="built_in">mono_string_to_utf8</span>(string);</span><br><span class="line">        <span class="function">std::string <span class="title">str</span><span class="params">(cStr)</span></span>;</span><br><span class="line">        <span class="built_in">mono_free</span>(cStr);</span><br><span class="line">        std::cout &lt;&lt; str &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; parameter &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">NativeLog_Vector</span><span class="params">(glm::vec3* parameter, glm::vec3* outResult)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">HE_CORE_WARN</span>(<span class="string">&quot;Value: &#123;0&#125;&quot;</span>, *parameter);</span><br><span class="line">        *outResult = glm::<span class="built_in">normalize</span>(*parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">float</span> <span class="title">NativeLog_VectorDot</span><span class="params">(glm::vec3* parameter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">HE_CORE_WARN</span>(<span class="string">&quot;Value: &#123;0&#125;&quot;</span>, *parameter);</span><br><span class="line">        <span class="keyword">return</span> glm::<span class="built_in">dot</span>(*parameter, *parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ScriptGlue::RegisterFunctions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">HE_ADD_INTERNAL_CALL</span>(NativeLog);</span><br><span class="line">        <span class="built_in">HE_ADD_INTERNAL_CALL</span>(NativeLog_Vector);</span><br><span class="line">        <span class="built_in">HE_ADD_INTERNAL_CALL</span>(NativeLog_VectorDot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十四、实现C-脚本控制实体">八十四、实现C#脚本控制实体</h2>
<h4 id="前言-24">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>为实现C#脚本WSAD能控制实体的位置变化</p>
</li>
</ul>
<h4 id="代码-18">代码</h4>
<ul>
<li>
<p>Entity.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">HEngine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Entity</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">Entity</span>()</span> &#123; ID = <span class="number">0</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="title">Entity</span>(<span class="params"><span class="built_in">ulong</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ID = id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">ulong</span> ID;</span><br><span class="line">        <span class="keyword">public</span> Vector3 Translation</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                InternalCalls.TransformComponent_GetTranslation(ID, <span class="keyword">out</span> Vector3 result);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                InternalCalls.TransformComponent_SetTranslation(ID, <span class="keyword">ref</span> <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">HasComponent</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : Component, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type componentType = <span class="keyword">typeof</span>(T);</span><br><span class="line">            <span class="keyword">return</span> InternalCalls.Entity_HasComponent(ID, componentType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">GetComponent</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : Component, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!HasComponent&lt;T&gt;())</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            T component = <span class="keyword">new</span> T() &#123; Entity = <span class="keyword">this</span> &#125;;</span><br><span class="line">            <span class="keyword">return</span> component;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Player.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Hazel;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Sandbox</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> : <span class="title">Entity</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Player</span>()</span>&#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Player()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnCreate</span>()</span>&#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Player.OnCreate() - <span class="subst">&#123;ID&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">OnUpdate</span>(<span class="params"><span class="built_in">float</span> ts</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//Console.WriteLine($&quot;Player.OnUpdate() - &#123;ts&#125;&quot;);</span></span><br><span class="line">            <span class="built_in">float</span> speed = <span class="number">1.0f</span>;</span><br><span class="line">            Vector3 velocity = Vector3.Zero;</span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">            <span class="comment">// 内部调用函数，事件是否触发//</span></span><br><span class="line">            <span class="keyword">if</span> (Input.IsKeyDown(KeyCode.W))&#123;</span><br><span class="line">                velocity.Y = <span class="number">1.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (Input.IsKeyDown(KeyCode.S))&#123;</span><br><span class="line">                velocity.Y = <span class="number">-1.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (Input.IsKeyDown(KeyCode.A))&#123;</span><br><span class="line">                velocity.X = <span class="number">-1.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (Input.IsKeyDown(KeyCode.D))&#123;</span><br><span class="line">                velocity.X = <span class="number">1.0f</span>;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;press the D key&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            velocity *= speed;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Translation get访问器 是调用C++的内部函数 获取 实体的位置</span></span><br><span class="line">            Vector3 translation = Translation; </span><br><span class="line">            translation += velocity * ts;</span><br><span class="line">            <span class="comment">// Translation set访问器 是调用C++的内部函数 设置 实体的位置</span></span><br><span class="line">            Translation = translation;          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>C#声明调用C++内部函数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">InternalCalls</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Entity_HasComponent</span>(<span class="params"><span class="built_in">ulong</span> entityID, Type componentType</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TransformComponent_GetTranslation</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">out</span> Vector3 translation</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TransformComponent_SetTranslation</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">ref</span> Vector3 translation</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulse</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">ref</span> Vector2 impulse, <span class="keyword">ref</span> Vector2 point, <span class="built_in">bool</span> wake</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulseToCenter</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">ref</span> Vector2 impulse, <span class="built_in">bool</span> wake</span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Input_IsKeyDown</span>(<span class="params">KeyCode keycode</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的C++的内部函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TransformComponent_GetTranslation</span><span class="params">(UUID entityID, glm::vec3* outTranslation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line"></span><br><span class="line">    *outTranslation = entity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;().Translation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TransformComponent_SetTranslation</span><span class="params">(UUID entityID, glm::vec3* translation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line"></span><br><span class="line">    entity.<span class="built_in">GetComponent</span>&lt;TransformComponent&gt;().Translation = *translation;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">Input_IsKeyDown</span><span class="params">(KeyCode keycode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Input::<span class="built_in">IsKeyPressed</span>(keycode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>C++调用C#的函数(C++项目的代码)</strong></p>
<ul>
<li>
<p>找到dll里所有继承Entity的类，表明这是<strong>脚本类</strong>，得到对应的封装的Mono类</p>
<p>并用<strong>脚本map</strong>存储所有<strong>封装的</strong>mono类（用封装的Mono类实例化）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::LoadAssemblyClasses</span><span class="params">(MonoAssembly* assembly)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s_Data-&gt;EntityClasses.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">    MonoImage* image = <span class="built_in">mono_assembly_get_image</span>(assembly);</span><br><span class="line">    <span class="type">const</span> MonoTableInfo* typeDefinitionsTable = <span class="built_in">mono_image_get_table_info</span>(image, MONO_TABLE_TYPEDEF);</span><br><span class="line">    <span class="type">int32_t</span> numTypes = <span class="built_in">mono_table_info_get_rows</span>(typeDefinitionsTable);</span><br><span class="line">    <span class="comment">// 1.加载Entity父类</span></span><br><span class="line">    MonoClass* entityClass = <span class="built_in">mono_class_from_name</span>(image, <span class="string">&quot;HEngine&quot;</span>, <span class="string">&quot;Entity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; numTypes; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint32_t</span> cols[MONO_TYPEDEF_SIZE];</span><br><span class="line">        <span class="built_in">mono_metadata_decode_row</span>(typeDefinitionsTable, i, cols, MONO_TYPEDEF_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* nameSpace = <span class="built_in">mono_metadata_string_heap</span>(image, cols[MONO_TYPEDEF_NAMESPACE]);</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* name = <span class="built_in">mono_metadata_string_heap</span>(image, cols[MONO_TYPEDEF_NAME]);</span><br><span class="line">        std::string fullName;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(nameSpace) != <span class="number">0</span>) &#123;</span><br><span class="line">            fullName = fmt::format(<span class="string">&quot;&#123;&#125;.&#123;&#125;&quot;</span>, nameSpace, name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            fullName = name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.加载Dll中所有C#类</span></span><br><span class="line">        MonoClass* monoClass = <span class="built_in">mono_class_from_name</span>(image, nameSpace, name);</span><br><span class="line">        <span class="keyword">if</span> (monoClass == entityClass) &#123;<span class="comment">// entity父类不保存</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.判断当前类是否为Entity的子类</span></span><br><span class="line">        <span class="type">bool</span> isEntity = <span class="built_in">mono_class_is_subclass_of</span>(monoClass, entityClass, <span class="literal">false</span>); <span class="comment">// 这个c#类是否为entity的子类</span></span><br><span class="line">        <span class="keyword">if</span> (isEntity) &#123;</span><br><span class="line">            <span class="comment">// 存入封装的Mono类对象</span></span><br><span class="line">            <span class="comment">// 3.1是就存入脚本map中</span></span><br><span class="line">            s_Data-&gt;EntityClasses[fullName] = <span class="built_in">CreateRef</span>&lt;ScriptClass&gt;(nameSpace, name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在运行场景开始前<strong>时</strong>，循环遍历当前所有<strong>具有脚本组件</strong>的实体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::OnRuntimeStart</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">OnPhysics2DStart</span>();</span><br><span class="line">    &#123;<span class="comment">// 脚本</span></span><br><span class="line">        ScriptEngine::<span class="built_in">OnRuntimeStart</span>(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">auto</span> view = m_Registry.<span class="built_in">view</span>&lt;ScriptComponent&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> e : view) &#123;</span><br><span class="line">            Entity entity = &#123; e, <span class="keyword">this</span> &#125;;</span><br><span class="line">            ScriptEngine::<span class="built_in">OnCreateEntity</span>(entity);<span class="comment">// 实例化实体拥有的C#脚本</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再调用C#类的OnCreate函数（初始化）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::OnCreateEntity</span><span class="params">(Entity entity)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; sc = entity.<span class="built_in">GetComponent</span>&lt;ScriptComponent&gt;();		<span class="comment">// 得到这个实体的组件</span></span><br><span class="line">    <span class="keyword">if</span> (ScriptEngine::<span class="built_in">EntityClassExists</span>(sc.ClassName)) &#123;			<span class="comment">// 组件的脚本名称是否正确</span></span><br><span class="line">        Ref&lt;ScriptInstance&gt; instance = <span class="built_in">CreateRef</span>&lt;ScriptInstance&gt;(s_Data-&gt;EntityClasses[sc.ClassName], entity);<span class="comment">// 实例化类对象，并存储OnCreate、OnUpdate函数，调用父类Entity的构造函数，传入实体的UUID</span></span><br><span class="line">        s_Data-&gt;EntityInstances[entity.<span class="built_in">GetUUID</span>()] = instance;	<span class="comment">// 运行脚本map存储这些ScriptInstance(类对象)</span></span><br><span class="line">        instance-&gt;<span class="built_in">InvokeOncreate</span>();								<span class="comment">// 调用C#的OnCreate函数</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>存储OnCreate、OnUpdate函数，并调用C#父类Entity的构造函数传入当前实体的<strong>UUID</strong>给C#</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ScriptInstance::<span class="built_in">ScriptInstance</span>(Ref&lt;ScriptClass&gt; scriptClass, Entity entity)</span><br><span class="line">:<span class="built_in">m_ScriptClass</span>(scriptClass)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取Sandbox Player类构成的MonoObject对象，相当于new Sandbox.Player()</span></span><br><span class="line">    m_Instance = scriptClass-&gt;<span class="built_in">Instantiate</span>();	</span><br><span class="line"></span><br><span class="line">    m_Constructor = s_Data-&gt;EntityClass.<span class="built_in">GetMethod</span>(<span class="string">&quot;.ctor&quot;</span>, <span class="number">1</span>);<span class="comment">// 获取C#Entity类的构造函数</span></span><br><span class="line">    m_OnCreateMethod = scriptClass-&gt;<span class="built_in">GetMethod</span>(<span class="string">&quot;OnCreate&quot;</span>, <span class="number">0</span>);<span class="comment">// 获取并存储Sandbox.Player类的函数</span></span><br><span class="line">    m_OnUpdateMethod = scriptClass-&gt;<span class="built_in">GetMethod</span>(<span class="string">&quot;OnUpdate&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 调用C#Entity类的构造函数</span></span><br><span class="line">    &#123;</span><br><span class="line">    UUID entityID = entity.<span class="built_in">GetUUID</span>();</span><br><span class="line">    <span class="type">void</span>* param = &amp;entityID;</span><br><span class="line">    m_ScriptClass-&gt;<span class="built_in">InvokeMethod</span>(m_Instance, m_Constructor, &amp;param);<span class="comment">// 第一个参数传入的是Entity子类(Player)构成的mono对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在运行场景的update函数，循环遍历当前所有<strong>具有脚本组件</strong>的实体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Scene::OnUpdateRuntime</span><span class="params">(Timestep ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 脚本</span></span><br><span class="line">    &#123;</span><br><span class="line">        ScriptEngine::<span class="built_in">OnRuntimeStart</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 实例化实体中的C#脚本</span></span><br><span class="line">        <span class="keyword">auto</span> view = m_Registry.<span class="built_in">view</span>&lt;ScriptComponent&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> e : view) &#123;</span><br><span class="line">            Entity entity = &#123; e, <span class="keyword">this</span> &#125;;</span><br><span class="line">            ScriptEngine::<span class="built_in">OnUpdateEntity</span>(entity, ts);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>根据UUID在<strong>运行脚本map</strong>找到这个<strong>封装的</strong>mono类对象，并调用C#类的OnUpdate函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::OnUpdateEntity</span><span class="params">(Entity entity, Timestep ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UUID entityUUID = entity.<span class="built_in">GetUUID</span>();							<span class="comment">// 得到这个实体的UUID</span></span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(s_Data-&gt;EntityInstances.<span class="built_in">find</span>(entityUUID) != s_Data-&gt;EntityInstances.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据UUID获取到ScriptInstance的指针</span></span><br><span class="line">    Ref&lt;ScriptInstance&gt; instance = s_Data-&gt;EntityInstances[entityUUID];</span><br><span class="line">    instance-&gt;<span class="built_in">InvokeOnUpdate</span>((<span class="type">float</span>)ts);							<span class="comment">// 调用C#的OnUpdate函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十五、C-获取实体的组件">八十五、C#获取实体的组件</h2>
<h4 id="前言-25">前言</h4>
<ul>
<li>此节目的
<ol>
<li>由上节根据UUID获取实体的translation在根据wsad调<strong>整实体的位置</strong></li>
<li>此节优化上节所做，实体的translation应属于实体的TransformComponent，所以此节需要在C#<strong>创建组件类</strong></li>
<li>用UUID，C#组件类<strong>对应</strong>cpp的组件类。</li>
</ol>
</li>
</ul>
<h4 id="代码-19">代码</h4>
<ul>
<li>
<p>Component.cs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> abstract <span class="keyword">class</span> <span class="title class_">Component</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Entity Entity &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformComponent</span> : Component &#123; </span><br><span class="line">    <span class="keyword">public</span> Vector3 Translation&#123;</span><br><span class="line">        get&#123;</span><br><span class="line">            InternalCalls.<span class="built_in">TransformComponent_GetTranslation</span>(Entity.ID, out Vector3 translation);</span><br><span class="line">            <span class="keyword">return</span> translation;</span><br><span class="line">        &#125;</span><br><span class="line">        set&#123;</span><br><span class="line">            InternalCalls.<span class="built_in">TransformComponent_SetTranslation</span>(Entity.ID, ref value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rigidbody2DComponent</span> : Component&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">ApplyLinearImpulse</span><span class="params">(Vector2 impulse, Vector2 worldPosition, <span class="type">bool</span> wake)</span></span>&#123;</span><br><span class="line">        InternalCalls.<span class="built_in">Rigidbody2DComponent_ApplyLinearImpulse</span>(Entity.ID, ref impulse, ref worldPosition, wake); ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">ApplyLinearImpulse</span><span class="params">(Vector2 impulse, <span class="type">bool</span> wake)</span></span>&#123;</span><br><span class="line">        InternalCalls.<span class="built_in">Rigidbody2DComponent_ApplyLinearImpulseToCenter</span>(Entity.ID, ref impulse, wake); ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ScriptGlue.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Component&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RegisterComponent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ([]()</span><br><span class="line">        &#123;</span><br><span class="line">            std::string_view typeName = <span class="built_in">typeid</span>(Component).<span class="built_in">name</span>();</span><br><span class="line">            <span class="type">size_t</span> pos = typeName.<span class="built_in">find_last_of</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">            std::string_view structName = typeName.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">            std::string managedTypename = fmt::format(<span class="string">&quot;HEngine.&#123;&#125;&quot;</span>, structName);</span><br><span class="line"></span><br><span class="line">            MonoType* managedType = <span class="built_in">mono_reflection_type_from_name</span>(managedTypename.<span class="built_in">data</span>(), ScriptEngine::<span class="built_in">GetCoreAssemblyImage</span>());</span><br><span class="line">            <span class="keyword">if</span> (!managedType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">HE_CORE_ERROR</span>(<span class="string">&quot;Could not find component type &#123;&#125;&quot;</span>, managedTypename);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            s_EntityHasComponentFuncs[managedType] = [](Entity entity) &#123; <span class="keyword">return</span> entity.<span class="built_in">HasComponent</span>&lt;Component&gt;(); &#125;;</span><br><span class="line">        &#125;(), ...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Component&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RegisterComponent</span><span class="params">(ComponentGroup&lt;Component...&gt;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">RegisterComponent</span>&lt;Component...&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptGlue::RegisterComponents</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">RegisterComponent</span>(AllComponents&#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Entity.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnCreate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Player.OnCreate() - <span class="subst">&#123;ID&#125;</span>&quot;</span>);</span><br><span class="line">    m_Transform = GetComponent&lt;TransformComponent&gt;();</span><br><span class="line">    m_Rigidbody = GetComponent&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">GetComponent</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : Component, <span class="keyword">new</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!HasComponent&lt;T&gt;())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    T component = <span class="keyword">new</span> T() &#123; Entity = <span class="keyword">this</span> &#125;;<span class="comment">// 返回本地类实例对象</span></span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">HasComponent</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : Component, <span class="keyword">new</span>()<span class="comment">// new()是确保有空构造函数&#123;</span></span></span><br><span class="line"><span class="function">    Type componentType</span> = <span class="keyword">typeof</span>(T);<span class="comment">// 得到命名空间.类名名称，比如Sandbox.Player</span></span><br><span class="line">    <span class="keyword">return</span> InternalCalls.Entity_HasComponent(ID, componentType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ScriptGlue.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">Entity_HasComponent</span><span class="params">(UUID entityID, MonoReflectionType* componentType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line"></span><br><span class="line">    MonoType* managedType = <span class="built_in">mono_reflection_type_get_type</span>(componentType);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(s_EntityHasComponentFuncs.<span class="built_in">find</span>(managedType) != s_EntityHasComponentFuncs.<span class="built_in">end</span>());</span><br><span class="line">    <span class="keyword">return</span> s_EntityHasComponentFuncs.<span class="built_in">at</span>(managedType)(entity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>若实体存在对应组件，就<strong>返回C#本地组件类的实例化</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">GetComponent</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : Component, <span class="keyword">new</span>()</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!HasComponent&lt;T&gt;())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    T component = <span class="keyword">new</span> T() &#123; Entity = <span class="keyword">this</span> &#125;;<span class="comment">// 返回本地类实例对象</span></span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>C#在相关脚本类的OnUpdate函数对*“获取到的组件”*的属性修改或者函数调用</p>
<p>实际上都是根据传入UUID，调用<strong>C++内部函数</strong>来实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C<span class="meta">#</span></span><br><span class="line">m_Rigidbody.ApplyLinearImpulse(velocity.XY, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulse</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">ref</span> Vector2 impulse, <span class="keyword">ref</span> Vector2 point, <span class="built_in">bool</span> wake</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">MethodImplAttribute(MethodImplOptions.InternalCall)</span>]</span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">extern</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulseToCenter</span>(<span class="params"><span class="built_in">ulong</span> entityID, <span class="keyword">ref</span> Vector2 impulse, <span class="built_in">bool</span> wake</span>)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cpp</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulse</span><span class="params">(UUID entityID, glm::vec2* impulse, glm::vec2* point, <span class="type">bool</span> wake)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; rb2d = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">    b2BodyId bodyid = rb2d.RuntimeBodyId;</span><br><span class="line">    <span class="built_in">b2Body_ApplyLinearImpulse</span>(bodyid, b2Vec2&#123; impulse-&gt;x, impulse-&gt;y &#125;, b2Vec2&#123; point-&gt;x, point-&gt;y &#125;, wake);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Rigidbody2DComponent_ApplyLinearImpulseToCenter</span><span class="params">(UUID entityID, glm::vec2* impulse, <span class="type">bool</span> wake)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; rb2d = entity.<span class="built_in">GetComponent</span>&lt;Rigidbody2DComponent&gt;();</span><br><span class="line">    b2BodyId bodyid = rb2d.RuntimeBodyId;</span><br><span class="line">    <span class="built_in">b2Body_ApplyLinearImpulseToCenter</span>(bodyid, b2Vec2&#123; impulse-&gt;x, impulse-&gt;y &#125;, wake);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十六、实现面板操控C-变量">八十六、实现面板操控C#变量</h2>
<h4 id="前言-26">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>为完成在编辑器面板上可以显示C#脚本类的属性，对属性的值修改，C#脚本会<strong>热更新</strong>（mono4.5api支持）</p>
</li>
</ul>
<h4 id="关键代码-3">关键代码</h4>
<p>mono的API</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有属性</span></span><br><span class="line"><span class="built_in">mono_class_get_fields</span>()</span><br><span class="line"><span class="comment">// 得到单个属性</span></span><br><span class="line">MonoClassField* field = <span class="built_in">mono_class_get_fields</span>(monoClass, &amp;iterator)</span><br><span class="line"><span class="comment">// 获取单个属性的名称</span></span><br><span class="line"><span class="built_in">mono_field_get_name</span>(field)</span><br><span class="line"><span class="comment">// 获取单个属性的权限</span></span><br><span class="line"><span class="built_in">mono_field_get_flags</span>(field)</span><br><span class="line"><span class="comment">// 获取单个属性的类类型</span></span><br><span class="line"><span class="built_in">mono_field_get_type</span>(field)    </span><br><span class="line"><span class="comment">// 设置和获取属性值</span></span><br><span class="line"><span class="built_in">mono_field_get_value</span>(m_Instance, field.ClassField, buffer);</span><br><span class="line"><span class="built_in">mono_field_set_value</span>(m_Instance, field.ClassField, (<span class="type">void</span>*)value);</span><br></pre></td></tr></table></figure>
<h4 id="代码思路">代码思路</h4>
<ul>
<li>
<p>一个C#脚本对应一个ScriptClass类，ScriptClass类中有**map（fieldmap）**保存这个C#脚本的属性与值类型。</p>
<ul>
<li>在加载dll后，读取游戏脚本库的类名，加载C#类得到<strong>封装的MonoClass对象</strong></li>
<li>再根据MonoClass（反射）得到C#类的所有<strong>属性</strong></li>
<li>循环属性，得到单个MonoClassField对象，根据MonoClassField（反射）得到C#属性的名称、访问权限、类型</li>
<li>根据权限决定<strong>map</strong>是否存储这个属性</li>
</ul>
<p>ScriptEngine</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">ScriptFieldType</span></span><br><span class="line">&#123;</span><br><span class="line">    None = <span class="number">0</span>,</span><br><span class="line">    Float, Double,</span><br><span class="line">    Bool, Char, Byte, Short, Int, Long,</span><br><span class="line">    UByte, UShort, UInt, ULong,</span><br><span class="line">    Vector2, Vector3, Vector4,</span><br><span class="line">    Entity</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 属性名称对应的结构体</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ScriptField</span> &#123;</span><br><span class="line">    ScriptFieldType Type;</span><br><span class="line">    std::string Name;</span><br><span class="line"></span><br><span class="line">    MonoClassField* ClassField;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ScriptClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">const</span> std::map&lt;std::string, ScriptField&gt;&amp; <span class="title">GetFields</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_Fields; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    std::map&lt;std::string, ScriptField&gt; m_Fields; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">ScriptEngine</span>;</span><br><span class="line">&#125;;</span><br><span class="line">------------------------------------------</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::LoadAssemblyClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; numTypes; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        .....</span><br><span class="line">        MonoClass* monoClass = <span class="built_in">mono_class_from_name</span>(s_Data-&gt;AppAssemblyImage, nameSpace, className);</span><br><span class="line">		.....</span><br><span class="line">        <span class="comment">// 读取脚本类的属性</span></span><br><span class="line">        <span class="type">int</span> fieldCount = <span class="built_in">mono_class_num_fields</span>(monoClass);		</span><br><span class="line">        <span class="built_in">HE_CORE_WARN</span>(<span class="string">&quot;&#123;&#125; has &#123;&#125; fields:&quot;</span>, className, fieldCount);</span><br><span class="line">        <span class="type">void</span>* iterator = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">// 获取所有属性，并得到单个属性</span></span><br><span class="line">        <span class="keyword">while</span> (MonoClassField* field = <span class="built_in">mono_class_get_fields</span>(monoClass, &amp;iterator))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* filedName = <span class="built_in">mono_field_get_name</span>(field);<span class="comment">// 获取单个属性的名称</span></span><br><span class="line">            <span class="type">uint32_t</span> flags = <span class="built_in">mono_field_get_flags</span>(field);		<span class="comment">// 获取单个属性的权限</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; FIELD_ATTRIBUTE_PUBLIC) &#123; 				<span class="comment">//类型是Public的话</span></span><br><span class="line">                MonoType* type = <span class="built_in">mono_field_get_type</span>(field);	<span class="comment">// 获取单个属性的类类型</span></span><br><span class="line">                ScriptFieldType fieldType = Utils::<span class="built_in">MonoTypeToScriptFieldType</span>(type);</span><br><span class="line">                <span class="built_in">HE_CORE_TRACE</span>(<span class="string">&quot;	&#123;&#125;(&#123;&#125;)&quot;</span>, filedName,Utils::<span class="built_in">ScriptFieldTypeToStirng</span>(fieldType));</span><br><span class="line">                <span class="comment">// 用Map存储这个属性</span></span><br><span class="line">                scriptClass-&gt;m_Fields[filedName] = &#123; fieldType, filedName, field &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>运行游戏时，在编辑面板可以用通过这<strong>fieldmap</strong>获取当前C#脚本的所有属性</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实体的脚本组件 mutable去除常量属性</span></span><br><span class="line"><span class="built_in">DrawComponent</span>&lt;ScriptComponent&gt;(<span class="string">&quot;Script&quot;</span>, entity, [entity](<span class="keyword">auto</span>&amp; component)<span class="keyword">mutable</span></span><br><span class="line">&#123;</span><br><span class="line">	Ref&lt;ScriptInstance&gt; scriptInstance = ScriptEngine::<span class="built_in">GetEntityScriptInstance</span>(entity.<span class="built_in">GetUUID</span>());</span><br><span class="line">	<span class="keyword">if</span> (scriptInstance) &#123;</span><br><span class="line">        <span class="comment">// 读取map中的属性</span></span><br><span class="line">		<span class="type">const</span> <span class="keyword">auto</span>&amp; fields = scriptInstance-&gt;<span class="built_in">GetScriptClass</span>()-&gt;<span class="built_in">GetFields</span>();</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [name, field] : fields)<span class="comment">// 获取保存的属性名称</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (field.Type == ScriptFieldType::Float) &#123;</span><br><span class="line">				<span class="type">float</span> data = scriptInstance-&gt;<span class="built_in">GetFieldValue</span>&lt;<span class="type">float</span>&gt;(name);<span class="comment">// 下一步有函数定义：获取属性值</span></span><br><span class="line">				<span class="keyword">if</span> (ImGui::<span class="built_in">DragFloat</span>(name.<span class="built_in">c_str</span>(), &amp;data)) &#123;</span><br><span class="line">						scriptInstance-&gt;<span class="built_in">SetFieldValue</span>(name, data);<span class="comment">// 下一步有函数定义：设置属性值</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>得到了对应属性的名称，在可以用Mono的API来<strong>获取</strong>和<strong>设置</strong>这个属性的值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">GetFieldValue</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> success = <span class="built_in">GetFieldValueInternal</span>(name, s_FieldValueBuffer);</span><br><span class="line">    <span class="keyword">if</span> (!success)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">T</span>();</span><br><span class="line">    <span class="keyword">return</span> *(T*)s_FieldValueBuffer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ScriptInstance::GetFieldValueInternal</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">void</span>* buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; fields = m_ScriptClass-&gt;<span class="built_in">GetFields</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = fields.<span class="built_in">find</span>(name);</span><br><span class="line">    <span class="keyword">if</span> (it == fields.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> ScriptField&amp; field = it-&gt;second;</span><br><span class="line">    <span class="comment">// mono的API</span></span><br><span class="line">    <span class="built_in">mono_field_get_value</span>(m_Instance, field.ClassField, buffer); </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetFieldValue</span><span class="params">(<span class="type">const</span> std::string&amp; name,  T&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SetFieldValueInternal</span>(name, &amp;value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ScriptInstance::SetFieldValueInternal</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">void</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; fields = m_ScriptClass-&gt;<span class="built_in">GetFields</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = fields.<span class="built_in">find</span>(name);</span><br><span class="line">    <span class="keyword">if</span> (it == fields.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> ScriptField&amp; field = it-&gt;second;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mono_field_set_value</span>(m_Instance, field.ClassField, (<span class="type">void</span>*)value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="八十七、添加C-脚本修改重载">八十七、添加C#脚本修改重载</h2>
<h4 id="前言-27">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>实现在运行时按Ctrl+R重新加载核心程序集和应用程序集达到更新脚本部分更改的效果</p>
</li>
</ul>
<p>ScriptEngine.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ScriptEngineData</span></span><br><span class="line">&#123;</span><br><span class="line">    std::filesystem::path CoreAssemblyFilepath;</span><br><span class="line">    std::filesystem::path AppAssemblyFilepath;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::ShutdownMono</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">mono_domain_set</span>(<span class="built_in">mono_get_root_domain</span>(), <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">mono_domain_unload</span>(s_Data-&gt;AppDomain);</span><br><span class="line">    s_Data-&gt;AppDomain = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">mono_jit_cleanup</span>(s_Data-&gt;RootDomain);</span><br><span class="line">    s_Data-&gt;RootDomain = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::LoadAssembly</span><span class="params">(<span class="type">const</span> std::filesystem::path&amp; filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个新的 AppDomain</span></span><br><span class="line">    s_Data-&gt;AppDomain = <span class="built_in">mono_domain_create_appdomain</span>(<span class="string">&quot;HEngineScriptRuntime&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">mono_domain_set</span>(s_Data-&gt;AppDomain, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录程序集路径</span></span><br><span class="line">    s_Data-&gt;CoreAssemblyFilepath = filepath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载程序集</span></span><br><span class="line">    s_Data-&gt;CoreAssembly = Utils::<span class="built_in">LoadMonoAssembly</span>(filepath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取程序集的 Image（用于后续的类、方法查找）</span></span><br><span class="line">    s_Data-&gt;CoreAssemblyImage = <span class="built_in">mono_assembly_get_image</span>(s_Data-&gt;CoreAssembly);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::ReloadAssembly</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 切换回 Mono 的 Root Domain（根域不能卸载）</span></span><br><span class="line">    <span class="built_in">mono_domain_set</span>(<span class="built_in">mono_get_root_domain</span>(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卸载当前 AppDomain</span></span><br><span class="line">    <span class="built_in">mono_domain_unload</span>(s_Data-&gt;AppDomain);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新加载核心程序集和应用程序集</span></span><br><span class="line">    <span class="built_in">LoadAssembly</span>(s_Data-&gt;CoreAssemblyFilepath);</span><br><span class="line">    <span class="built_in">LoadAppAssembly</span>(s_Data-&gt;AppAssemblyFilepath);</span><br><span class="line">    <span class="built_in">LoadAssemblyClasses</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 C# 组件到 C++ 侧</span></span><br><span class="line">    ScriptGlue::<span class="built_in">RegisterComponents</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新实例化 Entity 类</span></span><br><span class="line">    s_Data-&gt;EntityClass = <span class="built_in">ScriptClass</span>(<span class="string">&quot;HEngine&quot;</span>, <span class="string">&quot;Entity&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::LoadAppAssembly</span><span class="params">(<span class="type">const</span> std::filesystem::path&amp; filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 记录应用程序集的路径</span></span><br><span class="line">    s_Data-&gt;AppAssemblyFilepath = filepath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载应用程序集</span></span><br><span class="line">    s_Data-&gt;AppAssembly = Utils::<span class="built_in">LoadMonoAssembly</span>(filepath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取程序集的 Image（用于查找类、方法）</span></span><br><span class="line">    s_Data-&gt;AppAssemblyImage = <span class="built_in">mono_assembly_get_image</span>(s_Data-&gt;AppAssembly);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EditorLayer.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EditorLayer::OnImGuiRender</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ImGui::<span class="built_in">BeginMenu</span>(<span class="string">&quot;Script&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ImGui::<span class="built_in">MenuItem</span>(<span class="string">&quot;Reload assembly&quot;</span>, <span class="string">&quot;Ctrl+R&quot;</span>))</span><br><span class="line">            ScriptEngine::<span class="built_in">ReloadAssembly</span>();</span><br><span class="line"></span><br><span class="line">        ImGui::<span class="built_in">EndMenu</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> Key::R:</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (control)</span><br><span class="line">    &#123;</span><br><span class="line">        ScriptEngine::<span class="built_in">ReloadAssembly</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ImGuizmo::<span class="built_in">IsUsing</span>())</span><br><span class="line">            m_GizmoType = ImGuizmo::OPERATION::SCALE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="八十八、脚本修改自动热重载">八十八、脚本修改自动热重载</h2>
<h4 id="前言-28">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>实现自动检测文件的更改，一旦更改自动热重载C#dll</p>
</li>
</ul>
<p>ScriptEngine.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ScriptEngineData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//文件监听器，监视 C# DLL 文件的变更。</span></span><br><span class="line">    Scope&lt;filewatch::FileWatch&lt;std::string&gt;&gt; AppAssemblyFileWatcher;</span><br><span class="line">    <span class="comment">//是否等待热重载，防止重复触发。</span></span><br><span class="line">    <span class="type">bool</span> AssemblyReloadPending = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">OnAppAssemblyFileSystemEvent</span><span class="params">(<span class="type">const</span> std::string&amp; path, <span class="type">const</span> filewatch::Event change_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果已经等待热重载，或者变更类型不是 &quot;修改&quot;，就不处理</span></span><br><span class="line">    <span class="keyword">if</span> (!s_Data-&gt;AssemblyReloadPending &amp;&amp; change_type == filewatch::Event::modified)</span><br><span class="line">    &#123;</span><br><span class="line">        s_Data-&gt;AssemblyReloadPending = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把 ReloadAssembly() 提交到主线程执行</span></span><br><span class="line">        Application::<span class="built_in">Get</span>().<span class="built_in">SubmitToMainThread</span>([]()</span><br><span class="line">        &#123;</span><br><span class="line">            s_Data-&gt;AppAssemblyFileWatcher.<span class="built_in">reset</span>();  <span class="comment">// 停止文件监听</span></span><br><span class="line">            ScriptEngine::<span class="built_in">ReloadAssembly</span>();         <span class="comment">// 重新加载 C# 脚本 DLL</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ScriptEngine::LoadAppAssembly</span><span class="params">(<span class="type">const</span> std::filesystem::path&amp; filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 监听 C# 应用程序集的变化，触发 OnAppAssemblyFileSystemEvent</span></span><br><span class="line">    s_Data-&gt;AppAssemblyFileWatcher = CreateScope&lt;filewatch::FileWatch&lt;std::string&gt;&gt;(filepath.<span class="built_in">string</span>(), OnAppAssemblyFileSystemEvent);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置不等待重载</span></span><br><span class="line">    s_Data-&gt;AssemblyReloadPending = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Application.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Application::SubmitToMainThread</span><span class="params">(<span class="type">const</span> std::function&lt;<span class="type">void</span>()&gt;&amp; function)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::scoped_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_MainThreadQueueMutex)</span></span>; <span class="comment">// 加锁，防止多线程竞争</span></span><br><span class="line">    m_MainThreadQueue.<span class="built_in">emplace_back</span>(function); <span class="comment">// 将任务添加到队列</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Application::ExecuteMainThreadQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::scoped_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_MainThreadQueueMutex)</span></span>; <span class="comment">// 线程安全</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; func : m_MainThreadQueue) </span><br><span class="line">        <span class="built_in">func</span>(); <span class="comment">// 执行队列中的每个任务</span></span><br><span class="line">    m_MainThreadQueue.<span class="built_in">clear</span>(); <span class="comment">// 清空任务队列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="八十九、添加渲染Text功能">八十九、添加渲染Text功能</h2>
<h4 id="前言-29">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>添加Renderer2D_Text着色器，提供渲染文本功能</p>
<p>Renderer2D.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TextVertex</span></span><br><span class="line">&#123;</span><br><span class="line">    glm::vec3 Position;</span><br><span class="line">    glm::vec4 Color;</span><br><span class="line">    glm::vec2 TexCoord;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> bg color for outline/bg</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Editor-only</span></span><br><span class="line">    <span class="type">int</span> EntityID;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Renderer2DData</span></span><br><span class="line">&#123;</span><br><span class="line">    Ref&lt;VertexArray&gt; TextVertexArray;</span><br><span class="line">    Ref&lt;VertexBuffer&gt; TextVertexBuffer;</span><br><span class="line">    Ref&lt;Shader&gt; TextShader;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> TextIndexCount = <span class="number">0</span>;</span><br><span class="line">    TextVertex* TextVertexBufferBase = <span class="literal">nullptr</span>;</span><br><span class="line">    TextVertex* TextVertexBufferPtr = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    Ref&lt;Texture2D&gt; FontAtlasTexture;</span><br><span class="line">    glm::vec4 QuadVertexPositions[<span class="number">4</span>]&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">            <span class="comment">// Text</span></span><br><span class="line">    s_Data.TextVertexArray = VertexArray::<span class="built_in">Create</span>();</span><br><span class="line"></span><br><span class="line">    s_Data.TextVertexBuffer = VertexBuffer::<span class="built_in">Create</span>(s_Data.MaxVertices * <span class="built_in">sizeof</span>(TextVertex));</span><br><span class="line">    s_Data.TextVertexBuffer-&gt;<span class="built_in">SetLayout</span>(&#123;</span><br><span class="line">        &#123; ShaderDataType::Float3,	<span class="string">&quot;a_Position&quot;</span>     &#125;,</span><br><span class="line">        &#123; ShaderDataType::Float4,	<span class="string">&quot;a_Color&quot;</span>        &#125;,</span><br><span class="line">        &#123; ShaderDataType::Float2,	<span class="string">&quot;a_TexCoord&quot;</span>     &#125;,</span><br><span class="line">        &#123; ShaderDataType::Int,			<span class="string">&quot;a_EntityID&quot;</span>     &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    s_Data.TextVertexArray-&gt;<span class="built_in">AddVertexBuffer</span>(s_Data.TextVertexBuffer);</span><br><span class="line">    s_Data.TextVertexArray-&gt;<span class="built_in">SetIndexBuffer</span>(quadIB);</span><br><span class="line">    s_Data.TextVertexBufferBase = <span class="keyword">new</span> TextVertex[s_Data.MaxVertices];</span><br><span class="line"></span><br><span class="line">            s_Data.TextShader = Shader::<span class="built_in">Create</span>(<span class="string">&quot;assets/shaders/Renderer2D_Text.glsl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::Flush</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s_Data.TextIndexCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint32_t</span> dataSize = (<span class="type">uint32_t</span>)((<span class="type">uint8_t</span>*)s_Data.TextVertexBufferPtr - (<span class="type">uint8_t</span>*)s_Data.TextVertexBufferBase);</span><br><span class="line">        s_Data.TextVertexBuffer-&gt;<span class="built_in">SetData</span>(s_Data.TextVertexBufferBase, dataSize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> buf = s_Data.TextVertexBufferBase;</span><br><span class="line">        s_Data.FontAtlasTexture-&gt;<span class="built_in">Bind</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        s_Data.TextShader-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">        RenderCommand::<span class="built_in">DrawIndexed</span>(s_Data.TextVertexArray, s_Data.TextIndexCount);</span><br><span class="line">        s_Data.Stats.DrawCalls++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Renderer2D::DrawString</span><span class="params">(<span class="type">const</span> std::string&amp; string, Ref&lt;Font&gt; font, <span class="type">const</span> glm::mat4&amp; transform, <span class="type">const</span> glm::vec4&amp; color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; fontGeometry = font-&gt;<span class="built_in">GetMSDFData</span>()-&gt;FontGeometry;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; metrics = fontGeometry.<span class="built_in">getMetrics</span>();</span><br><span class="line">    Ref&lt;Texture2D&gt; fontAtlas = font-&gt;<span class="built_in">GetAtlasTexture</span>();</span><br><span class="line"></span><br><span class="line">    s_Data.FontAtlasTexture = fontAtlas;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> x = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">double</span> fsScale = <span class="number">1.0</span> / (metrics.ascenderY - metrics.descenderY);</span><br><span class="line">    <span class="type">double</span> y = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">float</span> lineHeightOffset = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; string.<span class="built_in">size</span>(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> character = string[i];</span><br><span class="line">        <span class="keyword">if</span> (character == <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (character == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            x = <span class="number">0</span>;</span><br><span class="line">            y -= fsScale * metrics.lineHeight + lineHeightOffset;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> glyph = fontGeometry.<span class="built_in">getGlyph</span>(character);</span><br><span class="line">        <span class="keyword">if</span> (!glyph)</span><br><span class="line">            glyph = fontGeometry.<span class="built_in">getGlyph</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!glyph)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (character == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">            glyph = fontGeometry.<span class="built_in">getGlyph</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> al, ab, ar, at;</span><br><span class="line">        glyph-&gt;<span class="built_in">getQuadAtlasBounds</span>(al, ab, ar, at);</span><br><span class="line">        <span class="function">glm::vec2 <span class="title">texCoordMin</span><span class="params">((<span class="type">float</span>)al, (<span class="type">float</span>)ab)</span></span>;</span><br><span class="line">        <span class="function">glm::vec2 <span class="title">texCoordMax</span><span class="params">((<span class="type">float</span>)ar, (<span class="type">float</span>)at)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> pl, pb, pr, pt;</span><br><span class="line">        glyph-&gt;<span class="built_in">getQuadPlaneBounds</span>(pl, pb, pr, pt);</span><br><span class="line">        <span class="function">glm::vec2 <span class="title">quadMin</span><span class="params">((<span class="type">float</span>)pl, (<span class="type">float</span>)pb)</span></span>;</span><br><span class="line">        <span class="function">glm::vec2 <span class="title">quadMax</span><span class="params">((<span class="type">float</span>)pr, (<span class="type">float</span>)pt)</span></span>;</span><br><span class="line"></span><br><span class="line">        quadMin *= fsScale, quadMax *= fsScale;</span><br><span class="line">        quadMin += glm::<span class="built_in">vec2</span>(x, y);</span><br><span class="line">        quadMax += glm::<span class="built_in">vec2</span>(x, y);</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> texelWidth = <span class="number">1.0f</span> / fontAtlas-&gt;<span class="built_in">GetWidth</span>();</span><br><span class="line">        <span class="type">float</span> texelHeight = <span class="number">1.0f</span> / fontAtlas-&gt;<span class="built_in">GetHeight</span>();</span><br><span class="line">        texCoordMin *= glm::<span class="built_in">vec2</span>(texelWidth, texelHeight);</span><br><span class="line">        texCoordMax *= glm::<span class="built_in">vec2</span>(texelWidth, texelHeight);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// render here</span></span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Position = transform * glm::<span class="built_in">vec4</span>(quadMin, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Color = color;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;TexCoord = texCoordMin;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;EntityID = <span class="number">0</span>; <span class="comment">// TODO</span></span><br><span class="line">        s_Data.TextVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Position = transform * glm::<span class="built_in">vec4</span>(quadMin.x, quadMax.y, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Color = color;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;TexCoord = &#123; texCoordMin.x, texCoordMax.y &#125;;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;EntityID = <span class="number">0</span>; <span class="comment">// TODO</span></span><br><span class="line">        s_Data.TextVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Position = transform * glm::<span class="built_in">vec4</span>(quadMax, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Color = color;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;TexCoord = texCoordMax;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;EntityID = <span class="number">0</span>; <span class="comment">// TODO</span></span><br><span class="line">        s_Data.TextVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Position = transform * glm::<span class="built_in">vec4</span>(quadMax.x, quadMin.y, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;Color = color;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;TexCoord = &#123; texCoordMax.x, texCoordMin.y &#125;;</span><br><span class="line">        s_Data.TextVertexBufferPtr-&gt;EntityID = <span class="number">0</span>; <span class="comment">// TODO</span></span><br><span class="line">        s_Data.TextVertexBufferPtr++;</span><br><span class="line"></span><br><span class="line">        s_Data.TextIndexCount += <span class="number">6</span>;</span><br><span class="line">        s_Data.Stats.QuadCount++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &lt; string.<span class="built_in">size</span>() - <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">double</span> advance = glyph-&gt;<span class="built_in">getAdvance</span>();</span><br><span class="line">            <span class="type">char</span> nextCharacter = string[i + <span class="number">1</span>];</span><br><span class="line">            fontGeometry.<span class="built_in">getAdvance</span>(advance, character, nextCharacter);</span><br><span class="line"></span><br><span class="line">            <span class="type">float</span> kerningOffset = <span class="number">0.0f</span>;</span><br><span class="line">            x += fsScale * advance + kerningOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Components.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TextComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    std::string TextString;</span><br><span class="line">    Ref&lt;Font&gt; FontAsset = Font::<span class="built_in">GetDefault</span>();</span><br><span class="line">    glm::vec4 Color&#123; <span class="number">1.0f</span> &#125;;</span><br><span class="line">    <span class="type">float</span> Kerning = <span class="number">0.0f</span>;			</span><br><span class="line">    <span class="type">float</span> LineSpacing = <span class="number">0.0f</span>;		</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Scene.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Renderer2D::<span class="built_in">DrawString</span>(<span class="string">&quot;DongHui&quot;</span>, Font::<span class="built_in">GetDefault</span>(), glm::<span class="built_in">mat4</span>(<span class="number">1.0f</span>), glm::<span class="built_in">vec4</span>(<span class="number">1.0f</span>));</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="九十、-脚本绑定Text相关">九十、 脚本绑定Text相关</h2>
<h4 id="前言-30">前言</h4>
<ul>
<li>
<p>此节目的</p>
<p>绑定Text组件相关函数到C#,以供脚本实现文本功能</p>
<p>ScriptEngine.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MonoString* <span class="title">ScriptEngine::CreateString</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mono_string_new</span>(s_Data-&gt;AppDomain, string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ScriptGlue.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Utils</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">MonoStringToString</span><span class="params">(MonoString* string)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">char</span>* cStr = <span class="built_in">mono_string_to_utf8</span>(string);</span><br><span class="line">        <span class="function">std::string <span class="title">str</span><span class="params">(cStr)</span></span>;</span><br><span class="line">        <span class="built_in">mono_free</span>(cStr);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> MonoString* <span class="title">TextComponent_GetText</span><span class="params">(UUID entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    <span class="keyword">return</span> ScriptEngine::<span class="built_in">CreateString</span>(tc.TextString.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TextComponent_SetText</span><span class="params">(UUID entityID, MonoString* textString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    tc.TextString = Utils::<span class="built_in">MonoStringToString</span>(textString);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TextComponent_GetColor</span><span class="params">(UUID entityID, glm::vec4* color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    *color = tc.Color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TextComponent_SetColor</span><span class="params">(UUID entityID, glm::vec4* color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    tc.Color = *color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">float</span> <span class="title">TextComponent_GetKerning</span><span class="params">(UUID entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    <span class="keyword">return</span> tc.Kerning;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TextComponent_SetKerning</span><span class="params">(UUID entityID, <span class="type">float</span> kerning)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    tc.Kerning = kerning;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">float</span> <span class="title">TextComponent_GetLineSpacing</span><span class="params">(UUID entityID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    <span class="keyword">return</span> tc.LineSpacing;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TextComponent_SetLineSpacing</span><span class="params">(UUID entityID, <span class="type">float</span> lineSpacing)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Scene* scene = ScriptEngine::<span class="built_in">GetSceneContext</span>();</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(scene);</span><br><span class="line">    Entity entity = scene-&gt;<span class="built_in">GetEntityByUUID</span>(entityID);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity);</span><br><span class="line">    <span class="built_in">HE_CORE_ASSERT</span>(entity.<span class="built_in">HasComponent</span>&lt;TextComponent&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>&amp; tc = entity.<span class="built_in">GetComponent</span>&lt;TextComponent&gt;();</span><br><span class="line">    tc.LineSpacing = lineSpacing;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Components.cs</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextComponent</span> : Component</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> string Text</span><br><span class="line">    &#123;</span><br><span class="line">        get =&gt; InternalCalls.<span class="built_in">TextComponent_GetText</span>(Entity.ID);</span><br><span class="line">        set =&gt; InternalCalls.<span class="built_in">TextComponent_SetText</span>(Entity.ID, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector4 Color</span><br><span class="line">    &#123;</span><br><span class="line">        get</span><br><span class="line">        &#123;</span><br><span class="line">            InternalCalls.<span class="built_in">TextComponent_GetColor</span>(Entity.ID, out Vector4 color);</span><br><span class="line">            <span class="keyword">return</span> color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set</span><br><span class="line">        &#123;</span><br><span class="line">            InternalCalls.<span class="built_in">TextComponent_SetColor</span>(Entity.ID, ref value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> Kerning</span><br><span class="line">    &#123;</span><br><span class="line">        get =&gt; InternalCalls.<span class="built_in">TextComponent_GetKerning</span>(Entity.ID);</span><br><span class="line">        set =&gt; InternalCalls.<span class="built_in">TextComponent_SetKerning</span>(Entity.ID, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> LineSpacing</span><br><span class="line">    &#123;</span><br><span class="line">        get =&gt; InternalCalls.<span class="built_in">TextComponent_GetLineSpacing</span>(Entity.ID);</span><br><span class="line">        set =&gt; InternalCalls.<span class="built_in">TextComponent_SetLineSpacing</span>(Entity.ID, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>HEngine游戏引擎-61-90</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://donghuiw.github.io/posts/75ada542">https://donghuiw.github.io/posts/75ada542</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>DongHuiWang</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2025-03-17</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-07-23</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>游戏引擎</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://gitee.com/winterdev/images/raw/master/wx.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/wx.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://gitee.com/winterdev/images/raw/master/zfb.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/zfb.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/b6d9ed88"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover5.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">实体组件系统(ECS)</div></div></a></div><div class="next-post pull-right"><a href="/posts/94bccdc7"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Unity项目展示</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/a1665e0e" title="Premake5使用及问题汇总"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover3.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-13</div><div class="title">Premake5使用及问题汇总</div></div></a></div><div><a href="/posts/e0684db9" title="游戏引擎开发补充知识点"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-18</div><div class="title">游戏引擎开发补充知识点</div></div></a></div><div><a href="/posts/b6d9ed88" title="实体组件系统(ECS)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover5.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-14</div><div class="title">实体组件系统(ECS)</div></div></a></div><div><a href="/posts/3ad536fd" title="HEngine游戏引擎-31-60"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover6.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-17</div><div class="title">HEngine游戏引擎-31-60</div></div></a></div><div><a href="/posts/81e1b394" title="HEngine游戏引擎(01-30)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-03-13</div><div class="title">HEngine游戏引擎(01-30)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%B8%80%E3%80%81%E6%89%93%E5%BC%80-%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6%E5%AF%B9%E8%AF%9D%E6%A1%86"><span class="toc-text">六十一、打开&#x2F;保存文件对话框</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="toc-text">关键代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%BA%8C%E3%80%81%E6%B7%BB%E5%8A%A0gizmos"><span class="toc-text">六十二、添加gizmos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-2"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-2"><span class="toc-text">关键代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%B8%89%E3%80%81%E7%BC%96%E8%BE%91%E6%97%B6%E7%9A%84%E6%91%84%E5%83%8F%E6%9C%BA"><span class="toc-text">六十三、编辑时的摄像机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-3"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E6%97%B6%E6%91%84%E5%83%8F%E6%9C%BA%E5%A4%A7%E8%87%B4%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">编辑时摄像机大致运行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E6%97%B6%E6%91%84%E5%83%8F%E6%9C%BA-%E7%A7%BB%E5%8A%A8%E4%B8%8E%E7%BC%A9%E6%94%BE-%E5%AE%9E%E7%8E%B0"><span class="toc-text">编辑时摄像机 移动与缩放 实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E5%9B%9B%E3%80%81%E9%87%8D%E6%9E%84%E5%B8%A7%E7%BC%93%E5%86%B2%E7%B1%BB"><span class="toc-text">六十四、重构帧缓冲类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-4"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86%E5%AE%9E%E4%BD%93ID%E5%80%BC%E9%99%84%E5%8A%A0%E5%88%B0%E5%83%8F%E7%B4%A0%E4%B8%8A"><span class="toc-text">如何将实体ID值附加到像素上</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%E4%BA%8C%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">解决思路二的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A7%E7%BC%93%E5%86%B2%E7%B1%BB%E4%BF%AE%E6%94%B9"><span class="toc-text">帧缓冲类修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%B8%B2%E6%9F%93%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81"><span class="toc-text">显示第二个渲染目标代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%BA%94%E3%80%81%E9%BC%A0%E6%A0%87%E6%8B%BE%E5%8F%96%E5%B8%A7%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-text">六十五、鼠标拾取帧缓存数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-5"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E5%85%AD%E3%80%81%E7%94%A8%E5%9B%BA%E5%AE%9A%E5%80%BC%E5%A1%AB%E5%85%85%E5%B8%A7%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-text">六十六、用固定值填充帧缓冲区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-6"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%B8%83%E3%80%81%E8%8E%B7%E5%8F%96%E9%BC%A0%E6%A0%87%E6%89%80%E5%9C%A8%E7%9A%84%E5%AE%9E%E4%BD%93%E7%9A%84ID"><span class="toc-text">六十七、获取鼠标所在的实体的ID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-7"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81"><span class="toc-text">修改代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E5%85%AB%E3%80%81%E7%82%B9%E5%87%BB%E9%80%89%E6%8B%A9%E5%AE%9E%E4%BD%93"><span class="toc-text">六十八、点击选择实体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-8"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E5%8D%81%E4%B9%9D%E3%80%81Vulkan%E5%92%8C%E6%96%B0Shader%E7%B3%BB%E7%BB%9F"><span class="toc-text">六十九、Vulkan和新Shader系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-9"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8DSPIR-V"><span class="toc-text">介绍SPIR-V</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-4"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E3%80%81-%E6%98%BE%E7%A4%BA%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%A4%B9UI"><span class="toc-text">七十、 显示资源文件夹UI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-10"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-5"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%B8%80%E3%80%81%E5%86%85%E5%AE%B9%E9%9D%A2%E6%9D%BF%E5%92%8CImGui%E6%8B%96%E6%94%BE"><span class="toc-text">七十一、内容面板和ImGui拖放</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-11"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-6"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%BA%8C%E3%80%81%E6%8B%96%E6%8B%BD%E6%B7%BB%E5%8A%A0%E7%BA%B9%E7%90%86"><span class="toc-text">七十二、拖拽添加纹理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-12"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-7"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%B8%89%E3%80%81%E6%96%B0%E5%A2%9EPlay-Stop%E6%8C%89%E9%92%AE"><span class="toc-text">七十三、新增Play&#x2F;Stop按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-13"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-8"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E5%9B%9B%E3%80%812D%E7%89%A9%E7%90%86%E5%BC%95%E6%93%8E%EF%BC%81"><span class="toc-text">七十四、2D物理引擎！</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-14"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-9"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%BA%94%E3%80%81UUID%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86"><span class="toc-text">七十五、UUID唯一标识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-15"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-10"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E5%85%AD%E3%80%81%E5%BC%80%E5%A7%8B%E3%80%81%E7%BB%93%E6%9D%9F%E3%80%81%E5%A4%8D%E5%88%B6%E5%9C%BA%E6%99%AF"><span class="toc-text">七十六、开始、结束、复制场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-16"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-11"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%B8%83%E3%80%81%E6%88%90%E5%8A%9F%E7%BB%98%E5%88%B62D%E5%9C%86"><span class="toc-text">七十七、成功绘制2D圆</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-17"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-12"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E5%85%AB%E3%80%81%E6%B7%BB%E5%8A%A0%E7%BA%BF%E6%AE%B5%E5%92%8C%E7%9F%A9%E5%BD%A2%E6%B8%B2%E6%9F%93"><span class="toc-text">七十八、添加线段和矩形渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-18"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-13"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E5%8D%81%E4%B9%9D%E3%80%81%E6%B7%BB%E5%8A%A0%E5%9C%86%E5%BD%A2%E7%BB%84%E4%BB%B6%E5%92%8C%E7%89%A9%E7%90%86"><span class="toc-text">七十九、添加圆形组件和物理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-19"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-14"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E3%80%81-%E5%8F%AF%E8%A7%86%E5%8C%96%E7%89%A9%E7%90%86%E5%8C%85%E5%9B%B4%E7%9B%92"><span class="toc-text">八十、 可视化物理包围盒</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-20"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-15"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%B8%80%E3%80%81%E6%B7%BB%E5%8A%A0%E6%A8%A1%E6%8B%9F%E8%BF%90%E8%A1%8C%E6%8C%89%E9%92%AE"><span class="toc-text">八十一、添加模拟运行按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-21"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-16"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%BA%8C%E3%80%81Mono%E5%AE%9E%E7%8E%B0C-%E8%84%9A%E6%9C%AC"><span class="toc-text">八十二、Mono实现C#脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-22"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mono%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-text">Mono配置步骤：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-17"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%B8%89%E3%80%81%E5%9C%A8C-%E8%B0%83%E7%94%A8C-%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0"><span class="toc-text">八十三、在C#调用C++内部函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-23"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%B0%83%E7%94%A8Cpp%E5%87%BD%E6%95%B0%E4%BE%8B%E5%AD%90"><span class="toc-text">C#调用Cpp函数例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E6%8A%BD%E8%B1%A1%E7%B1%BB"><span class="toc-text">封装抽象类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E5%9B%9B%E3%80%81%E5%AE%9E%E7%8E%B0C-%E8%84%9A%E6%9C%AC%E6%8E%A7%E5%88%B6%E5%AE%9E%E4%BD%93"><span class="toc-text">八十四、实现C#脚本控制实体</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-24"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-18"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%BA%94%E3%80%81C-%E8%8E%B7%E5%8F%96%E5%AE%9E%E4%BD%93%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-text">八十五、C#获取实体的组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-25"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-19"><span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E5%85%AD%E3%80%81%E5%AE%9E%E7%8E%B0%E9%9D%A2%E6%9D%BF%E6%93%8D%E6%8E%A7C-%E5%8F%98%E9%87%8F"><span class="toc-text">八十六、实现面板操控C#变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-26"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81-3"><span class="toc-text">关键代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%80%9D%E8%B7%AF"><span class="toc-text">代码思路</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%B8%83%E3%80%81%E6%B7%BB%E5%8A%A0C-%E8%84%9A%E6%9C%AC%E4%BF%AE%E6%94%B9%E9%87%8D%E8%BD%BD"><span class="toc-text">八十七、添加C#脚本修改重载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-27"><span class="toc-text">前言</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E5%85%AB%E3%80%81%E8%84%9A%E6%9C%AC%E4%BF%AE%E6%94%B9%E8%87%AA%E5%8A%A8%E7%83%AD%E9%87%8D%E8%BD%BD"><span class="toc-text">八十八、脚本修改自动热重载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-28"><span class="toc-text">前言</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E5%8D%81%E4%B9%9D%E3%80%81%E6%B7%BB%E5%8A%A0%E6%B8%B2%E6%9F%93Text%E5%8A%9F%E8%83%BD"><span class="toc-text">八十九、添加渲染Text功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-29"><span class="toc-text">前言</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E5%8D%81%E3%80%81-%E8%84%9A%E6%9C%AC%E7%BB%91%E5%AE%9AText%E7%9B%B8%E5%85%B3"><span class="toc-text">九十、 脚本绑定Text相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-30"><span class="toc-text">前言</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>放下个人素质 享受缺德人生 <br/>拒绝精神内耗 有事直接发疯^_^✨</div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">魔改指南</a><a href="/box/nav/">网址导航</a></li><li><a href="/social/link/">我的朋友</a><a href="/comments/">留点什么</a></li><li><a href="/personal/about/">关于作者</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/">文章统计</a><a href="/">我的唠叨</a></li><li><a href="/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"><a target="_blank" rel="noopener" href="https://fyfan.cn/" title="我的友友付少"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/fufan1025/blog_image_other/raw/master/avatar.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="广告位招租"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2024-2025</b></span><span><b>&nbsp;&nbsp;By DongHuiWang</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.bitiful.net/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.bitiful.net/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="本站数据分析得益于51la技术支持"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.bitiful.net/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="本站使用网盾星球提供CDN加速与防护"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.bitiful.net/badge/CDN-TianliCDN.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本网站源码由Github提供存储仓库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.bitiful.net/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.winterdev.cn',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.winterdev.cn',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.winterdev.cn',
        region: '',
        pageSize: 5,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><meta name="referrer" content="no-referrer" /><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://donghuiw.github.io/categories/项目展示/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍬 我的项目展示与介绍 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://donghuiw.github.io/categories/游戏引擎/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 游戏引擎学习笔记 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://donghuiw.github.io/categories/演示/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍥 博客搭建笔记 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://donghuiw.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/48514759.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover6.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-22</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/48514759.html&quot;);" href="javascript:void(0);" alt="">游戏引擎HEngine项目展示</a><div class="blog-slider__text">自研游戏引擎HEngine相关介绍</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/48514759.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/94bccdc7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/94bccdc7.html&quot;);" href="javascript:void(0);" alt="">Unity项目展示</a><div class="blog-slider__text">我的Unity项目展示</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/94bccdc7.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/81e1b394.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/81e1b394.html&quot;);" href="javascript:void(0);" alt="">HEngine游戏引擎(01-30)</a><div class="blog-slider__text">记录HEngine每一次提交的重点内容以及遇到的问题和解决的步骤</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/81e1b394.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/3ad536fd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover6.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/3ad536fd.html&quot;);" href="javascript:void(0);" alt="">HEngine游戏引擎-31-60</a><div class="blog-slider__text">记录HEngine每一次提交的重点内容以及遇到的问题和解决的步骤</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/3ad536fd.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b6d9ed88.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover5.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-13</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b6d9ed88.html&quot;);" href="javascript:void(0);" alt="">实体组件系统(ECS)</a><div class="blog-slider__text">介绍实体组件系统(ECS)的好处以及为什么要实体组件系统</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b6d9ed88.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/75ada542.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover3.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-17</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/75ada542.html&quot;);" href="javascript:void(0);" alt="">HEngine游戏引擎-61-90</a><div class="blog-slider__text">记录HEngine每一次提交的重点内容以及遇到的问题和解决的步骤</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/75ada542.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/e0684db9.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/e0684db9.html&quot;);" href="javascript:void(0);" alt="">游戏引擎开发补充知识点</a><div class="blog-slider__text">记录制作游戏引擎遇到的新知识点，包括c++知识和模式设计思路等</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/e0684db9.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/a1665e0e.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover3.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-10-03</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/a1665e0e.html&quot;);" href="javascript:void(0);" alt="">Premake5使用及问题汇总</a><div class="blog-slider__text">记录一些Premake5写法和使用中遇到的问题</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/a1665e0e.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover7.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-06-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdown语法与外挂标签写法汇总</a><div class="blog-slider__text">🥧本文汇总Markdown格式以及外挂标签在网页端的渲染效果，可作为文档进行查询</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/39541a22.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gitee.com/winterdev/images/raw/master/blog_cover4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-02-27</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/39541a22.html&quot;);" href="javascript:void(0);" alt="">Hexo博客搭建教程</a><div class="blog-slider__text">暂无描述</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/39541a22.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>